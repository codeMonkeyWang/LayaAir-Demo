!function(e,t,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=i.__newvec,o=laya.ani.AnimationPlayer,h=(laya.ani.AnimationState,laya.webgl.atlas.AtlasResourceManager,laya.webgl.utils.Buffer),l=(laya.webgl.utils.Buffer2D,laya.utils.Byte),u=laya.utils.ClassUtils,c=i.Config,_=laya.particle.emitter.EmitterBase,d=(laya.events.Event,laya.events.EventDispatcher),f=laya.utils.Handler,m=laya.webgl.utils.IndexBuffer2D,p=laya.ani.KeyframesAniTemplet,v=laya.net.Loader,g=laya.display.Node,x=(laya.particle.ParticleSettings,laya.particle.shader.ParticleShader),T=laya.particle.ParticleTemplateWebGL,C=(laya.maths.Rectangle,laya.renders.Render),I=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),D=laya.resource.Resource,M=laya.utils.RunDriver,E=laya.webgl.shader.Shader,V=laya.webgl.shader.ShaderDefines,y=laya.display.Sprite,A=laya.utils.Stat,w=laya.resource.Texture,b=laya.net.URL,P=laya.webgl.utils.ValusArray,R=laya.webgl.utils.VertexBuffer2D,S=laya.webgl.WebGL,O=laya.webgl.WebGLContext,L=(laya.webgl.canvas.WebGLContext2D,laya.webgl.resource.WebGLImage,laya.webgl.resource.WebGLImageCube),N=laya.webgl.resource.WebGLRenderTarget;i["interface"]("laya.d3.core.render.IUpdate"),i["interface"]("laya.d3.graphics.IVertex"),i["interface"]("laya.d3.core.render.IRenderable");var F=(function(){function e(){}return r(e,"laya.d3.core.FrustumCulling"),e.culling=function(e,t){},e}(),function(){function e(){this._boundingSphere=null,this._component=null,this._mesh=null,this._layerMask=0,this._ownerEnable=!1}return r(e,"laya.d3.core.FrustumCullingObject"),e}()),U=(function(){function e(){this.texturePath=null,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this.maxSegments=200,this.color=new Ve(1,1,1,1)}return r(e,"laya.d3.core.glitter.GlitterSettings"),e}(),function(){function e(){this._tempVector30=new Ee,this._tempVector31=new Ee,this._tempVector32=new Ee,this._a=new Ee,this._b=new Ee,this._c=new Ee,this._d=new Ee}r(e,"laya.d3.core.glitter.SplineCurvePositionVelocity");var t=e.prototype;return t.Init=function(e,t,i,n){e.cloneTo(this._d),t.cloneTo(this._c),Ee.scale(e,2,this._a),Ee.scale(i,2,this._tempVector30),Ee.subtract(this._a,this._tempVector30,this._a),Ee.add(this._a,t,this._a),Ee.add(this._a,n,this._a),Ee.scale(i,3,this._b),Ee.scale(e,3,this._tempVector30),Ee.subtract(this._b,this._tempVector30,this._b),Ee.subtract(this._b,n,this._b),Ee.scale(t,2,this._tempVector30),Ee.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){Ee.scale(this._a,e*e*e,this._tempVector30),Ee.scale(this._b,e*e,this._tempVector31),Ee.scale(this._c,e,this._tempVector32),Ee.add(this._tempVector30,this._tempVector31,t),Ee.add(t,this._tempVector32,t),Ee.add(t,this._d,t)},e}()),B=function(){function e(e,t,i){this._datas=null,this._w=0,this._h=0,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._maxHeight=i}r(e,"laya.d3.core.HeightMap");var t=e.prototype;return t._inBounds=function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w},t.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},a(0,t,"width",function(){return this._w}),a(0,t,"height",function(){return this._h}),a(0,t,"maxHeight",function(){return this._maxHeight}),e.creatFromMesh=function(t,i,n,r){for(var a=[],s=[],o=t.getSubMeshCount(),h=0;o>h;h++){for(var l=t.getSubMesh(h),u=l.getVertexBuffer(),c=u.getData(),_=[],d=0;d<c.length;d+=u.vertexDeclaration.vertexStride/4){var f=new Ee(c[d+0],c[d+1],c[d+2]);_.push(f)}a.push(_);var m=l.getIndexBuffer();s.push(m.getData())}var p=t._boundingBox,v=p.min.x,g=p.min.z,x=p.max.x,T=p.max.z,C=p.max.y,I=x-v,D=T-g,M=r.elements[0]=I/(i-1),E=r.elements[1]=D/(n-1),V=new e(i,n,C),y=e._tempRay,A=y.direction.elements;A[0]=0,A[1]=-1,A[2]=0;var w=.1,b=C+w;y.origin.elements[1]=b;for(var P=0;i>P;P++){var R=g+P*E;V._datas[P]=[];for(var S=0;n>S;S++){var O=v+S*M,L=y.origin.elements;L[0]=O,L[2]=R;var N=e._getPosition(y,a,s);V._datas[P][S]=N===Number.MAX_VALUE?NaN:b-N}}return V},e._getPosition=function(e,t,i){for(var n=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],s=i[r],o=0;o<s.length;o+=3){var h=a[s[o+0]],l=a[s[o+1]],u=a[s[o+2]],c=Pe.rayIntersectsTriangle(e,h,l,u);!isNaN(c)&&n>c&&(n=c)}return n},n(e,["_tempRay",function(){return this._tempRay=new De(new Ee,new Ee)}]),e}(),G=function(){function e(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this.name=null,this._id=e._uniqueIDCounter,e._uniqueIDCounter++,this._id>32)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！")}r(e,"laya.d3.core.Layer");var t=e.prototype;return a(0,t,"number",function(){return this._number}),a(0,t,"mask",function(){return this._mask}),a(0,t,"active",function(){return this._active},function(t){29!==this._number&&30!=this._number&&(this._active=t,t?e._activeLayers=e._activeLayers|this.mask:e._activeLayers=e._activeLayers&~this.mask)}),a(0,t,"visible",function(){return this._visible},function(t){29!==this._number&&30!=this._number&&(this._visible=t,t?e._visibleLayers=e._visibleLayers|this.mask:e._visibleLayers=e._visibleLayers&~this.mask)}),a(1,e,"activeLayers",function(){return e._activeLayers},function(t){e._activeLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var i=0;i<e._layerList.length;i++){var n=e._layerList[i];n._active=0!==(n._mask&e._activeLayers)}}),a(1,e,"visibleLayers",function(){return e._visibleLayers},function(t){e._visibleLayers=t|e.getLayerByNumber(29).mask|e.getLayerByNumber(30).mask;for(var i=0;i<e._layerList.length;i++){var n=e._layerList[i];n._visible=0!==(n._mask&e._visibleLayers)}}),e.__init__=function(){e._layerList.length=31;for(var t=0;31>t;t++){var i=new e;e._layerList[t]=i,0===t?i.name="Default Layer":29===t?i.name="Reserved Layer0":30===t?i.name="Reserved Layer1":i.name="Layer-"+t,i._number=t,i._mask=Math.pow(2,t)}e._activeLayers=2147483647,e._visibleLayers=2147483647,e._currentCameraCullingMask=2147483647,e.currentCreationLayer=e._layerList[0]},e.getLayerByNumber=function(t){if(0>t||t>30)throw new Error("无法返回指定Layer，该number超出范围！");return e._layerList[t]},e.getLayerByMask=function(t){for(var i=0;31>i;i++)if(e._layerList[i].mask===t)return e._layerList[i];throw new Error("无法返回指定Layer,该mask不存在")},e.getLayerByName=function(t){for(var i=0;31>i;i++)if(e._layerList[i].name===t)return e._layerList[i];throw new Error("无法返回指定Layer,该name不存在")},e.isActive=function(t){return 0!=(t&e._activeLayers)},e.isVisible=function(t){return 0!=(t&e._currentCameraCullingMask&e._visibleLayers)},e._uniqueIDCounter=1,e._layerCount=31,e._layerList=[],e._activeLayers=0,e._visibleLayers=0,e._currentCameraCullingMask=0,e.currentCreationLayer=null,e}(),H=(function(){function e(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._renderState=null,this._sharderNameID=0,this._shader=null,this._posShaderValue=[3,5126,!1,28,0],this._colorShaderValue=[4,5126,!1,28,12],this._albedo=new Ve(1,1,1,1),this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._wvpMatrix=new Te,this._vb=new R(-1,35048),this._ib=new m,this._sharderNameID=E.nameKey.get("SIMPLE")}r(e,"laya.d3.core.PhasorSpriter3D");var t=e.prototype;return t.line=function(e,t,i,n,r,a,s,o,h,l,u,c,_,d){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,t,i,n,r,a,s),this.addVertex(o,h,l,u,c,_,d),this.addIndexes(this._tempUint0,this._tempUint0+1),this},t.circle=function(e,t,i,n,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,i,n,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},t.plane=function(e,t,i,n,r,a,s,o,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,i,a,s,o,h),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,i,a,s,o,h),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,i,a,s,o,h),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,i,a,s,o,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},t.box=function(e,t,i,n,r,a,s,o,h,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,i-this._tempNumver2,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},t.cone=function(e,t,i,n,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*i+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*i>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/i,this.addVertexIndex(0,t,0,n,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,n,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<i;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,n,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==i-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,n,r,a,s,this._tempUint0+(this._tempInt0+i)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==i-1?this.addIndexes(this._tempUint1+i+2):this.addIndexes(this._tempUint1+this._tempInt0+i+1),this.addIndexes(this._tempUint1+this._tempInt0+i),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},t.boudningBoxLine=function(e,t,i,n,r,a,s,o,h,l){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,s,o,h,l),this.addVertex(n,r,a,s,o,h,l),this.addVertex(e,t,a,s,o,h,l),this.addVertex(n,t,a,s,o,h,l),this.addVertex(n,r,i,s,o,h,l),this.addVertex(e,r,i,s,o,h,l),this.addVertex(n,t,i,s,o,h,l),this.addVertex(e,t,i,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},t.addVertex=function(e,t,i,n,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=i,this._vbData[this._posInVBData+3]=n,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},t.addVertexIndex=function(e,t,i,n,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=e,this._vbData[o+1]=t,this._vbData[o+2]=i,this._vbData[o+3]=n,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},t.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var i=0;i<t.length;i++)this._ibData[this._posInIBData]=t[i],this._posInIBData++;return this},t.begin=function(e,t,i){return this._hasBegun&&this.beginException0(),1!==e&&4!==e&&this.beginException1(),this._primitiveType=e,this._wvpMatrix=t,this._renderState=i,this._hasBegun=!0,this},t.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},t.flush=function(){if(0!==this._posInVBData){this._ib.clear(),this._ib.append(this._ibData),this._vb.clear(),this._vb.append(this._vbData),this._vb.bind_upload(this._ib);var e=this._renderState.shaderValue.length,t=this._renderState.shaderDefs.getValue();this._shader=this.getShader(this._renderState),this._renderState.shaderValue.pushValue("POSITION",this._posShaderValue,-1),this._renderState.shaderValue.pushValue("COLOR",this._colorShaderValue,-1),this._renderState.shaderValue.pushValue("MVPMATRIX",this._wvpMatrix.elements,-1),this._renderState.shaderValue.pushValue("ALBEDO",this._albedo.elements,-1),this._shader.uploadArray(this._renderState.shaderValue.data,this._renderState.shaderValue.length,null),this._renderState.shaderDefs.setValue(t),this._renderState.shaderValue.length=e,A.drawCall++,S.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0}},t.getShader=function(e){var t=e.shaderDefs._value;e.shaderDefs._value=-449&t,e.shaderDefs.add(32);var i=e.shaderDefs.getValue()|e.shadingMode+2e-4*this._sharderNameID,n=this._shader?this._shader:E.getShader(i);return n||(n=E.withCompile(this._sharderNameID,e.shadingMode,e.shaderDefs.toNameDic(),i,null))},t.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},t.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},t.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},t.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},t.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},t.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},e}(),function(){function e(){}r(e,"laya.d3.core.render.RenderClip");var t=e.prototype;return t.view=function(e){return!0},e}()),j=function(){function e(){this.depthTest=!0,this.depthMask=1,this.blend=!1,this.cullFace=!0,this.sFactor=1,this.dFactor=0,this.frontFace=2304}return r(e,"laya.d3.core.render.RenderConfig"),e}(),k=function(){function e(){this.renderQneue=null,this.type=0,this.owner=null,this.renderElement=null,this.material=null,this.tag=null,this.mainSortID=0,this.triangleCount=0}return r(e,"laya.d3.core.render.RenderObject"),e}(),z=function(){function e(t){this._id=0,this._changed=!1,this._needSort=!1,this._renderObjects=null,this._staticRenderObjects=null,this._staticLength=0,this._mergeRenderObjects=null,this._merageLength=0,this._renderConfig=null,this._staticBatchManager=null,this._id=++e._uniqueIDCounter,this._changed=!1,this._needSort=!1,this._renderConfig=t,this._renderObjects=[],this._staticRenderObjects=[],this._staticLength=0,this._mergeRenderObjects=[],this._merageLength=0,this._staticBatchManager=new q}r(e,"laya.d3.core.render.RenderQueue");var t=e.prototype;return t._getStaticRenderObj=function(){var e=this._staticRenderObjects[this._staticLength++];return e||(this._staticRenderObjects[this._staticLength-1]=new k)},t._reset=function(){this._staticLength=0,this._merageLength=0,this._staticBatchManager._reset()},t._preRenderUpdateComponents=function(e,t){for(var i=0;i<e.componentsCount;i++){var n=e.getComponentByIndex(i);!n.started&&(n._start(t),n.started=!0),n.isActive&&n._preRenderUpdate(t)}},t._postRenderUpdateComponents=function(e,t){for(var i=0;i<e.componentsCount;i++){var n=e.getComponentByIndex(i);!n.started&&(n._start(t),n.started=!0),n.isActive&&n._postRenderUpdate(t)}},t._setState=function(e){O.setDepthTest(e,this._renderConfig.depthTest),O.setDepthMask(e,this._renderConfig.depthMask),O.setBlend(e,this._renderConfig.blend),O.setBlendFunc(e,this._renderConfig.sFactor,this._renderConfig.dFactor),O.setCullFace(e,this._renderConfig.cullFace),O.setFrontFaceCCW(e,this._renderConfig.frontFace)},t._preRender=function(t){if(this._changed){this._changed=!1,this._reset(),this._needSort&&this._renderObjects.sort(e._sort);for(var i,n,r,a,s,o,h,l,u=!1,c=!1,_=0,d=!1,f=0,m=this._renderObjects.length;m>f;f++)a=this._renderObjects[f],s=a.renderElement,d=a.owner.isStatic,l=s.getVertexBuffer(0),i===a.material&&n===l.vertexDeclaration&&u&&d&&1===s.VertexBufferCount&&a.owner.visible?c?r.addRenderObj(a)||(this._mergeRenderObjects[this._merageLength++]=this._renderObjects[_],c=!1):(r=this._staticBatchManager.getStaticBatchQneue(n,i),o=this._renderObjects[f-1],r.addRenderObj(o)&&r.addRenderObj(a)?(h=this._getStaticRenderObj(),h.renderElement=r,h.type=1,this._mergeRenderObjects[this._merageLength-1]=h,c=!0):(this._mergeRenderObjects[this._merageLength++]=this._renderObjects[_],c=!1)):(this._mergeRenderObjects[this._merageLength++]=this._renderObjects[_],c=!1),_++,u=d,i=a.material,n=l.vertexDeclaration;this._staticBatchManager._garbageCollection(),this._staticBatchManager._finsh()}},t._render=function(e){for(var t,i=e.shaderValue.length,n=0,r=this._merageLength;r>n;n++){t=this._mergeRenderObjects[n];var a=0;if(0===t.type){var s=t.owner;e.owner=s,e.renderObj=t,a=e.shaderDefs.getValue(),this._preRenderUpdateComponents(s,e),s.visible&&t.renderElement._render(e),this._postRenderUpdateComponents(s,e),e.shaderDefs.setValue(a)}else 1===t.type&&(e.owner=null,e.renderObj=t,a=e.shaderDefs.getValue(),t.renderElement._render(e),e.shaderDefs.setValue(a));e.shaderValue.length=i}},t.getRenderObj=function(){this._changed=!0,this._needSort=!0;var e=new k;return this._renderObjects.push(e),e.renderQneue=this,e},t.deleteRenderObj=function(e){this._changed=!0;var t=this._renderObjects.indexOf(e);-1!==t&&(this._renderObjects.splice(t,1),e.renderQneue=null)},a(0,t,"id",function(){return this._id}),e._sort=function(e,t){var i=e.mainSortID-t.mainSortID;return e.owner.isStatic&&t.owner.isStatic&&0===i?e.triangleCount-t.triangleCount:i},e._uniqueIDCounter=0,e.NONEWRITEDEPTH=0,e.OPAQUE=1,e.OPAQUE_DOUBLEFACE=2,e.ALPHA_BLEND=3,e.ALPHA_BLEND_DOUBLEFACE=4,e.ALPHA_ADDTIVE_BLEND=5,e.ALPHA_ADDTIVE_BLEND_DOUBLEFACE=6,e.DEPTHREAD_ALPHA_BLEND=7,e.DEPTHREAD_ALPHA_BLEND_DOUBLEFACE=8,e.DEPTHREAD_ALPHA_ADDTIVE_BLEND=9,e.DEPTHREAD_ALPHA_ADDTIVE_BLEND_DOUBLEFACE=10,e}(),W=function(){function e(){this._shadingMode=0,this.elapsedTime=NaN,this.loopCount=0,this.context=null,this.scene=null,this.owner=null,this.renderObj=null,this.camera=null,this.viewMatrix=null,this.projectionMatrix=null,this.projectionViewMatrix=null,this.cameraBoundingFrustum=null,this.viewport=null,this.worldShaderValue=new P,this.shaderValue=new P,this.shaderDefs=new Be,this.renderClip=new H,this.reset()}r(e,"laya.d3.core.render.RenderState");var t=e.prototype;return t.reset=function(){this.worldShaderValue.length=0,this.shaderValue.length=0,this.shaderDefs.setValue(0),S.frameShaderHighPrecision&&this.shaderDefs.setValue(1048576)},a(0,t,"shadingMode",function(){return this._shadingMode},function(e){this.shaderDefs.remove(4==e?8:4),this.shaderDefs.add(e),this._shadingMode=e}),e.VERTEXSHADERING=4,e.PIXELSHADERING=8,e.clientWidth=0,e.clientHeight=0,e}(),X=function(){function e(e,t){this._currentVertexCount=0,this._currentIndexCount=0,this._elementCount=0,this._vertexDeclaration=null,this._material=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._lastRenderObjects=null,this._renderObjects=null,this._renderOwners=null,this._needReMerage=!1,this._elementCount=0,this._vertexDeclaration=e,this._material=t,this._lastRenderObjects=[],this._renderObjects=[],this._renderOwners=[],this._needReMerage=!1}r(e,"laya.d3.graphics.StaticBatch");var t=e.prototype;return i.imps(t,{"laya.d3.core.render.IRenderable":!0}),t.getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t.getIndexBuffer=function(){return this._indexBuffer},t.getBakedVertexs=function(e,t){return null},t.getBakedIndices=function(){return null},t._reset=function(){this._renderObjects.length=0,this._renderOwners.length=0,this._currentIndexCount=0,this._currentVertexCount=0},t._finsh=function(){if(this._needReMerage||this._lastRenderObjects.length==this._renderObjects.length||(this._needReMerage=!0),this._needReMerage){this._needReMerage=!1;var e=0,t=0;this._elementCount=0,this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentVertexCount),this._indexDatas=new Uint16Array(this._currentIndexCount),this._vertexBuffer?(this._vertexBuffer.dispose(),this._indexBuffer.dispose(),this._vertexBuffer=Ye.create(this._vertexDeclaration,this._currentVertexCount,35048),this._indexBuffer=Ze.create("ushort",this._currentIndexCount,35048)):(this._vertexBuffer=Ye.create(this._vertexDeclaration,this._currentVertexCount,35048),this._indexBuffer=Ze.create("ushort",this._currentIndexCount,35048));for(var i=0;i<this._renderObjects.length;i++){var n=this._renderObjects[i],r=n.getBakedVertexs(0,this._renderOwners[i].transform.worldMatrix),a=n.getBakedIndices(),s=e/(this._vertexDeclaration.vertexStride/4),o=t,h=o+a.length;this._indexDatas.set(a,t);for(var l=o;h>l;l++)this._indexDatas[l]=s+this._indexDatas[l];t+=a.length,this._vertexDatas.set(r,e),e+=r.length,this._elementCount+=a.length}this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas)}this._lastRenderObjects=this._renderObjects.slice()},t._getShader=function(e,t,i){if(!i)return null;var n=0,r=t.vertexDeclaration.shaderAttribute;r.UV&&(n|=i.shaderDef),r.COLOR&&(n|=32),e.scene.enableFog&&(n|=131072),n>0&&e.shaderDefs.addInt(n);var a=i.getShader(e);return a},t.addRenderObj=function(t){var i=t.renderElement,n=i.getIndexBuffer(),r=this._currentIndexCount+n.byteLength/n.indexTypeByteCount,a=this._currentVertexCount+i.getVertexBuffer().byteLength/this._vertexDeclaration.vertexStride;return a>e.maxVertexCount||r>e.maxIndexCount?!1:(this._renderObjects.push(i),this._renderOwners.push(t.owner),this._needReMerage||-1!==this._lastRenderObjects.indexOf(i)||(this._needReMerage=!0),this._currentIndexCount=r,this._currentVertexCount=a,!0)},t._render=function(e){var t=this._vertexBuffer,i=this._indexBuffer,n=this._material;if(n.normalTexture&&!t.vertexDeclaration.shaderAttribute.TANGENT0){var r=t.getData(),a=Se.generateTangent(r,t.vertexDeclaration.vertexStride/4,t.vertexDeclaration.shaderAttribute.POSITION[4]/4,t.vertexDeclaration.shaderAttribute.UV[4]/4,i.getData()),s=Se.getVertexTangentDeclaration(t.vertexDeclaration.getVertexElements()),o=Ye.create(s,35044);o.setData(a),t.dispose(),this._vertexBuffer=t=o}if(t._bind(),i._bind(),n){var h=this._getShader(e,t,n),l=e.shaderValue.length;if(e.shaderValue.pushArray(t.vertexDeclaration.shaderValues),e.shaderValue.pushValue("MATRIX1",Te.DEFAULT.elements,-1),e.shaderValue.pushValue("MVPMATRIX",e.projectionViewMatrix.elements,-1),!n.upload(e,null,h))return e.shaderValue.length=l,!1;e.shaderValue.length=l}return e.context.drawElements(4,this._elementCount,5123,0),A.drawCall++,A.trianglesFaces+=this._elementCount/3,!0},a(0,t,"VertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return 0}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,t,"currentVertexCount",function(){return this._currentVertexCount}),a(0,t,"currentIndexCount",function(){return this._currentIndexCount}),e.maxVertexCount=65535,e.maxIndexCount=12e4,e}(),q=function(){function e(){this._keys=null,this._useFPS=null,this._staticBatchs=null,this._keys=[],this._useFPS=[],this._staticBatchs=[]}r(e,"laya.d3.graphics.StaticBatchManager");var t=e.prototype;return t.getStaticBatchQneue=function(e,t){var i,n=1e3*t.id+e.id;if(-1===this._keys.indexOf(n))this._keys.push(n),this._useFPS.push(A.loopCount),i=new X(e,t),this._staticBatchs.push(i);else{var r=this._keys.indexOf(n);this._useFPS[r]=A.loopCount,i=this._staticBatchs[r]}return i},t._garbageCollection=function(){for(var e=0;e<this._keys.length;e++)this._useFPS[e]<A.loopCount&&(this._keys.splice(e,1),this._useFPS.splice(e,1),this._staticBatchs.splice(e,1),e--)},t._reset=function(){for(var e=0;e<this._keys.length;e++)this._staticBatchs[e]._reset()},t._finsh=function(){for(var e=0;e<this._keys.length;e++)this._staticBatchs[e]._finsh()},t.dispose=function(){this._keys.length=0,this._useFPS.length=0,this._staticBatchs.length=0},e.maxVertexDeclaration=1e3,n(e,["maxMaterialCount",function(){return this.maxMaterialCount=Math.floor(2147483.647)}]),e}(),Q=function(){function e(t,i){if(this._id=0,this._shaderValues=null,this._shaderAttribute=null,this._vertexStride=0,this._vertexElements=null,this._id=++e._uniqueIDCounter,this._id>e.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",e.maxVertexDeclaration);this._shaderAttribute={},this._shaderValues=new P,this._vertexStride=t,this._vertexElements=i;for(var n=0;n<i.length;n++){var r=i[n],a=r.elementUsage,s=[e._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];this._shaderValues.pushValue(a,s,-1),this._shaderAttribute[a]=s}}r(e,"laya.d3.graphics.VertexDeclaration");var t=e.prototype;return t.getVertexElements=function(){return this._vertexElements.slice()},t.unBinding=function(){},a(0,t,"id",function(){return this._id}),a(0,t,"shaderAttribute",function(){return this._shaderAttribute}),a(0,t,"shaderValues",function(){return this._shaderValues}),a(0,t,"vertexStride",function(){return this._vertexStride}),e._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"volor":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},e.getVertexStride=function(t){for(var i=0,n=0;n<t.Length;n++){var r=t[n],a=r.offset+e._getTypeSize(r.elementFormat);a>i&&(i=a)}return i},e._maxVertexDeclarationBit=1e3,e._uniqueIDCounter=1,n(e,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),e}(),Z=function(){function e(e,t,i){this.offset=0,this.elementFormat=null,this.elementUsage=null,this.offset=e,this.elementFormat=t,this.elementUsage=i}return r(e,"laya.d3.graphics.VertexElement"),e}(),Y=(function(){function e(){}return r(e,"laya.d3.graphics.VertexElementFormat"),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="volor",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e}(),function(){function e(){}return r(e,"laya.d3.graphics.VertexElementUsage"),e.POSITION0="POSITION",e.COLOR0="COLOR",e.TEXTURECOORDINATE0="UV",e.NORMAL0="NORMAL",e.BINORMAL0="BINORMAL",e.TANGENT0="TANGENT0",e.BLENDINDICES0="BLENDINDICES",e.BLENDWEIGHT0="BLENDWEIGHT",e.DEPTH0="DEPTH",e.FOG0="FOG",e.POINTSIZE0="POINTSIZE",e.SAMPLE0="SAMPLE",e.TESSELLATEFACTOR0="TESSELLATEFACTOR",e.COLOR1="COLOR1",e.NEXTTEXTURECOORDINATE0="NEXTUV",e.TEXTURECOORDINATE1="UV1",e.NEXTTEXTURECOORDINATE1="NEXTUV1",e.CORNERTEXTURECOORDINATE0="CORNERTEXTURECOORDINATE",e.VELOCITY0="VELOCITY",e.STARTCOLOR0="STARTCOLOR",e.ENDCOLOR0="ENDCOLOR",e.SIZEROTATION0="SIZEROTATION",e.RADIUS0="RADIUS",e.RADIAN0="RADIAN",e.AGEADDSCALE0="AGEADDSCALE",e.TIME0="TIME",e}(),function(){function e(e,t,i){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=i}r(e,"laya.d3.graphics.VertexGlitter");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(24,[new Z(0,"vector3","POSITION"),new Z(12,"vector2","UV"),new Z(20,"single","TIME")])}]),e}()),K=function(){function e(e,t,i,n,r,a,s,o,h,l){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=i,this._startColor=n,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=h,this._time=l}r(e,"laya.d3.graphics.VertexParticle");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){
return this._cornerTextureCoordinate}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"radius",function(){return this._radius}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"endColor",function(){return this._endColor}),a(0,t,"radian",function(){return this._radian}),a(0,t,"sizeRotation",function(){return this._sizeRotation}),a(0,t,"ageAddScale",function(){return this._ageAddScale}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(116,[new Z(0,"vector4","CORNERTEXTURECOORDINATE"),new Z(16,"vector3","POSITION"),new Z(28,"vector3","VELOCITY"),new Z(40,"vector4","STARTCOLOR"),new Z(56,"vector4","ENDCOLOR"),new Z(72,"vector3","SIZEROTATION"),new Z(84,"vector2","RADIUS"),new Z(92,"vector4","RADIAN"),new Z(108,"single","AGEADDSCALE"),new Z(112,"single","TIME")])}]),e}(),J=function(){function e(e,t,i){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=i}r(e,"laya.d3.graphics.VertexPositionNormalColor");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(40,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR")])}]),e}(),$=function(){function e(e,t,i,n,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=i,this._blendIndex=n,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalColorSkin");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(72,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector4","BLENDWEIGHT"),new Z(56,"vector4","BLENDINDICES")])}]),e}(),ee=function(){function e(e,t,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(84,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector4","BLENDWEIGHT"),new Z(56,"vector4","BLENDINDICES"),new Z(72,"vector3","TANGENT0")])}]),e}(),te=function(){function e(e,t,i,n){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=i,this._tangent=n}r(e,"laya.d3.graphics.VertexPositionNormalColorTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(52,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector3","TANGENT0")])}]),e}(),ie=function(){function e(e,t,i,n){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(48,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV")])}]),e}(),ne=function(){function e(e,t,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(56,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector2","UV1")])}]),e}(),re=function(){function e(e,t,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(88,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector2","UV1"),new Z(56,"vector4","BLENDWEIGHT"),new Z(72,"vector4","BLENDINDICES")])}]),e}(),ae=(function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,i,n,r,a,s,o){this._position=e,this._normal=t,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(100,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector2","UV1"),new Z(56,"vector4","BLENDWEIGHT"),new Z(72,"vector4","BLENDINDICES"),new Z(88,"vector3","TANGENT0")])}]),e}(),function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,i,n,r,a){this._position=e,this._normal=t,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a},a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(68,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector2","UV1"),new Z(56,"vector3","TANGENT0")])}]),e}(),function(){function e(e,t,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate=n,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(80,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector4","BLENDWEIGHT"),new Z(64,"vector4","BLENDINDICES")])}]),e}()),se=function(){function e(e,t,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(92,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector4","BLENDWEIGHT"),new Z(64,"vector4","BLENDINDICES"),new Z(80,"vector3","TANGENT0")])}]),e}(),oe=function(){function e(e,t,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=i,this._textureCoordinate=n,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"color",function(){return this._color}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(60,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector4","COLOR"),new Z(40,"vector2","UV"),new Z(48,"vector3","TANGENT0")])}]),e}(),he=function(){function e(e,t,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=i}r(e,"laya.d3.graphics.VertexPositionNormalTexture");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(32,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV")])}]),e}(),le=function(){function e(e,t,i,n){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=n}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(40,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector2","UV1")])}]),e}(),ue=function(){function e(e,t,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=n,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(72,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector2","UV1"),new Z(40,"vector4","BLENDWEIGHT"),new Z(56,"vector4","BLENDINDICES")])}]),e}(),ce=(function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,i,n,r,a,s){this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(84,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector2","UV1"),new Z(40,"vector4","BLENDWEIGHT"),new Z(56,"vector4","BLENDINDICES"),new Z(72,"vector3","TANGENT0")])}]),e}(),function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,i,n,r){this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r},a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(52,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector2","UV1"),new Z(40,"vector3","TANGENT0")])}]),e}(),function(){function e(e,t,i,n,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=i,this._blendIndex=n,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkin");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(64,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector4","BLENDWEIGHT"),new Z(48,"vector4","BLENDINDICES")])}]),e}()),_e=function(){function e(e,t,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"normal",function(){return this._normal}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(76,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector4","BLENDWEIGHT"),new Z(48,"vector4","BLENDINDICES"),new Z(64,"vector3","TANGENT0")])}]),e}(),de=function(){function e(e,t,i,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=i,this._tangent=n}r(e,"laya.d3.graphics.VertexPositionNormalTextureTangent");var t=e.prototype;return i.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"normal",function(){return this._normal}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),n(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new Q(44,[new Z(0,"vector3","POSITION"),new Z(12,"vector3","NORMAL"),new Z(24,"vector2","UV"),new Z(32,"vector3","TANGENT0")])}]),e}(),fe=function(){function e(e,t,i,n){this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._fileData=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=t,this._materials=i,this._onLoaded(e,n)}r(e,"laya.d3.loaders.LoadModel");var t=e.prototype;return t._onLoaded=function(e,t){var i=b.basePath;b.basePath=b.getPath(b.formatURL(t)),this._fileData=e,this._readData=new l(this._fileData),this._readData.pos=0;this._readData.readUTFString();this.READ_BLOCK();for(var n=0;n<this._BLOCK.count;n++){var r=this._readData.getUint16(),a=this._strings[r],s=this["READ_"+a];if(null==s)throw new Error("model file err,no this function:"+r+" "+a);if(!s.call(this))break}return b.basePath=i,this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=this._readString(),i=this._readString();if("null"!==i){i=b.formatURL(i);var n=D.materialCache[i];n?this._materials[e]=n:(n=this._materials[e]=D.materialCache[i]=new Le,n.setShaderName(t),Le.createFromFile(i,n))}else this._materials[e]=new Le;return!0},t.READ_MESH=function(){this._readString();return!0},t.READ_SUBMESH=function(){var t=(this._readString(),this._readData.getUint8()),i=this._readString();this._shaderAttributes=i.match(e._attrReg);var n=this._readData.getUint32(),r=this._readData.getUint32(),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),h=this._readData.getUint32(),l=this._readData.getUint32(),u=this._readData.getUint32(),c=this._readData.__getBuffer(),_=new Ae(this._mesh);_.material=t,_.verticesIndices=new Uint32Array(c.slice(a+this._DATA.offset,a+this._DATA.offset+s));var d=this._getVertexDeclaration(),f=Ye.create(d,h/d.vertexStride,35044,!0),m=o+this._DATA.offset,p=c.slice(m,m+h);f.setData(new Float32Array(p)),_.setVB(f);for(var v=f.vertexDeclaration.getVertexElements(),g=0;g<v.length;g++)_._bufferUsage[v[g].elementUsage]=f;var x=Ze.create("ushort",r/2,35044,!0),T=n+this._DATA.offset,C=c.slice(T,T+r);x.setData(new Uint16Array(C)),_.setIB(x,r/2);var I=c.slice(l+this._DATA.offset,l+this._DATA.offset+u);return _._setBoneDic(new Uint8Array(I)),this._mesh.add(_),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=0;o<this._shaderAttributes.length;o+=8)switch(this._shaderAttributes[o]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":i=!0;break;case"UV":n=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var h;return e&&t&&i&&n&&r&&a&&s?h=re.vertexDeclaration:e&&t&&n&&r&&a&&s?h=ue.vertexDeclaration:e&&t&&i&&n&&a&&s?h=ae.vertexDeclaration:e&&t&&n&&a&&s?h=ce.vertexDeclaration:e&&t&&i&&a&&s?h=$.vertexDeclaration:e&&t&&i&&n&&r?h=ne.vertexDeclaration:e&&t&&n&&r?h=le.vertexDeclaration:e&&t&&i&&n?h=ie.vertexDeclaration:e&&t&&n?h=he.vertexDeclaration:e&&t&&i&&(h=J.vertexDeclaration),h},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),me=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}r(e,"laya.d3.math.BoundBox");var t=e.prototype;return t.getCorners=function(e){e.length=8;var t=this.min.elements,i=this.max.elements,n=t[0],r=t[1],a=t[2],s=i[0],o=i[1],h=i[2];e[0]=new Ee(n,o,h),e[1]=new Ee(s,o,h),e[2]=new Ee(s,r,h),e[3]=new Ee(n,r,h),e[4]=new Ee(n,o,a),e[5]=new Ee(s,o,a),e[6]=new Ee(s,r,a),e[7]=new Ee(n,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");for(var i=new Ee(Number.MAX_VALUE),n=new Ee(-Number.MAX_VALUE),r=0;r<e.length;++r)Ee.min(i,e[r],i),Ee.max(n,e[r],n);t.min=i,t.max=n},e}(),pe=function(){function e(t){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=t,this._near=new Ce(new Ee),this._far=new Ce(new Ee),this._left=new Ce(new Ee),this._right=new Ce(new Ee),this._top=new Ce(new Ee),this._bottom=new Ce(new Ee),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(e,"laya.d3.math.BoundFrustum");var t=e.prototype;return t.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},t.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},t.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},t.getCorners=function(t){t[0]=e.get3PlaneInterPoint(this._near,this._bottom,this._right),t[1]=e.get3PlaneInterPoint(this._near,this._top,this._right),t[2]=e.get3PlaneInterPoint(this._near,this._top,this._left),t[3]=e.get3PlaneInterPoint(this._near,this._bottom,this._left),t[4]=e.get3PlaneInterPoint(this._far,this._bottom,this._right),t[5]=e.get3PlaneInterPoint(this._far,this._top,this._right),t[6]=e.get3PlaneInterPoint(this._far,this._top,this._left),t[7]=e.get3PlaneInterPoint(this._far,this._bottom,this._left)},t.ContainsPoint=function(e){for(var t=Ce.PlaneIntersectionType_Front,i=Ce.PlaneIntersectionType_Front,n=0;6>n;n++){switch(n){case 0:i=ge.intersectsPlaneAndPoint(this._near,e);break;case 1:i=ge.intersectsPlaneAndPoint(this._far,e);break;case 2:i=ge.intersectsPlaneAndPoint(this._left,e);break;case 3:i=ge.intersectsPlaneAndPoint(this._right,e);break;case 4:i=ge.intersectsPlaneAndPoint(this._top,e);break;case 5:i=ge.intersectsPlaneAndPoint(this._bottom,e)}switch(i){case Ce.PlaneIntersectionType_Back:return 0;case Ce.PlaneIntersectionType_Intersecting:t=Ce.PlaneIntersectionType_Intersecting}}switch(t){case Ce.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t.ContainsBoundBox=function(t){for(var i,n=1,r=0;6>r;r++){if(i=this.getPlane(r),this._getBoxToPlanePVertexNVertex(t,i.normal,e._tempV30,e._tempV31),ge.intersectsPlaneAndPoint(i,e._tempV30)==Ce.PlaneIntersectionType_Back)return 0;ge.intersectsPlaneAndPoint(i,e._tempV31)==Ce.PlaneIntersectionType_Back&&(n=2)}return n},t.ContainsBoundSphere=function(e){for(var t=Ce.PlaneIntersectionType_Front,i=Ce.PlaneIntersectionType_Front,n=0;6>n;n++){switch(n){case 0:i=ge.intersectsPlaneAndSphere(this._near,e);break;case 1:i=ge.intersectsPlaneAndSphere(this._far,e);break;case 2:i=ge.intersectsPlaneAndSphere(this._left,e);break;case 3:i=ge.intersectsPlaneAndSphere(this._right,e);break;case 4:i=ge.intersectsPlaneAndSphere(this._top,e);break;case 5:i=ge.intersectsPlaneAndSphere(this._bottom,e)}switch(i){case Ce.PlaneIntersectionType_Back:return 0;case Ce.PlaneIntersectionType_Intersecting:t=Ce.PlaneIntersectionType_Intersecting}}switch(t){case Ce.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t._getBoxToPlanePVertexNVertex=function(e,t,i,n){var r=e.min,a=r.elements,s=e.max,o=s.elements,h=t.elements,l=h[0],u=h[1],c=h[2];i=r;var _=i.elements;l>=0&&(_[0]=o[0]),u>=0&&(_[1]=o[1]),c>=0&&(_[2]=o[2]),n=s;var d=n.elements;l>=0&&(d[0]=a[0]),u>=0&&(d[1]=a[1]),c>=0&&(d[2]=a[2])},a(0,t,"bottom",function(){return this._bottom}),a(0,t,"matrix",function(){return this._matrix},function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,t,"top",function(){return this._top}),a(0,t,"near",function(){return this._near}),a(0,t,"far",function(){return this._far}),a(0,t,"left",function(){return this._left}),a(0,t,"right",function(){return this._right}),e._getPlanesFromMatrix=function(e,t,i,n,r,a,s){var o=e.elements,h=o[0],l=o[1],u=o[2],c=o[3],_=o[4],d=o[5],f=o[6],m=o[7],p=o[8],v=o[9],g=o[10],x=o[11],T=o[12],C=o[13],I=o[14],D=o[15],M=t.normal.elements;M[0]=u,M[1]=f,M[2]=g,t.distance=I,t.normalize();var E=i.normal.elements;E[0]=c-u,E[1]=m-f,E[2]=x-g,i.distance=D-I,i.normalize();var V=n.normal.elements;V[0]=c+h,V[1]=m+_,V[2]=x+p,n.distance=D+T,n.normalize();var y=r.normal.elements;y[0]=c-h,y[1]=m-_,y[2]=x-p,r.distance=D-T,r.normalize();var A=a.normal.elements;A[0]=c-l,A[1]=m-d,A[2]=x-v,a.distance=D-C,a.normalize();var w=s.normal.elements;w[0]=c+l,w[1]=m+d,w[2]=x+v,s.distance=D+C,s.normalize()},e.get3PlaneInterPoint=function(t,i,n){var r=t.normal,a=i.normal,s=n.normal;Ee.cross(a,s,e._tempV30),Ee.cross(s,r,e._tempV31),Ee.cross(r,a,e._tempV32);var o=Ee.dot(r,e._tempV30),h=Ee.dot(a,e._tempV31),l=Ee.dot(s,e._tempV32);Ee.scale(e._tempV30,-t.distance/o,e._tempV33),Ee.scale(e._tempV31,-i.distance/h,e._tempV34),Ee.scale(e._tempV32,-n.distance/l,e._tempV35),Ee.add(e._tempV33,e._tempV34,e._tempV36),Ee.add(e._tempV35,e._tempV36,e._tempV37);var u=e._tempV37;return u},n(e,["_tempV30",function(){return this._tempV30=new Ee},"_tempV31",function(){return this._tempV31=new Ee},"_tempV32",function(){return this._tempV32=new Ee},"_tempV33",function(){return this._tempV33=new Ee},"_tempV34",function(){return this._tempV34=new Ee},"_tempV35",function(){return this._tempV35=new Ee},"_tempV36",function(){
return this._tempV36=new Ee},"_tempV37",function(){return this._tempV37=new Ee}]),e}(),ve=function(){function e(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}r(e,"laya.d3.math.BoundSphere");var t=e.prototype;return t.toDefault=function(){this.center.toDefault(),this.radius=0},e.createFromSubPoints=function(t,i,n,r){if(null==t)throw new Error("points");if(0>i||i>=t.length)throw new Error("start"+i+"Must be in the range [0, "+(t.length-1)+"]");if(0>n||i+n>t.length)throw new Error("count"+n+"Must be in the range <= "+t.length+"}");var a=i+n,s=e._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=i;a>o;++o)Ee.add(t[o],s,s);var h=r.center;Ee.scale(s,1/n,h);var l=0;for(o=i;a>o;++o){var u=Ee.distanceSquared(h,t[o]);u>l&&(l=u)}r.radius=Math.sqrt(l)},e.createfromPoints=function(t,i){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,i)},n(e,["_tempVector3",function(){return this._tempVector3=new Ee}]),e}(),ge=function(){function e(){}return r(e,"laya.d3.math.Collision"),e.distancePlaneToPoint=function(e,t){var i=Ee.dot(e.normal,t);return i-e.distance},e.distanceBoxToPoint=function(e,t){var i=e.min.elements,n=i[0],r=i[1],a=i[2],s=e.max.elements,o=s[0],h=s[1],l=s[2],u=t.elements,c=u[0],_=u[1],d=u[2],f=0;return n>c&&(f+=(n-c)*(n-c)),c>o&&(f+=(o-c)*(o-c)),r>_&&(f+=(r-_)*(r-_)),_>h&&(f+=(h-_)*(h-_)),a>d&&(f+=(a-d)*(a-d)),d>l&&(f+=(l-d)*(l-d)),Math.sqrt(f)},e.distanceBoxToBox=function(e,t){var i=e.min.elements,n=i[0],r=i[1],a=i[2],s=e.max.elements,o=s[0],h=s[1],l=s[2],u=t.min.elements,c=u[0],_=u[1],d=u[2],f=t.max.elements,m=f[0],p=f[1],v=f[2],g=0,x=NaN;return n>m?(x=n-m,g+=x*x):c>o&&(x=c-o,g+=x*x),r>p?(x=r-p,g+=x*x):_>h&&(x=_-h,g+=x*x),a>v?(x=a-v,g+=x*x):d>l&&(x=d-l,g+=x*x),Math.sqrt(g)},e.distanceSphereToPoint=function(e,t){var i=Math.sqrt(Ee.distanceSquared(e.center,t));return i-=e.radius,Math.max(i,0)},e.distanceSphereToSphere=function(e,t){var i=Math.sqrt(Ee.distanceSquared(e.center,t.center));return i-=e.radius+t.radius,Math.max(i,0)},e.intersectsRayAndPoint=function(t,i){Ee.subtract(t.origin,i,e._tempV30);var n=Ee.dot(e._tempV30,t.direction),r=Ee.dot(e._tempV30,e._tempV30)-xe.zeroTolerance;if(r>0&&n>0)return!1;var a=n*n-r;return!(0>a)},e.intersectsRayAndRay=function(t,i,n){var r=t.origin,a=r.elements,s=a[0],o=a[1],h=a[2],l=t.direction,u=l.elements,c=u[0],_=u[1],d=u[2],f=i.origin,m=f.elements,p=m[0],v=m[1],g=m[2],x=i.direction,T=x.elements,C=T[0],I=T[1],D=T[2];Ee.cross(l,x,e._tempV30);var M=e._tempV30.elements,E=Ee.scalarLength(e._tempV30);if(xe.isZero(E)&&xe.nearEqual(p,s)&&xe.nearEqual(v,o)&&xe.nearEqual(g,h))return n=Ee.ZERO,!0;E*=E;var V=p-s,y=v-o,A=g-h,w=C,b=I,P=D,R=M[0],S=M[1],O=M[2],L=V*b*O+y*P*R+A*w*S-V*P*S-y*w*O-A*b*R;w=c,b=_,P=d;var N=L/E;Ee.scale(l,N,e._tempV30),Ee.scale(x,N,e._tempV31),Ee.add(r,e._tempV30,e._tempV32),Ee.add(f,e._tempV31,e._tempV33);var F=e._tempV32.elements,U=e._tempV33.elements;return xe.nearEqual(U[0],F[0])&&xe.nearEqual(U[1],F[1])&&xe.nearEqual(U[2],F[2])?(n=e._tempV32,!0):(n=Ee.ZERO,!1)},e.intersectsRayAndPlaneRD=function(e,t,i){var n=t.normal,r=Ee.dot(n,e.direction);if(xe.isZero(r))return i=0,!1;var a=Ee.dot(n,e.origin);return i=(-t.distance-a)/r,0>i?(i=0,!1):!0},e.intersectsRayAndPlaneRP=function(t,i,n){var r=NaN;return e.intersectsRayAndPlaneRD(t,i,r)?(Ee.scale(t.direction,r,e._tempV30),Ee.add(t.origin,e._tempV30,e._tempV31),n=e._tempV31,!0):(n=Ee.ZERO,!1)},e.intersectsRayAndBoxRD=function(e,t,i){var n=e.origin.elements,r=n[0],a=n[1],s=n[2],o=e.direction.elements,h=o[0],l=o[1],u=o[2],c=t.min.elements,_=c[0],d=c[1],f=c[2],m=t.max.elements,p=m[0],v=m[1],g=m[2];i=0;var x=xe.MaxValue;if(xe.isZero(h)){if(_>r||r>p)return i=0,!1}else{var T=1/h,C=(_-r)*T,I=(p-r)*T;if(C>I){var D=C;C=I,I=D}if(i=Math.max(C,i),x=Math.min(I,x),i>x)return i=0,!1}if(xe.isZero(l)){if(d>a||a>v)return i=0,!1}else{var M=1/l,E=(d-a)*M,V=(v-a)*M;if(E>V){var y=E;E=V,V=y}if(i=Math.max(E,i),x=Math.min(V,x),i>x)return i=0,!1}if(xe.isZero(u)){if(f>s||s>g)return i=0,!1}else{var A=1/u,w=(f-s)*A,b=(g-s)*A;if(w>b){var P=w;w=b,b=P}if(i=Math.max(w,i),x=Math.min(b,x),i>x)return i=0,!1}return!0},e.intersectsRayAndBoxRP=function(t,i,n){var r=NaN;return e.intersectsRayAndBoxRD(t,i,r)?(Ee.scale(t.direction,r,e._tempV30),Ee.add(t.origin,e._tempV30,e._tempV31),n=e._tempV31,!0):(n=Ee.ZERO,!1)},e.intersectsRayAndSphereRD=function(t,i,n){var r=i.radius;Ee.subtract(t.origin,i.center,e._tempV30);var a=Ee.dot(e._tempV30,t.direction),s=Ee.dot(e._tempV30,e._tempV30)-r*r;if(s>0&&a>0)return n=0,!1;var o=a*a-s;return 0>o?(n=0,!1):(n=-a-Math.sqrt(o),0>n&&(n=0),!0)},e.intersectsRayAndSphereRP=function(t,i,n){var r=NaN;return e.intersectsRayAndSphereRD(t,i,r)?(Ee.scale(t.direction,r,e._tempV30),Ee.add(t.origin,e._tempV30,e._tempV31),n=e._tempV31,!0):(n=Ee.ZERO,!1)},e.intersectsPlaneAndPoint=function(e,t){var i=Ee.dot(e.normal,t)+e.distance;return i>0?Ce.PlaneIntersectionType_Front:0>i?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndPlane=function(t,i){Ee.cross(t.normal,i.normal,e._tempV30);var n=Ee.dot(e._tempV30,e._tempV30);return!xe.isZero(n)},e.intersectsPlaneAndPlaneRL=function(t,i,n){var r=t.normal,a=i.normal;Ee.cross(r,a,e._tempV34);var s=Ee.dot(e._tempV34,e._tempV34);return xe.isZero(s)?!1:(Ee.scale(a,t.distance,e._tempV30),Ee.scale(r,i.distance,e._tempV31),Ee.subtract(e._tempV30,e._tempV31,e._tempV32),Ee.cross(e._tempV32,e._tempV34,e._tempV33),Ee.normalize(e._tempV34,e._tempV34),n=new De(e._tempV33,e._tempV34),!0)},e.intersectsPlaneAndBox=function(t,i){var n=t.distance,r=t.normal,a=r.elements,s=a[0],o=a[1],h=a[2],l=i.min.elements,u=l[0],c=l[1],_=l[2],d=i.max.elements,f=d[0],m=d[1],p=d[2];e._tempV30.elements[0]=s>0?u:f,e._tempV30.elements[1]=o>0?c:m,e._tempV30.elements[2]=h>0?_:p,e._tempV31.elements[0]=s>0?f:u,e._tempV31.elements[1]=o>0?m:c,e._tempV31.elements[2]=h>0?p:_;var v=Ee.dot(r,e._tempV30);return v+n>0?Ce.PlaneIntersectionType_Front:(v=Ee.dot(r,e._tempV31),0>v+n?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting)},e.intersectsPlaneAndSphere=function(e,t){var i=t.radius,n=Ee.dot(e.normal,t.center)+e.distance;return n>i?Ce.PlaneIntersectionType_Front:-i>n?Ce.PlaneIntersectionType_Back:Ce.PlaneIntersectionType_Intersecting},e.intersectsBoxAndBox=function(e,t){var i=e.min.elements,n=(i[1],i[2],e.max.elements),r=(n[1],n[2],t.min.elements),a=(r[1],r[2],t.max.elements);a[1],a[2];return i[0]>a[0]||r[0]>n[0]?!1:i[1]>a[1]||r[1]>n[1]?!1:!(i[2]>a[2]||r[2]>n[2])},e.intersectsBoxAndSphere=function(t,i){var n=i.center,r=i.radius;Ee.Clamp(n,t.min,t.max,e._tempV30);var a=Ee.distanceSquared(n,e._tempV30);return r*r>=a},e.intersectsSphereAndSphere=function(e,t){var i=e.radius+t.radius;return Ee.distanceSquared(e.center,t.center)<=i*i},n(e,["_tempV30",function(){return this._tempV30=new Ee},"_tempV31",function(){return this._tempV31=new Ee},"_tempV32",function(){return this._tempV32=new Ee},"_tempV33",function(){return this._tempV33=new Ee},"_tempV34",function(){return this._tempV34=new Ee}]),e}(),xe=(function(){function e(){}return r(e,"laya.d3.math.ContainmentType"),e.Disjoint=0,e.Contains=1,e.Intersects=2,e}(),function(){function e(){}return r(e,"laya.d3.math.MathUtils3D"),e.isZero=function(t){return Math.abs(t)<e.zeroTolerance},e.nearEqual=function(t,i){return!!e.isZero(t-i)},n(e,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),e}()),Te=(function(){function e(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}r(e,"laya.d3.math.Matrix3x3");var t=e.prototype;return t.determinant=function(){var e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],a=e[4],s=e[5],o=e[6],h=e[7],l=e[8];return t*(l*a-s*h)+i*(-l*r+s*o)+n*(h*r-a*o)},t.translate=function(e,t){var i=t.elements,n=this.elements,r=e.elements,a=n[0],s=n[1],o=n[2],h=n[3],l=n[4],u=n[5],c=n[6],_=n[7],d=n[8],f=r[0],m=r[1];i[0]=a,i[1]=s,i[2]=o,i[3]=h,i[4]=l,i[5]=u,i[6]=f*a+m*h+c,i[7]=f*s+m*l+_,i[8]=f*o+m*u+d},t.rotate=function(e,t){var i=t.elements,n=this.elements,r=n[0],a=n[1],s=n[2],o=n[3],h=n[4],l=n[5],u=n[6],c=n[7],_=n[8],d=Math.sin(e),f=Math.cos(e);i[0]=f*r+d*o,i[1]=f*a+d*h,i[2]=f*s+d*l,i[3]=f*o-d*r,i[4]=f*h-d*a,i[5]=f*l-d*s,i[6]=u,i[7]=c,i[8]=_},t.scale=function(e,t){var i=t.elements,n=this.elements,r=e.elements,a=r[0],s=r[1];i[0]=a*n[0],i[1]=a*n[1],i[2]=a*n[2],i[3]=s*n[3],i[4]=s*n[4],i[5]=s*n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8]},t.invert=function(e){var t=e.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],h=i[5],l=i[6],u=i[7],c=i[8],_=c*o-h*u,d=-c*s+h*l,f=u*s-o*l,m=n*_+r*d+a*f;m||(e=null),m=1/m,t[0]=_*m,t[1]=(-c*r+a*u)*m,t[2]=(h*r-a*o)*m,t[3]=d*m,t[4]=(c*n-a*l)*m,t[5]=(-h*n+a*s)*m,t[6]=f*m,t[7]=(-u*n+r*l)*m,t[8]=(o*n-r*s)*m},t.transpose=function(e){var t=e.elements,i=this.elements;if(e===this){var n=i[1],r=i[2],a=i[5];t[1]=i[3],t[2]=i[6],t[3]=n,t[5]=i[7],t[6]=r,t[7]=a}else t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8]},t.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.cloneTo=function(e){var t,i,n;if(i=this.elements,n=e.elements,i!==n)for(t=0;9>t;++t)n[t]=i[t]},t.copyFrom=function(e){var t,i,n;if(i=e.elements,n=this.elements,i!==n)for(t=0;9>t;++t)n[t]=i[t]},t.copyFromArray=function(e){var t,i;if(i=this.elements,e!==i)for(t=0;9>t;++t)i[t]=e[t]},e.createFromTranslation=function(e,t){var i=(t.elements,e.elements);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=i[0],t[7]=i[1],t[8]=1},e.createFromRotation=function(e,t){var i=t.elements,n=Math.sin(e),r=Math.cos(e);i[0]=r,i[1]=n,i[2]=0,i[3]=-n,i[4]=r,i[5]=0,i[6]=0,i[7]=0,i[8]=1},e.createFromScaling=function(e,t){var i=t.elements,n=e.elements;i[0]=n[0],i[1]=0,i[2]=0,i[3]=0,i[4]=n[1],i[5]=0,i[6]=0,i[7]=0,i[8]=1},e.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},e.multiply=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],h=r[2],l=r[3],u=r[4],c=r[5],_=r[6],d=r[7],f=r[8],m=a[0],p=a[1],v=a[2],g=a[3],x=a[4],T=a[5],C=a[6],I=a[7],D=a[8];n[0]=m*s+p*l+v*_,n[1]=m*o+p*u+v*d,n[2]=m*h+p*c+v*f,n[3]=g*s+x*l+T*_,n[4]=g*o+x*u+T*d,n[5]=g*h+x*c+T*f,n[6]=C*s+I*l+D*_,n[7]=C*o+I*u+D*d,n[8]=C*h+I*c+D*f},e.DEFAULT=new e,e}(),function(){function e(e,t,i,n,r,a,s,o,h,l,u,c,_,d,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===c&&(c=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=i,p[3]=n,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=h,p[9]=l,p[10]=u,p[11]=c,p[12]=_,p[13]=d,p[14]=f,p[15]=m}r(e,"laya.d3.math.Matrix4x4");var t=e.prototype;return t.equalsOtherMatrix=function(e){var t=this.elements,i=e.elements;return xe.nearEqual(t[0],i[0])&&xe.nearEqual(t[1],i[1])&&xe.nearEqual(t[2],i[2])&&xe.nearEqual(t[3],i[3])&&xe.nearEqual(t[4],i[4])&&xe.nearEqual(t[5],i[5])&&xe.nearEqual(t[6],i[6])&&xe.nearEqual(t[7],i[7])&&xe.nearEqual(t[8],i[8])&&xe.nearEqual(t[9],i[9])&&xe.nearEqual(t[10],i[10])&&xe.nearEqual(t[11],i[11])&&xe.nearEqual(t[12],i[12])&&xe.nearEqual(t[13],i[13])&&xe.nearEqual(t[14],i[14])&&xe.nearEqual(t[15],i[15])},t.decompose=function(t,i,n){var r=this.elements,a=t.elements,s=i.elements,o=n.elements;if(a[0]=r[12],a[1]=r[13],a[2]=r[14],o[0]=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),o[1]=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),o[2]=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),xe.isZero(o[0])||xe.isZero(o[1])||xe.isZero(o[2]))return s[0]=s[1]=s[2]=0,s[3]=1,!1;var h=new e,l=h.elements;return l[0]=r[0]/o[0],l[1]=r[1]/o[0],l[2]=r[2]/o[0],l[4]=r[4]/o[1],l[5]=r[5]/o[1],l[6]=r[6]/o[1],l[8]=r[8]/o[2],l[9]=r[9]/o[2],l[10]=r[10]/o[2],h[15]=1,Ie.createFromMatrix4x4(h,i),!0},t.normalize=function(){var e=this.elements,t=e[0],i=e[1],n=e[2],r=Math.sqrt(t*t+i*i+n*n);return r?void(1!=r&&(r=1/r,e[0]=t*r,e[1]=i*r,e[2]=n*r)):(e[0]=0,e[1]=0,void(e[2]=0))},t.transpose=function(){var e,t;return e=this.elements,t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.invert=function(e){var t=this.elements,i=e.elements,n=t[0],r=t[1],a=t[2],s=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],_=t[9],d=t[10],f=t[11],m=t[12],p=t[13],v=t[14],g=t[15],x=n*h-r*o,T=n*l-a*o,C=n*u-s*o,I=r*l-a*h,D=r*u-s*h,M=a*u-s*l,E=c*p-_*m,V=c*v-d*m,y=c*g-f*m,A=_*v-d*p,w=_*g-f*p,b=d*g-f*v,P=x*b-T*w+C*A+I*y-D*V+M*E;0!==Math.abs(P)&&(P=1/P,i[0]=(h*b-l*w+u*A)*P,i[1]=(a*w-r*b-s*A)*P,i[2]=(p*M-v*D+g*I)*P,i[3]=(d*D-_*M-f*I)*P,i[4]=(l*y-o*b-u*V)*P,i[5]=(n*b-a*y+s*V)*P,i[6]=(v*C-m*M-g*T)*P,i[7]=(c*M-d*C+f*T)*P,i[8]=(o*w-h*y+u*E)*P,i[9]=(r*y-n*w-s*E)*P,i[10]=(m*D-p*C+g*x)*P,i[11]=(_*C-c*D-f*x)*P,i[12]=(h*V-o*A-l*E)*P,i[13]=(n*A-r*V+a*E)*P,i[14]=(p*T-m*I-v*x)*P,i[15]=(c*I-_*T+d*x)*P)},t.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},t.cloneTo=function(e){var t,i,n;if(i=this.elements,n=e.elements,i!==n)for(t=0;16>t;++t)n[t]=i[t]},t.copyFrom=function(e){var t,i,n;if(i=e.elements,n=this.elements,i!==n)for(t=0;16>t;++t)n[t]=i[t]},t.copyFromArray=function(e){var t,i;if(i=this.elements,e!==i)for(t=0;16>t;++t)i[t]=e[t]},e.createRotationX=function(e,t){var i=t.elements,n=Math.sin(e),r=Math.cos(e);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=r,i[6]=n,i[9]=-n},e.createRotationY=function(e,t){var i=t.elements,n=Math.sin(e),r=Math.cos(e);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=r,i[2]=-n,i[8]=n},e.createRotationZ=function(e,t){var i=t.elements,n=Math.sin(e),r=Math.cos(e);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=r,i[1]=n,i[4]=-n},e.createTranslate=function(e,t){var i=e.elements,n=t.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},e.createScaling=function(e,t){var i=e.elements,n=t.elements;n[0]=i[0],n[5]=i[1],n[10]=i[2],n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1},e.multiply=function(e,t,i){var n,r,a,s,o,h,l,u;if(r=i.elements,a=e.elements,s=t.elements,r===s)for(s=new Float32Array(16),n=0;16>n;++n)s[n]=r[n];for(n=0;4>n;n++)o=a[n],h=a[n+4],l=a[n+8],u=a[n+12],r[n]=o*s[0]+h*s[1]+l*s[2]+u*s[3],r[n+4]=o*s[4]+h*s[5]+l*s[6]+u*s[7],r[n+8]=o*s[8]+h*s[9]+l*s[10]+u*s[11],r[n+12]=o*s[12]+h*s[13]+l*s[14]+u*s[15]},e.createFromQuaternion=function(e,t){var i=t.elements,n=e.elements,r=n[0],a=n[1],s=n[2],o=n[3],h=r+r,l=a+a,u=s+s,c=r*h,_=a*h,d=a*l,f=s*h,m=s*l,p=s*u,v=o*h,g=o*l,x=o*u;i[0]=1-d-p,i[1]=_+x,i[2]=f-g,i[3]=0,i[4]=_-x,i[5]=1-c-p,i[6]=m+v,i[7]=0,i[8]=f+g,i[9]=m-v,i[10]=1-c-d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,t[15]=1},e.createAffineTransformation=function(e,t,i,n){var r=e.elements,a=t.elements,s=i.elements,o=n.elements,h=a[0],l=a[1],u=a[2],c=a[3],_=h+h,d=l+l,f=u+u,m=h*_,p=h*d,v=h*f,g=l*d,x=l*f,T=u*f,C=c*_,I=c*d,D=c*f,M=s[0],E=s[1],V=s[2];o[0]=(1-(g+T))*M,o[1]=(p+D)*M,o[2]=(v-I)*M,o[3]=0,o[4]=(p-D)*E,o[5]=(1-(m+T))*E,o[6]=(x+C)*E,o[7]=0,o[8]=(v+I)*V,o[9]=(x-C)*V,o[10]=(1-(m+g))*V,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},e.createLookAt=function(e,t,i,n){var r,a,s,o,h,l,u,c,_,d,f=e.elements,m=t.elements,p=i.elements,v=n.elements,g=f[0],x=f[1],T=f[2],C=p[0],I=p[1],D=p[2],M=m[0],E=m[1],V=m[2];return Math.abs(g-M)<xe.zeroTolerance&&Math.abs(x-E)<xe.zeroTolerance&&Math.abs(T-V)<xe.zeroTolerance?void n.identity():(u=g-M,c=x-E,_=T-V,d=1/Math.sqrt(u*u+c*c+_*_),u*=d,c*=d,_*=d,r=I*_-D*c,a=D*u-C*_,s=C*c-I*u,d=Math.sqrt(r*r+a*a+s*s),d?(d=1/d,r*=d,a*=d,s*=d):r=a=s=0,o=c*s-_*a,h=_*r-u*s,l=u*a-c*r,d=Math.sqrt(o*o+h*h+l*l),d?(d=1/d,o*=d,h*=d,l*=d):o=h=l=0,v[0]=r,v[1]=o,v[2]=u,v[3]=0,v[4]=a,v[5]=h,v[6]=c,v[7]=0,v[8]=s,v[9]=l,v[10]=_,v[11]=0,v[12]=-(r*g+a*x+s*T),v[13]=-(o*g+h*x+l*T),v[14]=-(u*g+c*x+_*T),void(v[15]=1))},e.createPerspective=function(e,t,i,n,r){var a=r.elements,s=1/Math.tan(e/2),o=1/(i-n);a[0]=s/t,a[5]=s,a[10]=(n+i)*o,a[11]=-1,a[14]=2*n*i*o,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},e.createOrthogonal=function(e,t,i,n,r,a,s){var o=s.elements,h=1/(e-t),l=1/(i-n),u=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*h,o[5]=-2*l,o[10]=2*u,o[12]=(e+t)*h,o[13]=(n+i)*l,o[14]=(a+r)*u},e.TEMP=new e,e.DEFAULT=new e,e}()),Ce=function(){function e(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}r(e,"laya.d3.math.Plane");var t=e.prototype;return t.normalize=function(){var e=this.normal.elements,t=e[0],i=e[1],n=e[2],r=1/Math.sqrt(t*t+i*i+n*n);e[0]=t*r,e[1]=i*r,e[2]=n*r,this.distance*=r},e.createPlaneBy3P=function(t,i,n){var r=t.elements,a=i.elements,s=n.elements,o=a[0]-r[0],h=a[1]-r[1],l=a[2]-r[2],u=s[0]-r[0],c=s[1]-r[1],_=s[2]-r[2],d=h*_-l*c,f=l*u-o*_,m=o*c-h*u,p=1/Math.sqrt(d*d+f*f+m*m),v=d*p,g=f*p,x=m*p,T=e._TEMPVec3.elements;T[0]=v,T[1]=g,T[2]=x;var C=-(v*r[0]+g*r[1]+x*r[2]),I=new e(e._TEMPVec3,C);return I},e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,n(e,["_TEMPVec3",function(){return this._TEMPVec3=new Ee}]),e}(),Ie=function(){function e(e,t,i,n){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=i,this.elements[3]=n}r(e,"laya.d3.math.Quaternion");var t=e.prototype;return t.scaling=function(e,t){var i=t.elements,n=this.elements;i[0]=n[0]*e,i[1]=n[1]*e,i[2]=n[2]*e,i[3]=n[3]*e},t.normalize=function(e){var t=e.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=r*o,t[2]=a*o,t[3]=s*o)},t.length=function(){var e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3];return Math.sqrt(t*t+i*i+n*n+r*r)},t.rotateX=function(e,t){var i=t.elements,n=this.elements;e*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(e),l=Math.cos(e);i[0]=r*l+o*h,i[1]=a*l+s*h,i[2]=s*l-a*h,i[3]=o*l-r*h},t.rotateY=function(e,t){var i=t.elements,n=this.elements;e*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(e),l=Math.cos(e);i[0]=r*l-s*h,i[1]=a*l+o*h,i[2]=s*l+r*h,i[3]=o*l-a*h},t.rotateZ=function(e,t){var i=t.elements,n=this.elements;e*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(e),l=Math.cos(e);i[0]=r*l+a*h,i[1]=a*l-r*h,i[2]=s*l+o*h,i[3]=o*l-s*h},t.getYawPitchRoll=function(t){Ee.transformQuat(Ee.ForwardRH,this,e.TEMPVector31),Ee.transformQuat(Ee.Up,this,e.TEMPVector32);var i=e.TEMPVector32.elements;e.angleTo(Ee.ZERO,e.TEMPVector31,e.TEMPVector33);var n=e.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=e.arcTanAngle(i[2],i[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=e.arcTanAngle(-i[2],-i[0]),n[2]=0):(Te.createRotationY(-n[1],e.TEMPMatrix0),Te.createRotationX(-n[0],e.TEMPMatrix1),Ee.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),Ee.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),n[2]=e.arcTanAngle(i[1],-i[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var r=t.elements;r[0]=n[1],r[1]=n[0],r[2]=n[2]},t.invert=function(e){var t=e.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s,h=o?1/o:0;t[0]=-n*h,t[1]=-r*h,t[2]=-a*h,t[3]=s*h},t.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},t.cloneTo=function(e){var t,i,n;if(i=this.elements,n=e.elements,i!==n)for(t=0;4>t;++t)n[t]=i[t]},t.copyFrom=function(e){var t,i,n;if(i=e.elements,n=this.elements,i!==n)for(t=0;4>t;++t)n[t]=i[t]},t.copyFromArray=function(e){var t,i;if(i=this.elements,e!==i)for(t=0;4>t;++t)i[t]=e[t]},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.createFromYawPitchRoll=function(e,t,i,n){var r=.5*i,a=.5*t,s=.5*e,o=Math.sin(r),h=Math.cos(r),l=Math.sin(a),u=Math.cos(a),c=Math.sin(s),_=Math.cos(s),d=n.elements;d[0]=_*l*h+c*u*o,d[1]=c*u*h-_*l*o,d[2]=_*u*o-c*l*h,d[3]=_*u*h+c*l*o},e.multiply=function(e,t,i){var n=e.elements,r=t.elements,a=i.elements,s=n[0],o=n[1],h=n[2],l=n[3],u=r[0],c=r[1],_=r[2],d=r[3],f=o*_-h*c,m=h*u-s*_,p=s*c-o*u,v=s*u+o*c+h*_;a[0]=s*d+u*l+f,a[1]=o*d+c*l+m,a[2]=h*d+_*l+p,a[3]=l*d-v},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):0>e?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,i,n){Ee.subtract(i,t,e.TEMPVector30),Ee.normalize(e.TEMPVector30,e.TEMPVector30),n.elements[0]=Math.asin(e.TEMPVector30.y),n.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)},e.createFromAxisAngle=function(e,t,i){var n=i.elements,r=e.elements;t=.5*t;var a=Math.sin(t);n[0]=a*r[0],n[1]=a*r[1],n[2]=a*r[2],n[3]=Math.cos(t)},e.createFromMatrix3x3=function(e,t){var i,n=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)i=Math.sqrt(a+1),n[3]=.5*i,i=.5/i,n[0]=(r[5]-r[7])*i,n[1]=(r[6]-r[2])*i,n[2]=(r[1]-r[3])*i;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,h=(s+2)%3;i=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*h+h]+1),n[s]=.5*i,i=.5/i,n[3]=(r[3*o+h]-r[3*h+o])*i,n[o]=(r[3*o+s]+r[3*s+o])*i,n[h]=(r[3*h+s]+r[3*s+h])*i}},e.createFromMatrix4x4=function(e,t){var i,n,r=e.elements,a=t.elements,s=r[0]+r[5]+r[10];s>0?(i=Math.sqrt(s+1),a[3]=.5*i,i=.5/i,a[0]=(r[6]-r[9])*i,a[1]=(r[8]-r[2])*i,a[2]=(r[1]-r[4])*i):r[0]>=r[5]&&r[0]>=r[10]?(i=Math.sqrt(1+r[0]-r[5]-r[10]),n=.5/i,a[0]=.5*i,a[1]=(r[1]+r[4])*n,a[2]=(r[2]+r[8])*n,a[3]=(r[6]-r[9])*n):r[5]>r[10]?(i=Math.sqrt(1+r[5]-r[0]-r[10]),n=.5/i,a[0]=(r[4]+r[1])*n,a[1]=.5*i,a[2]=(r[9]+r[6])*n,a[3]=(r[8]-r[2])*n):(i=Math.sqrt(1+r[10]-r[0]-r[5]),n=.5/i,a[0]=(r[8]+r[2])*n,a[1]=(r[9]+r[6])*n,a[2]=.5*i,a[3]=(r[1]-r[4])*n)},e.slerp=function(e,t,i,n){var r,a,s,o,h,l=e.elements,u=t.elements,c=n.elements,_=l[0],d=l[1],f=l[2],m=l[3],p=u[0],v=u[1],g=u[2],x=u[3];return a=_*p+d*v+f*g+m*x,0>a&&(a=-a,p=-p,v=-v,g=-g,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-i)*r)/s,h=Math.sin(i*r)/s):(o=1-i,h=i),c[0]=o*_+h*p,c[1]=o*d+h*v,c[2]=o*f+h*g,c[3]=o*m+h*x,c},e.lerp=function(e,t,i,n){var r=n.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l),r[3]=u+i*(s[3]-u)},e.add=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},e.dot=function(e,t){var i=e.elements,n=t.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3]},e.DEFAULT=new e,n(e,["TEMPVector30",function(){return this.TEMPVector30=new Ee},"TEMPVector31",function(){return this.TEMPVector31=new Ee},"TEMPVector32",function(){return this.TEMPVector32=new Ee},"TEMPVector33",function(){return this.TEMPVector33=new Ee},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Te},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Te}]),e}(),De=function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return r(e,"laya.d3.math.Ray"),e}(),Me=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var i=this.elements;i[0]=e,i[1]=t}r(e,"laya.d3.math.Vector2");var t=e.prototype;return t.clone=function(e){var t=this.elements,i=e.elements;t[0]=i[0],t[1]=i[1]},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),n(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),Ee=function(){function e(e,t,i){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0);var n=this.elements;n[0]=e,n[1]=t,n[2]=i}r(e,"laya.d3.math.Vector3");var t=e.prototype;return t.copyFrom=function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],this},t.clone=function(){var t=new e,i=t.elements,n=this.elements;return i[0]=n[0],i[1]=n[1],i[2]=n[2],t},t.cloneTo=function(e){var t=e.elements,i=this.elements;t[0]=i[0],t[1]=i[1],t[2]=i[2]},t.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),e.distanceSquared=function(e,t){var i=e.elements,n=t.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return r*r+a*a+s*s},e.min=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2])},e.max=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2])},e.transformQuat=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements,s=r[0],o=r[1],h=r[2],l=a[0],u=a[1],c=a[2],_=a[3],d=_*s+u*h-c*o,f=_*o+c*s-l*h,m=_*h+l*o-u*s,p=-l*s-u*o-c*h;n[0]=d*_+p*-l+f*-c-m*-u,n[1]=f*_+p*-u+m*-l-d*-c,n[2]=m*_+p*-c+d*-u-f*-l},e.scalarLength=function(e){var t=e.elements,i=t[0],n=t[1],r=t[2];return Math.sqrt(i*i+n*n+r*r)},e.normalize=function(e,t){var i=e.elements,n=t.elements,r=i[0],a=i[1],s=i[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),n[0]=i[0]*o,n[1]=i[1]*o,n[2]=i[2]*o)},e.multiply=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2]},e.scale=function(e,t,i){var n=i.elements,r=e.elements;n[0]=r[0]*t,n[1]=r[1]*t,n[2]=r[2]*t},e.lerp=function(e,t,i,n){var r=n.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l)},e.transformV3ToV3=function(t,i,n){var r=new Ve;e.transformV3ToV4(t,i,r);var a=r.elements,s=n.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},e.transformV3ToV4=function(e,t,i){var n=e.elements,r=n[0],a=n[1],s=n[2],o=t.elements,h=i.elements;h[0]=r*o[0]+a*o[4]+s*o[8]+o[12],h[1]=r*o[1]+a*o[5]+s*o[9]+o[13],h[2]=r*o[2]+a*o[6]+s*o[10]+o[14],h[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},e.transformCoordinate=function(t,i,n){var r=e.TEMPVec4.elements,a=t.elements,s=a[0],o=a[1],h=a[2],l=i.elements;r[0]=s*l[0]+o*l[4]+h*l[8]+l[12],r[1]=s*l[1]+o*l[5]+h*l[9]+l[13],r[2]=s*l[2]+o*l[6]+h*l[10]+l[14],r[3]=1/(s*l[3]+o*l[7]+h*l[11]+l[15]);var u=n.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},e.Clamp=function(e,t,i,n){var r=e.elements,a=r[0],s=r[1],o=r[2],h=t.elements,l=h[0],u=h[1],c=h[2],_=i.elements,d=_[0],f=_[1],m=_[2],p=n.elements;a=a>d?d:a,a=l>a?l:a,s=s>f?f:s,s=u>s?u:s,o=o>m?m:o,o=c>o?c:o,p[0]=a,p[1]=s,p[2]=o},e.add=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2]},e.subtract=function(e,t,i){var n=i.elements,r=e.elements,a=t.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2]},e.cross=function(e,t,i){var n=e.elements,r=t.elements,a=i.elements,s=n[0],o=n[1],h=n[2],l=r[0],u=r[1],c=r[2];a[0]=o*c-h*u,a[1]=h*l-s*c,a[2]=s*u-o*l},e.dot=function(e,t){var i=e.elements,n=t.elements,r=i[0]*n[0]+i[1]*n[1]+i[2]*n[2];return r},n(e,["TEMPVec4",function(){return this.TEMPVec4=new Ve},"ZERO",function(){return this.ZERO=new e(0,0,0)},"ONE",function(){return this.ONE=new e(1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new e(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new e(0,0,1)},"Up",function(){return this.Up=new e(0,1,0)}]),e}(),Ve=function(){function e(e,t,i,n){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=i,r[3]=n}r(e,"laya.d3.math.Vector4");var t=e.prototype;return t.copyFrom=function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],this},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.lerp=function(e,t,i,n){var r=n.elements,a=e.elements,s=t.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l),r[3]=u+i*(s[3]-u)},n(e,["ZERO",function(){return this.ZERO=new e}]),e}(),ye=function(){function e(e,t,i,n){this.minDepth=-1,this.maxDepth=1,this.x=e,this.y=t,this.width=i,this.height=n}r(e,"laya.d3.math.Viewport");var t=e.prototype;return t.project=function(e,t,i){Ee.transformV3ToV3(e,t,i);var n=e.elements,r=t.elements,a=i.elements,s=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(-a[1]+1)*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},t.unprojectFromMat=function(e,t,i){var n=e.elements,r=t.elements,a=i.elements;a[0]=(n[0]-this.x)/this.width*2-1,a[1]=-((n[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(n[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];Ee.transformV3ToV3(i,t,i),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},t.unprojectFromWVP=function(t,i,n,r,a){Te.multiply(i,n,e._tempMatrix4x4),r&&Te.multiply(e._tempMatrix4x4,r,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)},n(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Te}]),e}(),Ae=function(){function e(e){this._ib=null,this._materialIndex=-1,this._numberIndices=0,this._vb=null,this._mesh=null,this._boneIndex=null,this._bufferUsage={},this._finalBufferUsageDic=null,this._isVertexbaked=!1,this._indexOfHost=0,this.verticesIndices=null,this._mesh=e}r(e,"laya.d3.resource.models.SubMesh");var t=e.prototype;return i.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t.getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vb:null},t.getIndexBuffer=function(){return this._ib},t._getShader=function(e,t,i){if(!i)return null;var n=0,r=t.vertexDeclaration.shaderAttribute;r.UV&&(n|=i.shaderDef),r.COLOR&&(n|=32),e.scene.enableFog&&(n|=131072),n>0&&e.shaderDefs.addInt(n);var a=i.getShader(e);return a},t._render=function(e){var t=(this._mesh,this._vb),i=this._ib,n=this.getMaterial(e.owner.meshRender.shadredMaterials);if(n.normalTexture&&!t.vertexDeclaration.shaderAttribute.TANGENT0){var r=t.getData(),a=Se.generateTangent(r,t.vertexDeclaration.vertexStride/4,t.vertexDeclaration.shaderAttribute.POSITION[4]/4,t.vertexDeclaration.shaderAttribute.UV[4]/4,i.getData()),s=Se.getVertexTangentDeclaration(t.vertexDeclaration.getVertexElements()),o=Ye.create(s,35044);o.setData(a),t.dispose(),t=this._vb=o,this._bufferUsage.TANGENT0=o}if(null===i)return!1;if(t._bind(),i._bind(),n){var h=this._getShader(e,t,n),l=e.shaderValue.length;e.shaderValue.pushArray(t.vertexDeclaration.shaderValues);var u=e.owner,c=u.transform.worldMatrix;if(e.shaderValue.pushValue("MATRIX1",c.elements,-1),Te.multiply(e.projectionViewMatrix,c,e.owner.wvpMatrix),e.shaderValue.pushValue("MVPMATRIX",u.wvpMatrix.elements,-1),!n.upload(e,this._finalBufferUsageDic,h))return e.shaderValue.length=l,!1;e.shaderValue.length=l}return e.context.drawElements(4,this._numberIndices,5123,0),A.drawCall++,A.trianglesFaces+=this._numberIndices/3,!0},t._setBoneDic=function(e){this._boneIndex=e,this._mesh.disableUseFullBone()},t.getMaterial=function(e){return this._materialIndex>=0?e[this._materialIndex]:null},t.setIB=function(e,t){this._ib=e,this._numberIndices=t},t.getIB=function(){return this._ib},t.setVB=function(e){this._vb=e},t.getVB=function(){return this._vb},t.getBakedVertexs=function(e,t){if(0===e){for(var i=4,n=this._vb,r=n.getData().slice(),a=n.vertexDeclaration,s=a.shaderAttribute.POSITION[4]/i,o=a.shaderAttribute.NORMAL[4]/i,h=0;h<r.length;h+=a.vertexStride/i){var l=h+s;Se.transformVector3ArrayToVector3ArrayCoordinate(r,l,t,r,l),Se.transformVector3ArrayToVector3ArrayCoordinate(r,o,t,r,o)}return this._isVertexbaked=!0,r}return null},t.getBakedIndices=function(){return this._ib.getData()},t.dispose=function(){this._mesh=null,this._boneIndex=null,
this._ib.dispose(),this._vb.dispose()},a(0,t,"VertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return this._indexOfHost}),a(0,t,"material",function(){return this._materialIndex},function(e){this._materialIndex=e}),a(0,t,"triangleCount",function(){return this._ib.indexCount/3}),e}(),we=function(){function e(e){this.texture=null,this._vertices=null,this._vertexBuffer=null,this._floatCountPerVertex=6,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this._posShaderValue=[3,5126,!1,24,0],this._uvShaderValue=[2,5126,!1,24,12],this._timeShaderValue=[1,5126,!1,24,20],this._sharderNameID=0,this._shader=null,this.numPositionMode=0,this.numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastAddTime=NaN,this.scLeft=null,this.scRight=null,this.setting=null,this._tempVector0=new Ee,this._tempVector1=new Ee,this._tempVector2=new Ee,this._tempVector3=new Ee,this._albedo=new Ve(1,1,1,1),this._shaderValue=new P,this.posModeLastPosition0=new Ee,this.posModeLastPosition1=new Ee,this.posModePosition0=new Ee,this.posModePosition1=new Ee,this.posVelModePosition0=new Ee,this.posVelModeVelocity0=new Ee,this.posVelModePosition1=new Ee,this.posVelModeVelocity1=new Ee,this._lastAddPos0=new Ee,this._lastAddPos1=new Ee,this._currentTime=this._lastTime=0,this.setting=e,this.initialize(),this.loadShaderParams(),this.loadContent(),this.scLeft=new U,this.scRight=new U}r(e,"laya.d3.resource.tempelet.GlitterTemplet");var t=e.prototype;return i.imps(t,{"laya.d3.core.render.IRenderable":!0}),t.getBakedVertexs=function(e,t){return null},t.getBakedIndices=function(){return null},t.getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t.getIndexBuffer=function(){return null},t.initialize=function(){this._vertices=new Float32Array(this.setting.maxSegments*this._floatCountPerVertex*2)},t.loadContent=function(){this._vertexBuffer=Ye.create(Y.vertexDeclaration,2*this.setting.maxSegments,35048)},t.loadShaderParams=function(){if(this._sharderNameID=E.nameKey.get("GLITTER"),this.setting.texturePath){this._shaderValue.pushValue("DIFFUSETEXTURE",null,-1);var e=this;i.loader.load(this.setting.texturePath,f.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,t.bitmap.repeat=!0,e.texture=t}))}},t.update=function(e){this._currentTime+=e/1e3,this.retireActiveGlitters(),this.freeRetiredGlitters(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this.updateTextureCoordinate()},t._render=function(e){if(this.texture&&this.texture.loaded){if(this.update(e.elapsedTime),this._firstNewElement!=this._firstFreeElement&&this.addNewGlitterSegementToVertexBuffer(),this._firstActiveElement!=this._firstFreeElement){S.mainContext;this._vertexBuffer.bindWithIndexBuffer(null),this._shader=this.getShader(e);var t=this._shaderValue.length;this._shaderValue.pushArray(e.shaderValue),this._shaderValue.pushArray(this._vertexBuffer.vertexDeclaration.shaderValues),this._shaderValue.pushValue("UNICOLOR",this.setting.color.elements,-1),this._shaderValue.pushValue("MVPMATRIX",e.projectionViewMatrix.elements,-1),this._shaderValue.pushValue("DURATION",this.setting.lifeTime,-1),this._shaderValue.pushValue("ALBEDO",this._albedo.elements,-1),this._shaderValue.pushValue("CURRENTTIME",this._currentTime,-1),this._shaderValue.data[1][0]=this.texture.source,this._shaderValue.data[1][1]=this.texture.bitmap.id,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=t;var i=0;this._firstActiveElement<this._firstFreeElement?(i=2*(this._firstFreeElement-this._firstActiveElement),S.mainContext.drawArrays(5,2*this._firstActiveElement,i),A.trianglesFaces+=i-2,A.drawCall++):(i=2*(this.setting.maxSegments-this._firstActiveElement),S.mainContext.drawArrays(5,2*this._firstActiveElement,i),A.trianglesFaces+=i-2,A.drawCall++,this._firstFreeElement>0&&(i=2*this._firstFreeElement,S.mainContext.drawArrays(5,0,i),A.trianglesFaces+=i-2,A.drawCall++))}this._drawCounter++}return!0},t.addVertexPositionVelocity=function(e,t,i,n){if(0===this.numPositionVelocityMode)this.numPositionVelocityMode++;else{var r=new Ee;Ee.subtract(e,this.posVelModePosition0,r);var a=Ee.scalarLength(r);Ee.subtract(i,this.posVelModePosition1,r);var s=Ee.scalarLength(r),o=0;if(a<this.setting.minSegmentDistance&&s<this.setting.minSegmentDistance)return;if(o=1+Math.floor(Math.max(a,s)/this.setting.minInterpDistance),1===o)this.addGlitter(e,i,this._currentTime);else{o=Math.min(o,this.setting.maxSlerpCount),this.scLeft.Init(this.posVelModePosition0,this.posVelModeVelocity0,e,t),this.scRight.Init(this.posVelModePosition1,this.posVelModeVelocity1,i,n);for(var h=1/o,l=h,u=1;o>=u;u++){var c=this._tempVector0;this.scLeft.Slerp(l,c);var _=this._tempVector1;this.scRight.Slerp(l,_);var d=this._lastTime+(this._currentTime-this._lastTime)*u/o;this.addGlitter(c,_,d),l+=h}}}this._lastTime=this._currentTime,e.cloneTo(this.posVelModePosition0),t.cloneTo(this.posVelModeVelocity0),i.cloneTo(this.posVelModePosition1),n.cloneTo(this.posVelModeVelocity1)},t.addVertexPosition=function(e,t){if(this.numPositionMode<2)0===this.numPositionMode?(e.cloneTo(this.posModeLastPosition0),t.cloneTo(this.posModeLastPosition1)):(e.cloneTo(this.posModePosition0),t.cloneTo(this.posModePosition1)),this.numPositionMode++;else{var i=this._tempVector2;this.CalcVelocity(e,this.posModeLastPosition0,i);var n=this._tempVector3;this.CalcVelocity(t,this.posModeLastPosition1,n),this.addVertexPositionVelocity(this.posModePosition0,i,this.posModePosition1,n),this.posModePosition0.cloneTo(this.posModeLastPosition0),this.posModePosition1.cloneTo(this.posModeLastPosition1),e.cloneTo(this.posModePosition0),t.cloneTo(this.posModePosition1)}},t.addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.setting.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},t.updateTextureCoordinate=function(){this._firstActiveElement<this._firstFreeElement?this.updateTextureCoordinateData(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this.updateTextureCoordinateData(this._firstActiveElement,2*(this.setting.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this.updateTextureCoordinateData(0,2*this._firstFreeElement))},t.updateTextureCoordinateData=function(e,t){for(var i=0;t>i;i+=2){var n=(2*e+i+0)*this._floatCountPerVertex,r=(2*e+i+1)*this._floatCountPerVertex;this._vertices[n+3]=this._vertices[r+3]=(this._vertices[n+5]-this._currentTime)/this.setting.lifeTime}},t.retireActiveGlitters=function(){for(var e=this.setting.lifeTime;this._firstActiveElement!=this._firstNewElement;){var t=this._firstActiveElement*this._floatCountPerVertex*2+5,i=this._currentTime-this._vertices[t];if(e>i)break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.setting.maxSegments&&(this._firstActiveElement=0)}},t.freeRetiredGlitters=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*2+5];if(3>e)break;this._firstRetiredElement++,this._firstRetiredElement>=this.setting.maxSegments&&(this._firstRetiredElement=0)}},t.addGlitter=function(e,t,i){this._needPatch&&(this._needPatch=!1,this.addGlitter(this._lastAddPos0,this._lastAddPos1,this._lastAddTime));var n=this._firstFreeElement+1;if(n>=this.setting.maxSegments&&(n=0,e.cloneTo(this._lastAddPos0),t.cloneTo(this._lastAddPos1),this._lastAddTime=i,this._needPatch=!0),n!==this._firstRetiredElement){var r=e.elements,a=t.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;3>s;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=i;var h=o+this._floatCountPerVertex;for(s=0;3>s;s++)this._vertices[h+s]=a[s];this._vertices[h+3]=0,this._vertices[h+4]=1,this._vertices[h+5]=i,this._firstFreeElement=n}},t.CalcVelocity=function(e,t,i){Ee.subtract(e,t,i),Ee.scale(i,.5,i)},t.getShader=function(e){var t=e.shaderDefs,i=t._value,n=(t._value|e.shadingMode)+2e-4*this._sharderNameID;return this._shader=E.withCompile(this._sharderNameID,e.shadingMode,e.shaderDefs.toNameDic(),n,null),t._value=i,this._shader},a(0,t,"VertexBufferCount",function(){return 1}),a(0,t,"indexOfHost",function(){return 0}),a(0,t,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.setting.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),e}(),be=function(){function e(){}return r(e,"laya.d3.shader.Shader3D"),e.__init__=function(){e.SIMPLE=E.nameKey.add("SIMPLE"),e.TERRAIN=E.nameKey.add("TERRAIN"),e.PARTICLE=E.nameKey.add("PARTICLE"),e.U3DPARTICLE=E.nameKey.add("U3DPARTICLE"),e.GLITTER=E.nameKey.add("GLITTER"),e.SIMPLE_EFFECT=E.nameKey.add("SIMPLE_EFFECT"),E.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec=-normalize(dirLight.Direction);\n	\n	amb=matAmb*dirLight.Ambient;\n	\n	float  diffuseFactor=dot(lightVec, normal);\n	\n	if(diffuseFactor>0.0)\n	{\n	   vec3 v = reflect(-lightVec, normal);\n	   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n	   \n	   dif = diffuseFactor * matDif * dirLight.Diffuse;\n	   spec = specFactor * matSpe.rgb * dirLight.Specular;\n	}\n	\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec = poiLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > poiLight.Range )\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * poiLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if( diffuseFactor > 0.0 )\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * poiLight.Diffuse;\n		spec = specFactor * matSpe.rgb * poiLight.Specular;\n	}\n\n	float attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	amb = vec3(0.0);\n	dif =vec3(0.0);\n	spec= vec3(0.0);\n	vec3 lightVec = spoLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > spoLight.Range)\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * spoLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if(diffuseFactor > 0.0)\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * spoLight.Diffuse;\n		spec = specFactor * matSpe.rgb * spoLight.Specular;\n	}\n	\n	float spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n	float attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n	amb *= spot;\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n	vec3 normalT = 2.0*normalMapSample - 1.0;\n\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize( tangent- dot(tangent, N)*N);\n	vec3 B = cross(T, N);\n\n	mat3 TBN = mat3(T, B, N);\n\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n"),E.addInclude("VRHelper.glsl","\nvec4 DistortFishEye(vec4 p)\n{\n    vec2 v = p.xy / p.w;\n    float radius = length(v);// Convert to polar coords\n    if (radius > 0.0)\n    {\n      float theta = atan(v.y,v.x);\n      \n      radius = pow(radius, 0.93);// Distort:\n\n      v.x = radius * cos(theta);// Convert back to Cartesian\n      v.y = radius * sin(theta);\n      p.xy = v.xy * p.w;\n    }\n    return p;\n}");var t,i,n={a_Position:"POSITION",a_Color:"COLOR",a_Normal:"NORMAL",a_Texcoord0:"UV",a_Texcoord1:"UV1",a_TexcoordNext0:"NEXTUV",a_BoneWeights:"BLENDWEIGHT",a_BoneIndices:"BLENDINDICES",a_Tangent0:"TANGENT0",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_NormalTexture:"NORMALTEXTURE",u_AmbientTexture:"AMBIENTTEXTURE",u_ReflectTexture:"REFLECTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Bones:"MATRIXARRAY0",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Albedo:"ALBEDO",u_AlphaTestValue:"ALPHATESTVALUE",u_UVMatrix:"MATRIX2",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX","u_DirectionLight.Direction":"LIGHTDIRECTION","u_DirectionLight.Diffuse":"LIGHTDIRDIFFUSE","u_DirectionLight.Ambient":"LIGHTDIRAMBIENT","u_DirectionLight.Specular":"LIGHTDIRSPECULAR","u_PointLight.Position":"POINTLIGHTPOS","u_PointLight.Range":"POINTLIGHTRANGE","u_PointLight.Attenuation":"POINTLIGHTATTENUATION","u_PointLight.Diffuse":"POINTLIGHTDIFFUSE","u_PointLight.Ambient":"POINTLIGHTAMBIENT","u_PointLight.Specular":"POINTLIGHTSPECULAR",u_MaterialDiffuse:"MATERIALDIFFUSE",u_MaterialAmbient:"MATERIALAMBIENT",u_MaterialSpecular:"MATERIALSPECULAR",u_MaterialReflect:"MATERIALREFLECT","u_SpotLight.Position":"SPOTLIGHTPOS","u_SpotLight.Direction":"SPOTLIGHTDIRECTION","u_SpotLight.Range":"SPOTLIGHTRANGE","u_SpotLight.Spot":"SPOTLIGHTSPOT","u_SpotLight.Attenuation":"SPOTLIGHTATTENUATION","u_SpotLight.Diffuse":"SPOTLIGHTDIFFUSE","u_SpotLight.Ambient":"SPOTLIGHTAMBIENT","u_SpotLight.Specular":"SPOTLIGHTSPECULAR"};t='#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#include?VR "VRHelper.glsl";\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM\n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_ToEye;\nvarying vec3 v_Normal;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n \n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  #ifdef BONE\n  vec3 normal=normalize( mat3(u_WorldMat*skinTransform)*a_Normal);\n  #else\n  vec3 normal=normalize( mat3(u_WorldMat)*a_Normal);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_Normal=normal;\n  #endif\n#endif\n \n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  v_Diffuse=vec3(0.0);\n  v_Ambient=vec3(0.0);\n  v_Specular=vec3(0.0);\n  vec3 dif, amb, spe;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  #ifdef BONE\n  vec3 positionWorld=(u_WorldMat*position).xyz;\n  #else\n  vec3 positionWorld=(u_WorldMat*a_Position).xyz;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nvec3 toEye;\n  #ifdef FOG\n  toEye=u_CameraPos-positionWorld;\n  v_ToEyeLength=length(toEye);\n  toEye/=v_ToEyeLength;\n  #else\n  toEye=normalize(u_CameraPos-positionWorld);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_ToEye=toEye;\n  #endif\n#endif\n \n#ifdef DIRECTIONLIGHT\ncomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\ncomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\nComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n  \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_Normal;\nvarying vec3 v_ToEye;\n#endif\n\n\nvoid main()\n{\n #ifdef DIFFUSEMAP&&!COLOR\n gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n #endif \n \n #ifdef COLOR&&!DIFFUSEMAP\n gl_FragColor=v_Color;\n #endif \n \n #ifdef DIFFUSEMAP&&COLOR\n vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n gl_FragColor=texColor*v_Color;\n #endif\n \n #ifdef !DIFFUSEMAP&&!COLOR\n gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n #endif \n \n #ifdef AMBIENTMAP\n gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n #endif \n \n gl_FragColor=gl_FragColor*u_Albedo;\n  \n #ifdef ALPHATEST\n   if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n #endif\n \n \n #ifdef REFLECTMAP\n vec3 normal=normalize(v_Normal);\n #endif 	\n\n  \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n   #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n   vec3 specular =v_Specular*texture2D(u_SpecularTexture,v_Texcoord0).rgb;\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+specular,gl_FragColor.a);\n   #else\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+v_Specular,gl_FragColor.a);\n   #endif\n #endif\n \n #ifdef REFLECTMAP\n vec3 incident = -v_ToEye;\n vec3 reflectionVector = reflect(incident,v_Normal);\n vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n #endif\n \n #ifdef FOG\n float lerpFact=clamp((v_ToEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n #endif\n}\n\n",E.preCompile(e.SIMPLE,4096,t,i,n),t='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP)&&NORMALMAP\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n\n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n mat3 worldMat;\n   #ifdef BONE\n   worldMat=mat3(u_WorldMat*skinTransform);\n   #else\n   worldMat=mat3(u_WorldMat);\n   #endif  \n v_Normal=worldMat*a_Normal;\n   #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n   v_Tangent0=worldMat*a_Tangent0;\n   #endif\n #endif\n \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG\n   #ifdef BONE\n   v_PositionWorld=(u_WorldMat*position).xyz;\n   #else\n   v_PositionWorld=(u_WorldMat*a_Position).xyz;\n   #endif\n #endif\n \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',i='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef !DIFFUSEMAP&&!COLOR\n  gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n  #endif \n  \n  #ifdef AMBIENTMAP\n  gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n  #endif \n  \n  gl_FragColor=gl_FragColor*u_Albedo;\n  \n  #ifdef ALPHATEST\n  if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n  #endif\n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  vec3 normal;\n    #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n    vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n	normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n	#else\n	normal = normalize(v_Normal);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  vec3 diffuse = vec3(0.0);\n  vec3 ambient = vec3(0.0);\n  vec3 specular= vec3(0.0);\n  vec3 dif, amb, spe;\n  #endif\n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  vec3 toEye;\n    #ifdef FOG\n	toEye=u_CameraPos-v_PositionWorld;\n    float toEyeLength=length(toEye);\n    toEye/=toEyeLength;\n    #else\n	toEye=normalize(u_CameraPos-v_PositionWorld);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT\n  computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n \n  #ifdef POINTLIGHT\n  computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n\n  #ifdef SPOTLIGHT\n  ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n  \n\n  \n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n    #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n    specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n  gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n  #endif\n  \n  #ifdef REFLECTMAP\n  vec3 incident = -toEye;\n  vec3 reflectionVector = reflect(incident,normal);\n  vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n  gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n  #endif\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n',E.preCompile(e.SIMPLE,8192,t,i,n),n={a_Position:"POSITION",a_Texcoord:"UV",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_BlendTexture:"DIFFUSETEXTURE",u_LayerTexture0:"NORMALTEXTURE",u_LayerTexture1:"SPECULARTEXTURE",u_LayerTexture2:"EMISSIVETEXTURE",u_LayerTexture3:"AMBIENTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Albedo:"ALBEDO",u_Ambient:"MATERIALAMBIENT",u_UVMatrix:"MATRIX2"},t='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_UVMatrix;\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\nattribute vec2 a_Texcoord;\nvarying vec2 v_Texcoord;\nvarying vec2 v_TiledTexcoord;\n#endif\n\n#ifdef FOG\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef VR\n gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n #else\n gl_Position = u_MvpMatrix * a_Position;\n #endif\n \n #ifdef FOG\n v_PositionWorld=(u_WorldMat*a_Position).xyz;\n #endif\n \n #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n v_Texcoord=a_Texcoord;\n v_TiledTexcoord=(u_UVMatrix*vec4(a_Texcoord,0.0,1.0)).xy;\n #endif\n}',i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform vec3 u_Ambient;\n\n#ifdef FOG\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  varying vec2 v_Texcoord;\n  varying vec2 v_TiledTexcoord;\n  uniform sampler2D u_BlendTexture;\n  uniform sampler2D u_LayerTexture0;\n  uniform sampler2D u_LayerTexture1;\n  uniform sampler2D u_LayerTexture2;\n  uniform sampler2D u_LayerTexture3;\n#endif\n\nvoid main()\n{	\n  #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  vec4 blend=texture2D(u_BlendTexture, v_Texcoord);\n  vec4 c0=texture2D(u_LayerTexture0, v_TiledTexcoord);\n  vec4 c1=texture2D(u_LayerTexture1, v_TiledTexcoord);\n  vec4 c2=texture2D(u_LayerTexture2, v_TiledTexcoord);\n  vec4 c3=texture2D(u_LayerTexture3, v_TiledTexcoord);\n  vec4 texColor = c0;\n  texColor = mix(texColor, c1, blend.r);\n  texColor = mix(texColor, c2, blend.g);\n  texColor = mix(texColor, c3, blend.b);\n  gl_FragColor=vec4(texColor.rgb*u_Ambient.rgb*blend.a,1.0);\n  gl_FragColor=gl_FragColor*u_Albedo;\n  #endif \n  \n  #ifdef FOG\n  vec3 toEye=u_CameraPos-v_PositionWorld;\n  float toEyeLength=length(toEye);\n  \n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",E.preCompile(e.TERRAIN,4096,t,i,n),E.preCompile(e.TERRAIN,8192,t,i,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",
a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"},E.preCompile(e.PARTICLE,4096,x.vs,x.ps,n),E.preCompile(e.PARTICLE,8192,x.vs,x.ps,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"},E.preCompile(e.U3DPARTICLE,4096,x.vs,x.ps,n),E.preCompile(e.U3DPARTICLE,8192,x.vs,x.ps,n),n={a_Position:"POSITION",a_Texcoord0:"UV",a_Time:"TIME",u_Texture:"DIFFUSETEXTURE",u_MvpMatrix:"MVPMATRIX",u_Albedo:"ALBEDO",u_CurrentTime:"CURRENTTIME",u_Color:"UNICOLOR",u_Duration:"DURATION"},t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{	\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",E.preCompile(e.GLITTER,4096,t,i,n),E.preCompile(e.GLITTER,8192,t,i,n),n={a_Position:"POSITION",a_Color:"COLOR",a_Texcoord0:"UV",a_TexcoordNext0:"NEXTUV",a_Texcoord1:"UV1",a_TexcoordNext1:"NEXTUV1",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_MvpMatrix:"MVPMATRIX",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Albedo:"ALBEDO",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX"},t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",E.preCompile(e.SIMPLE_EFFECT,4096,t,i,n),t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",E.preCompile(e.SIMPLE_EFFECT,8192,t,i,n)},e.SIMPLE=0,e.TERRAIN=0,e.PARTICLE=0,e.U3DPARTICLE=0,e.GLITTER=0,e.SIMPLE_EFFECT=0,e}(),Pe=function(){function e(){}return r(e,"laya.d3.utils.Picker"),e.calculateCursorRay=function(t,i,n,r,a,s){var o=t.elements[0],h=t.elements[1],l=e._tempVector30,u=l.elements;u[0]=o,u[1]=h,u[2]=i.minDepth;var c=e._tempVector31,_=c.elements;_[0]=o,_[1]=h,_[2]=i.maxDepth;var d=s.origin,f=e._tempVector32;i.unprojectFromWVP(l,n,r,a,d),i.unprojectFromWVP(c,n,r,a,f);var m=s.direction.elements;m[0]=f.x-d.x,m[1]=f.y-d.y,m[2]=f.z-d.z,Ee.normalize(s.direction,s.direction)},e.rayIntersectsPositionsAndIndices=function(e,t,i,n,r,a){for(var s=Number.MAX_VALUE,o=0;o<i.length;o+=3){var h=t[i[o+0]],l=t[i[o+1]],u=t[i[o+2]],c=laya.d3.utils.Picker.rayIntersectsTriangle(e,h,l,u);!isNaN(c)&&s>c&&(s=c,h.cloneTo(n),l.cloneTo(r),u.cloneTo(a))}return s},e.rayIntersectsTriangle=function(t,i,n,r){var a,s=e._tempVector30,o=e._tempVector31;Ee.subtract(n,i,s),Ee.subtract(r,i,o);var h=e._tempVector32;Ee.cross(t.direction,o,h);var l;if(l=Ee.dot(s,h),l>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return a=Number.NaN;var u=1/l,c=e._tempVector33;Ee.subtract(t.origin,i,c);var _;if(_=Ee.dot(c,h),_*=u,0>_||_>1)return a=Number.NaN;var d=e._tempVector34;Ee.cross(c,s,d);var f;if(f=Ee.dot(t.direction,d),f*=u,0>f||_+f>1)return a=Number.NaN;var m;return m=Ee.dot(o,d),m*=u,a=0>m?Number.NaN:m},n(e,["_tempVector30",function(){return this._tempVector30=new Ee},"_tempVector31",function(){return this._tempVector31=new Ee},"_tempVector32",function(){return this._tempVector32=new Ee},"_tempVector33",function(){return this._tempVector33=new Ee},"_tempVector34",function(){return this._tempVector34=new Ee}]),e}(),Re=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}r(e,"laya.d3.utils.Size");var t=e.prototype;return a(0,t,"width",function(){return-1===this._width?W.clientWidth:this._width}),a(0,t,"height",function(){return-1===this._height?W.clientHeight:this._height}),a(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),Se=function(){function e(){}return r(e,"laya.d3.utils.Utils3D"),e._getTexturePath=function(e){var t=e.length-4;return e.indexOf(".dds")!=t&&e.indexOf(".tga")!=t&&e.indexOf(".exr")!=t&&e.indexOf(".DDS")!=t&&e.indexOf(".TGA")!=t&&e.indexOf(".EXR")!=t||(e=e.substr(0,t)+".png"),e=b.formatURL(e)},e._rotationTransformScaleSkinAnimation=function(t,i,n,r,a,s,o,h,l,u,c,_){var d=e._tempArray16_0,f=e._tempArray16_1,m=e._tempArray16_2,p=r+r,v=a+a,g=s+s,x=r*p,T=a*p,C=a*v,I=s*p,D=s*v,M=s*g,E=o*p,V=o*v,y=o*g;d[15]=1,d[0]=1-C-M,d[1]=T+y,d[2]=I-V,d[4]=T-y,d[5]=1-x-M,d[6]=D+E,d[8]=I+V,d[9]=D-E,d[10]=1-x-C,f[15]=1,f[0]=h,f[5]=l,f[10]=u;var A,w,b,P,R;for(A=0;4>A;A++)w=d[A],b=d[A+4],P=d[A+8],R=d[A+12],m[A]=w,m[A+4]=b,m[A+8]=P,m[A+12]=w*t+b*i+P*n+R;for(A=0;4>A;A++)w=m[A],b=m[A+4],P=m[A+8],R=m[A+12],c[A+_]=w*f[0]+b*f[1]+P*f[2]+R*f[3],c[A+_+4]=w*f[4]+b*f[5]+P*f[6]+R*f[7],c[A+_+8]=w*f[8]+b*f[9]+P*f[10]+R*f[11],c[A+_+12]=w*f[12]+b*f[13]+P*f[14]+R*f[15]},e._parseHierarchyProp=function(e,t,i){switch(t){case"translate":e.transform.localPosition=new Ee(i[0],i[1],i[2]);break;case"rotation":e.transform.localRotation=new Ie(i[0],i[1],i[2],i[3]);break;case"scale":e.transform.localScale=new Ee(i[0],i[1],i[2])}},e._parseHierarchyNode=function(e){return e?new Qe(Ke.load(e.loadPath)):new Ge},e._parseMaterial=function(t,n,r){switch(n){case"ambientColor":t.ambientColor=new Ee(r[0],r[1],r[2]);break;case"diffuseColor":t.diffuseColor=new Ee(r[0],r[1],r[2]);break;case"specularColor":t.specularColor=new Ve(r[0],r[1],r[2],r[3]);break;case"reflectColor":t.reflectColor=new Ee(r[0],r[1],r[2]);break;case"diffuseTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.diffuseTexture=e}));break;case"normalTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.normalTexture=e}));break;case"specularTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.specularTexture=e}));break;case"emissiveTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.emissiveTexture=e}));break;case"ambientTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.ambientTexture=e}));break;case"reflectTexture":r.texture2D&&i.loader.load(e._getTexturePath(r.texture2D),f.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,e.bitmap.repeat=!0,t.reflectTexture=e}))}},e._computeSkinAnimationData=function(e,t,i,n,r){var a,s,o=0,h=0,l=i.length/2,u=e.length;for(a=0;u>a;o+=e[a].keyframeWidth,h+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],n,h),0!=a&&(s=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,s,n,h,n,h));for(a=0;l>a;a+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(n,a,i,l+a,r,a)},e._computeRootAnimationData=function(e,t,i){for(var n=0,r=0,a=0,s=e.length;s>n;r+=e[n].keyframeWidth,a+=16,n++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],i,a)},e.generateTangent=function(t,i,n,r,a){for(var s=3,o=i+s,h=new Float32Array(o*(t.length/i)),l=0;l<a.length;l+=3){var u=a[l+0],c=a[l+1],_=a[l+2],d=i*u+n,f=e._tempVector3_0;f.x=t[d+0],f.y=t[d+1],f.z=t[d+2];var m=i*c+n,p=e._tempVector3_1;p.x=t[m+0],p.y=t[m+1],p.z=t[m+2];var v=i*_+n,g=e._tempVector3_2;g.x=t[v+0],g.y=t[v+1],g.z=t[v+2];var x=i*u+r,T=t[x+0],C=t[x+1],I=i*c+r,D=t[I+0],M=t[I+1],E=i*_+r,V=t[E+0],y=t[E+1],A=e._tempVector3_3;Ee.subtract(p,f,A);var w=e._tempVector3_4;Ee.subtract(g,f,w),Ee.scale(A,y-C,A),Ee.scale(w,M-C,w);var b=e._tempVector3_5;Ee.subtract(A,w,b),Ee.scale(b,1/((D-T)*(y-C)-(M-C)*(V-T)),b);var P=0;for(P=0;i>P;P++)h[o*u+P]=t[i*u+P];for(P=0;s>P;P++)h[o*u+i+P]=+b.elements[P];for(P=0;i>P;P++)h[o*c+P]=t[i*c+P];for(P=0;s>P;P++)h[o*c+i+P]=+b.elements[P];for(P=0;i>P;P++)h[o*_+P]=t[i*_+P];for(P=0;s>P;P++)h[o*_+i+P]=+b.elements[P]}for(l=0;l<h.length;l+=o){var R=o*l+i,S=e._tempVector3_6;S.x=h[R+0],S.y=h[R+1],S.z=h[R+2],Ee.normalize(S,S),h[R+0]=S.x,h[R+1]=S.y,h[R+2]=S.z}return h},e.getVertexTangentDeclaration=function(e){for(var t=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=0;o<e.length;o++)switch(e[o].elementUsage){case"POSITION":t=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var h;return t&&i&&n&&r&&a&&s?h=se.vertexDeclaration:t&&i&&r&&a&&s?h=_e.vertexDeclaration:t&&i&&n&&a&&s?h=ee.vertexDeclaration:t&&i&&n&&r?h=oe.vertexDeclaration:t&&i&&r?h=de.vertexDeclaration:t&&i&&n&&(h=te.vertexDeclaration),h},e.mulMatrixByArray=function(t,i,n,r,a,s){var o,h,l,u,c;if(a===n){for(n=e._tempArray16_3,o=0;16>o;++o)n[o]=a[s+o];r=0}for(o=0;4>o;o++)h=t[i+o],l=t[i+o+4],u=t[i+o+8],c=t[i+o+12],a[s+o]=h*n[r+0]+l*n[r+1]+u*n[r+2]+c*n[r+3],a[s+o+4]=h*n[r+4]+l*n[r+5]+u*n[r+6]+c*n[r+7],a[s+o+8]=h*n[r+8]+l*n[r+9]+u*n[r+10]+c*n[r+11],a[s+o+12]=h*n[r+12]+l*n[r+13]+u*n[r+14]+c*n[r+15]},e.mulMatrixByArrayFast=function(e,t,i,n,r,a){var s,o,h,l,u;for(s=0;4>s;s++)o=e[t+s],h=e[t+s+4],l=e[t+s+8],u=e[t+s+12],r[a+s]=o*i[n+0]+h*i[n+1]+l*i[n+2]+u*i[n+3],r[a+s+4]=o*i[n+4]+h*i[n+5]+l*i[n+6]+u*i[n+7],r[a+s+8]=o*i[n+8]+h*i[n+9]+l*i[n+10]+u*i[n+11],r[a+s+12]=o*i[n+12]+h*i[n+13]+l*i[n+14]+u*i[n+15]},e.createAffineTransformationArray=function(e,t,i,n,r,a,s,o,h,l,u,c){var _=n+n,d=r+r,f=a+a,m=n*_,p=n*d,v=n*f,g=r*d,x=r*f,T=a*f,C=s*_,I=s*d,D=s*f;u[c+0]=(1-(g+T))*o,u[c+1]=(p+D)*o,u[c+2]=(v-I)*o,u[c+3]=0,u[c+4]=(p-D)*h,u[c+5]=(1-(m+T))*h,u[c+6]=(x+C)*h,u[c+7]=0,u[c+8]=(v+I)*l,u[c+9]=(x-C)*l,u[c+10]=(1-(m+g))*l,u[c+11]=0,u[c+12]=e,u[c+13]=t,u[c+14]=i,u[c+15]=1},e.transformVector3ArrayToVector3ArrayCoordinate=function(t,i,n,r,a){var s=e._tempArray4_0,o=t[i+0],h=t[i+1],l=t[i+2],u=n.elements;s[0]=o*u[0]+h*u[4]+l*u[8]+u[12],s[1]=o*u[1]+h*u[5]+l*u[9]+u[13],s[2]=o*u[2]+h*u[6]+l*u[10]+u[14],s[3]=1/(o*u[3]+h*u[7]+l*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},e.convert3DCoordTo2DScreenCoord=function(e,t){var i=e.elements,n=t.elements;n[0]=-W.clientWidth/2+i[0],n[1]=W.clientHeight/2-i[1],n[2]=i[2]},e._tempVector3_0=new Ee,e._tempVector3_1=new Ee,e._tempVector3_2=new Ee,e._tempVector3_3=new Ee,e._tempVector3_4=new Ee,e._tempVector3_5=new Ee,e._tempVector3_6=new Ee,e._tempArray4_0=new Float32Array(4),e._tempArray16_0=new Float32Array(16),e._tempArray16_1=new Float32Array(16),e._tempArray16_2=new Float32Array(16),e._tempArray16_3=new Float32Array(16),n(e,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),e}(),Oe=(function(){function e(){}return r(e,"Laya3D"),e.init=function(t,n,r){return void 0===r&&(r=!1),S.enable()?(v.parserMap={TextureCube:e._loadTextureCube},M.changeWebGLSize=function(e,t){S.onStageResize(e,t),W.clientWidth=e,W.clientHeight=t},c.isAntialias=r,C.is3DMode=!0,i.init(t,n),G.__init__(),Be.__init__(),be.__init__(),Oe.__init__(),void e._regClassforJson()):void alert("Laya3D init err,must support webGL!")},e._regClassforJson=function(){u.regClass("Sprite3D",Ge),u.regClass("MeshSprite3D",Qe),u.regClass("Material",Le)},e._loadTextureCube=function(e){i.loader.load(e.url,f.create(null,function(t){var i=b.basePath;b.basePath=b.getPath(b.formatURL(e.url));var n=new L([t.px,t.nx,t.py,t.ny,t.pz,t.nz],t.size);b.basePath=i,n.on("loaded",null,function(t){var i=new w(n);e.endLoad(i)})}),null,"json",1,!1)},e}(),function(e){function t(){this._id=0,this._cachedOwnerLayerMask=0,this._cachedOwnerEnable=!1,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._id=t._uniqueIDCounter,t._uniqueIDCounter++}r(t,"laya.d3.component.Component3D",e);var n=t.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0}),n._onLayerChanged=function(e){this._cachedOwnerLayerMask=e.mask},n._onEnableChanged=function(e){this._cachedOwnerEnable=e},n._initialize=function(e){this._owner=e,this.enable=!0,this.started=!1,this._cachedOwnerLayerMask=e.layer.mask,this._owner.on("layerchanged",this,this._onLayerChanged),this._cachedOwnerEnable=e.enable,this._owner.on("enabledchanged",this,this._onEnableChanged),this._load(e)},n._uninitialize=function(){this._unload(this.owner),this._owner.off("layerchanged",this,this._onLayerChanged),this._owner.off("enabledchanged",this,this._onEnableChanged),this._owner=null},n._load=function(e){},n._start=function(e){},n._update=function(e){},n._lateUpdate=function(e){},n._preRenderUpdate=function(e){},n._postRenderUpdate=function(e){},n._unload=function(e){},a(0,n,"id",function(){return this._id}),a(0,n,"owner",function(){return this._owner}),a(0,n,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enabledchanged",this._enable))}),a(0,n,"isActive",function(){return G.isActive(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),a(0,n,"isVisible",function(){return G.isVisible(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),t.__init__=function(){},t._uniqueIDCounter=1,t}(d)),Le=function(e){function t(){if(this._id=0,this._loaded=!0,this._renderQueue=0,this._renderMode=0,this._texturesloaded=!1,this._shader=null,this._sharderNameID=0,this._disableDefine=0,this._color=[],this._alphaTestValue=NaN,this._transformUV=null,this._shaderDef=0,this._isInstance=!1,this.name=null,t.__super.call(this),this._textures=[],this._texturesSharderIndex=[],this._otherSharderIndex=[],this._shaderValues=new P,this._albedo=new Ve(1,1,1,1),this._id=++t._uniqueIDCounter,this._id>t.maxMaterialCount)throw new Error("Material: Material count should not large than ",t.maxMaterialCount);this._color[0]=t.AMBIENTCOLORVALUE,this._color[1]=t.DIFFUSECOLORVALUE,this._color[2]=t.SPECULARCOLORVALUE,this._color[3]=t.REFLECTCOLORVALUE,this._pushShaderValue(0,"MATERIALAMBIENT",this._color[0].elements,this._id),this._pushShaderValue(1,"MATERIALDIFFUSE",this._color[1].elements,this._id),this._pushShaderValue(2,"MATERIALSPECULAR",this._color[2].elements,this._id),this._pushShaderValue(3,"MATERIALREFLECT",this._color[3].elements,this._id),this._pushShaderValue(5,"ALBEDO",this._albedo.elements,this._id),this.renderMode=1,this.alphaTestValue=.5}r(t,"laya.d3.core.material.Material",e);var i=t.prototype;return i._eventLoaded=function(){this._loaded=!0,this.event("loaded",this)},i._loadeCompleted=function(){return this._texturesloaded?!0:this.diffuseTexture&&!this.diffuseTexture.loaded?!1:this.normalTexture&&!this.normalTexture.loaded?!1:this.specularTexture&&!this.specularTexture.loaded?!1:this.emissiveTexture&&!this.emissiveTexture.loaded?!1:this.ambientTexture&&!this.ambientTexture.loaded?!1:this.reflectTexture&&!this.reflectTexture.loaded?!1:(this.diffuseTexture&&this._uploadTexture(0,this.diffuseTexture),this.normalTexture&&this._uploadTexture(1,this.normalTexture),this.specularTexture&&this._uploadTexture(2,this.specularTexture),this.emissiveTexture&&this._uploadTexture(3,this.emissiveTexture),this.ambientTexture&&this._uploadTexture(4,this.ambientTexture),this.reflectTexture&&this._uploadTexture(5,this.reflectTexture),this._texturesloaded=!0)},i._pushShaderValue=function(e,t,i,n){var r=this._shaderValues,a=this._otherSharderIndex[e];return a||(a=r.length+1,r.pushValue(t,null,-1),this._otherSharderIndex[e]=a),r.data[a][0]=i,r.data[a][1]=n,a},i._getShaderDefineValue=function(){return this._shaderDef=0,this.diffuseTexture&&(this._shaderDef|=1),this.normalTexture&&(this._shaderDef|=2),this.specularTexture&&(this._shaderDef|=4),this.emissiveTexture&&(this._shaderDef|=8),this.ambientTexture&&(this._shaderDef|=16),this.reflectTexture&&(this._shaderDef|=262144),this._transformUV&&(this._shaderDef|=16384),(3===this._renderMode||4===this._renderMode)&&(this._shaderDef|=2048),this._shaderDef},i._setTexture=function(e,t,i){var n=this._texturesSharderIndex[t];return!n&&e&&(n=this._shaderValues.length+1,this._shaderValues.pushValue(i,null,-1),this._texturesSharderIndex[t]=n),e&&(this._texturesloaded=!1),this._textures[t]=e,n},i._uploadTexture=function(e,t){var i=this._shaderValues,n=i.data[this._texturesSharderIndex[e]];n[0]=t.source,n[1]=t.bitmap.id},i.getTextureByIndex=function(e){return this._textures[e]},i.getShader=function(e){var t=e.shaderDefs,i=t._value;this._disableDefine&&(t._value=i&~this._disableDefine);var n=(t._value|e.shadingMode)+2e-4*this._sharderNameID;return this._shader=E.withCompile(this._sharderNameID,e.shadingMode,t.toNameDic(),n,null),t._value=i,this._shader},i.upload=function(e,t,i){if(!this._loadeCompleted())return!1;i||(i=this.getShader(e));var n=this._shaderValues,r=n.length;return n.pushArray(e.shaderValue),i.tag._uploadMaterialID!=A.loopCount&&(i.tag._uploadMaterialID=A.loopCount,n.pushArray(e.worldShaderValue)),i.uploadArray(n.data,n.length,t),n.length=r,!0},i.disableLight=function(){this._disableDefine|=448},i.disableDefine=function(e){this._disableDefine=e},i.setShaderName=function(e){this._sharderNameID=E.nameKey.get(e)},i.copy=function(e){return e._loaded=this._loaded,e._renderQueue=this._renderQueue,e._renderMode=this._renderMode,e._textures=this._textures,e._texturesSharderIndex=this._texturesSharderIndex,e._otherSharderIndex=this._otherSharderIndex,e._texturesloaded=this._texturesloaded,e._shader=this._shader,e._sharderNameID=this._sharderNameID,e._disableDefine=this._disableDefine,e._color=this._color,e._alphaTestValue=this._alphaTestValue,e._transformUV=this._transformUV,e._albedo=this._albedo,e._shaderDef=this._shaderDef,e.name=this.name,this._shaderValues.copyTo(e._shaderValues),e},a(0,i,"id",function(){return this._id}),a(0,i,"reflectTexture",function(){return this._textures[5]},function(e){this._setTexture(e,5,"REFLECTTEXTURE"),this._getShaderDefineValue()}),a(0,i,"specularTexture",function(){return this._textures[2]},function(e){this._setTexture(e,2,"SPECULARTEXTURE"),this._getShaderDefineValue()}),a(0,i,"loaded",function(){return this._loaded}),a(0,i,"renderQueue",function(){return this._renderQueue}),a(0,i,"alphaTestValue",function(){return this._alphaTestValue},function(e){this._alphaTestValue=e,this._pushShaderValue(7,"ALPHATESTVALUE",e,this._id)}),a(0,i,"renderMode",function(){return this._renderMode},function(e){switch(this._renderMode=e,e){case 0:this._renderQueue=0,this.event("renderqueuechanged",this);break;case 1:this._renderQueue=1,this.event("renderqueuechanged",this);break;case 2:this._renderQueue=2,this.event("renderqueuechanged",this);break;case 3:this._renderQueue=1,this.event("renderqueuechanged",this);break;case 4:this._renderQueue=2,this.event("renderqueuechanged",this);break;case 5:this._renderQueue=7,this.event("renderqueuechanged",this);break;case 6:this._renderQueue=8,this.event("renderqueuechanged",this);break;case 7:this._renderQueue=9,this.event("renderqueuechanged",this);break;case 8:this._renderQueue=10,this.event("renderqueuechanged",this);break;default:throw new Error("Material:renderMode value error.")}this._getShaderDefineValue()}),a(0,i,"shaderDef",function(){return this._shaderDef}),a(0,i,"albedo",null,function(e){this._albedo=e,this._pushShaderValue(5,"ALBEDO",this._albedo.elements,this._id)}),a(0,i,"diffuseTexture",function(){return this._textures[0]},function(e){this._setTexture(e,0,"DIFFUSETEXTURE"),this._getShaderDefineValue()}),a(0,i,"normalTexture",function(){return this._textures[1]},function(e){this._setTexture(e,1,"NORMALTEXTURE"),this._getShaderDefineValue()}),a(0,i,"emissiveTexture",function(){return this._textures[3]},function(e){this._setTexture(e,3,"EMISSIVETEXTURE"),this._getShaderDefineValue()}),a(0,i,"ambientTexture",function(){return this._textures[4]},function(e){this._setTexture(e,4,"AMBIENTTEXTURE"),this._getShaderDefineValue()}),a(0,i,"texturesCount",function(){return this._textures.length}),a(0,i,"ambientColor",null,function(e){this._color[0]=e,this._pushShaderValue(0,"MATERIALAMBIENT",e.elements,this._id)}),a(0,i,"diffuseColor",null,function(e){this._color[1]=e,this._pushShaderValue(1,"MATERIALDIFFUSE",e.elements,this._id)}),a(0,i,"specularColor",null,function(e){this._color[2]=e,this._pushShaderValue(2,"MATERIALSPECULAR",e.elements,this._id)}),a(0,i,"reflectColor",null,function(e){this._color[3]=e,this._pushShaderValue(3,"MATERIALREFLECT",e.elements,this._id)}),a(0,i,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e;var t=this._transformUV.matrix;this._pushShaderValue(6,"MATRIX2",t.elements,this._id),this._getShaderDefineValue()}),t.createFromFile=function(e,t){t._loaded=!1;var i=new v,n=function(i){var n=b.basePath;b.basePath=b.getPath(b.formatURL(e)),u.createByJson(i,t,null,f.create(null,Se._parseMaterial,null,!1)),b.basePath=n,t._eventLoaded()};i.once("complete",null,n),i.load(e,"json")},t._uniqueIDCounter=1,t.DIFFUSETEXTURE=0,t.NORMALTEXTURE=1,t.SPECULARTEXTURE=2,t.EMISSIVETEXTURE=3,t.AMBIENTTEXTURE=4,t.REFLECTTEXTURE=5,t.AMBIENTCOLOR=0,t.DIFFUSECOLOR=1,t.SPECULARCOLOR=2,t.REFLECTCOLOR=3,t.TRANSPARENT=4,t.ALBEDO=5,t.TRANSFORMUV=6,t.ALPHATESTVALUE=7,t.RENDERMODE_SKY=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=5,t.RENDERMODE_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_ADDTIVE=7,t.RENDERMODE_ADDTIVEDOUBLEFACE=8,n(t,["maxMaterialCount",function(){return this.maxMaterialCount=Math.floor(2147483.647)},"AMBIENTCOLORVALUE",function(){return this.AMBIENTCOLORVALUE=new Ee(.6,.6,.6)},"DIFFUSECOLORVALUE",function(){return this.DIFFUSECOLORVALUE=new Ee(1,1,1)},"SPECULARCOLORVALUE",function(){return this.SPECULARCOLORVALUE=new Ve(1,1,1,8)},"REFLECTCOLORVALUE",function(){return this.REFLECTCOLORVALUE=new Ee(1,1,1)}]),t}(d),Ne=function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}r(t,"laya.d3.core.MeshFilter",e);var i=t.prototype;return a(0,i,"sharedMesh",function(){return this._sharedMesh},function(e){this._sharedMesh=e,this.event("meshchanged",this)}),t}(d),Fe=function(e){function t(e){this._boundingObjectNeedChange=!1,this._owner=null,this._materials=null,this._frustumCulling=null,this._boundingSphere=null,this._boundingBox=null,this.castShadow=!1,this.receiveShadow=!1,t.__super.call(this),this._materials=[],this._boundingBox=new me(new Ee,new Ee),this._boundingSphere=new ve(new Ee,0),this._boundingObjectNeedChange=!0,this._owner=e,this.castShadow=!0,this.receiveShadow=!0,this._frustumCulling=new F,this._frustumCulling._component=this,this._frustumCulling._layerMask=this._owner.layer.mask,this._frustumCulling._ownerEnable=this._owner.enable,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._owner.on("layerchanged",this,this._onOwnerLayerChanged),this._owner.on("enabledchanged",this,this._onOwnerEnableChanged)}r(t,"laya.d3.core.MeshRender",e);var n=t.prototype;return i.imps(n,{"laya.resource.IDispose":!0}),n._onWorldMatNeedChange=function(){this._boundingObjectNeedChange=!0},n._onOwnerLayerChanged=function(e){this._frustumCulling._layerMask=e.mask},n._onOwnerEnableChanged=function(e){this._frustumCulling._ownerEnable=e},n._calculateBoundingObject=function(){if(this._boundingObjectNeedChange){if(null==this._owner.meshFilter.sharedMesh)this._boundingBox.toDefault(),this._boundingSphere.toDefault();else{var e=this._owner.meshFilter.sharedMesh._boundingSphere,t=NaN,i=this._owner.transform,n=i.scale;t=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z;var r=i.worldMatrix;Ee.transformCoordinate(e.center,r,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t;var a=this._owner.meshFilter.sharedMesh._boundingBox;Ee.transformCoordinate(a.min,r,this._boundingBox.min),Ee.transformCoordinate(a.max,r,this._boundingBox.max)}this._boundingObjectNeedChange=!1}},n.dispose=function(){this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._owner.off("layerchanged",this,this._onOwnerLayerChanged),this._owner.off("enabledchanged",this,this._onOwnerEnableChanged)},a(0,n,"material",function(){var e=this._materials[0];if(e&&!e._isInstance){var t=new Le;e.copy(t),t.name=t.name+"(Instance)",t._isInstance=!0,this._materials[0]=t}return this._materials[0]},function(e){var t=this._materials[0];this._materials[0]=e,this.event("materialchanged",[this,[t],[e]])}),a(0,n,"boundingBox",function(){return this._calculateBoundingObject(),this._boundingBox}),a(0,n,"materials",function(){for(var e=0,t=this._materials.length;t>e;e++){var i=this._materials[e];if(!i._isInstance){var n=new Le;i.copy(n),n.name=n.name+"(Instance)",n._isInstance=!0,this._materials[e]=n}}return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: materials value can't be null.");var t=this._materials;this._materials=e,this._owner._iAsyncLodingMeshMaterial=!1,this.event("materialchanged",[this,t.slice(),e.slice()])}),a(0,n,"shadredMaterial",function(){return this._materials[0]},function(e){var t=this._materials[0];this._materials[0]=e,this.event("materialchanged",[this,[t],[e]])}),a(0,n,"shadredMaterials",function(){var e=this._materials.slice();return e},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");var t=this._materials;this._materials=e,this._owner._iAsyncLodingMeshMaterial=!1,this.event("materialchanged",[this,t.slice(),e.slice()])}),a(0,n,"boundingSphere",function(){return this._calculateBoundingObject(),this._boundingSphere}),t}(d),Ue=function(e){function t(e){this._owner=null,this._preWorldTransformModifyID=-1,this._localUpdate=!1,this._worldUpdate=!0,this._parent=null,t.__super.call(this),this._tempMatrix0=new Te,this._tempQuaternion0=new Ie,this._tempVector30=new Ee,this._localPosition=new Ee,this._localRotation=new Ie(0,0,0,1),this._localScale=new Ee(1,1,1),this._localMatrix=new Te,this._position=new Ee,this._rotation=new Ie(0,0,0,1),this._scale=new Ee(1,1,1),this._worldMatrix=new Te,this._forward=new Ee,this._up=new Ee,this._right=new Ee,this._owner=e}r(t,"laya.d3.core.Transform3D",e);var i=t.prototype;return i._updateLocalMatrix=function(){Te.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},i._onLocalTransform=function(){this._localUpdate=!0},i._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._owner._childs.length;t>e;e++)this._owner._childs[e].transform._onWorldTransform()}},i.translate=function(e,t){void 0===t&&(t=!0),t?(Te.createFromQuaternion(this.localRotation,this._tempMatrix0),Ee.transformCoordinate(e,this._tempMatrix0,this._tempVector30),Ee.add(this.localPosition,this._tempVector30,this._localPosition),this.localPosition=this._localPosition):(Ee.add(this.position,e,this._position),this.position=this._position)},i.rotate=function(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!0);var n;i?n=e:(Ee.scale(e,Math.PI/180,this._tempVector30),n=this._tempVector30),Ie.createFromYawPitchRoll(n.y,n.x,n.z,this._tempQuaternion0),t?(Ie.multiply(this._localRotation,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Ie.multiply(this._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},a(0,i,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,i,"worldNeedUpdate",function(){return this._worldUpdate;
}),a(0,i,"position",function(){if(null!==this._parent){var e=this.worldMatrix.elements;this._position.elements[0]=e[12],this._position.elements[1]=e[13],this._position.elements[2]=e[14]}else this._localPosition.cloneTo(this._position);return this._position},function(e){null!==this._parent?(this._parent.worldMatrix.invert(this._tempMatrix0),Ee.transformCoordinate(e,this._tempMatrix0,this._localPosition),this.localPosition=this._localPosition):(e.cloneTo(this._localPosition),this.localPosition=this._localPosition)}),a(0,i,"worldMatrix",function(){return this._worldUpdate?(null!=this._parent?Te.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1,this._worldMatrix):this._worldMatrix},function(e){null===this._parent?this.localMatrix=e:(this._parent.worldMatrix.invert(this._localMatrix),Te.multiply(this._localMatrix,e,this._localMatrix),this.localMatrix=this._localMatrix)}),a(0,i,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decompose(this._localPosition,this._localRotation,this._localScale),this._onWorldTransform()}),a(0,i,"localRotation",function(){return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,i,"rotation",function(){return null!==this._parent?this.worldMatrix.decompose(this._position,this._rotation,this._scale):this._localRotation.cloneTo(this._rotation),this._rotation},function(e){null!==this._parent?(this._parent.rotation.invert(this._tempQuaternion0),Ie.multiply(e,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(e.cloneTo(this._localRotation),this.localRotation=this._localRotation)}),a(0,i,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._onLocalTransform(),this._onWorldTransform()}),a(0,i,"localRotationEuler",null,function(e){Ie.createFromYawPitchRoll(e.y,e.x,e.z,this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,i,"scale",function(){return null!==this._parent?Ee.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scale}),a(0,i,"rotationEuler",null,function(e){Ie.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),a(0,i,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),a(0,i,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),a(0,i,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),t}(d),Be=(function(e){function t(){this._rotation=0,this._matNeedUpdte=!1,t.__super.call(this),this._tempTitlingV3=new Ee,this._tempRotationMatrix=new Te,this._tempTitlingMatrix=new Te,this._matrix=new Te,this._offset=new Me,this._tiling=new Me}r(t,"laya.d3.core.TransformUV",e);var i=t.prototype;return i._updateMatrix=function(){this._tempTitlingV3.elements[0]=this._tiling.x,this._tempTitlingV3.elements[1]=this._tiling.y,this._tempTitlingV3.elements[2]=1,Te.createScaling(this._tempTitlingV3,this._tempTitlingMatrix),Te.createRotationZ(this._rotation,this._tempRotationMatrix),Te.multiply(this._tempRotationMatrix,this._tempTitlingMatrix,this._matrix);var e=this._matrix.elements;e[12]=this._offset.x,e[13]=this._offset.y,e[14]=0},a(0,i,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,i,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),a(0,i,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),a(0,i,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),t}(d),function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new Ee,this._resultVelocity=new Ee,this.centerPosition=new Ee,this.size=new Ee,this.velocity=new Ee,this.velocityAddVariance=new Ee,this._particle3D=e;for(var i=e.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.boxEmitterCenterPosition[n],this.size.elements[n]=i.boxEmitterSize[n],this.velocity.elements[n]=i.boxEmitterVelocity[n],this.velocityAddVariance.elements[n]=i.boxEmitterVelocityAddVariance[n];this.emissionRate=i.emissionRate}r(t,"laya.d3.core.particle.EmitterBox",e);var i=t.prototype;return i._randomPositionOnBox=function(){var e=this._resultPosition.elements,t=this.centerPosition.elements,i=this.size.elements;return e[0]=t[0]+i[0]*(Math.random()-.5),e[1]=t[1]+i[1]*(Math.random()-.5),e[2]=t[2]+i[2]*(Math.random()-.5),this._resultPosition},i._randomVelocityOnBox=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,i=this.velocityAddVariance.elements;return e[0]=t[0]+i[0]*Math.random(),e[1]=t[1]+i[1]*Math.random(),e[2]=t[2]+i[2]*Math.random(),this._resultVelocity},i.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnBox(),this._randomVelocityOnBox())},i.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(_),function(e){function t(e){this._settings=null,this._particle3D=null,t.__super.call(this),this._resultPosition=new Ee,this._resultVelocity=new Ee,this.position=new Ee,this.positionVariance=new Ee,this.velocity=new Ee,this.velocityAddVariance=new Ee,this._particle3D=e;for(var i=e.templet.settings,n=0;3>n;n++)this.position.elements[n]=i.pointEmitterPosition[n],this.positionVariance.elements[n]=i.pointEmitterPositionVariance[n],this.velocity.elements[n]=i.pointEmitterVelocity[n],this.velocityAddVariance.elements[n]=i.pointEmitterVelocityAddVariance[n];this.emissionRate=i.emissionRate}r(t,"laya.d3.core.particle.EmitterPoint",e);var i=t.prototype;return i._randomPositionOnPoint=function(){var e=this._resultPosition.elements,t=this.position.elements,i=this.positionVariance.elements;return e[0]=t[0]+i[0]*(Math.random()-.5)*2,e[1]=t[1]+i[1]*(Math.random()-.5)*2,e[2]=t[2]+i[2]*(Math.random()-.5)*2,this._resultPosition},i._randomVelocityOnPoint=function(){var e=this._resultVelocity.elements,t=this.velocity.elements,i=this.velocityAddVariance.elements;return e[0]=t[0]+i[0]*Math.random(),e[1]=t[1]+i[1]*Math.random(),e[2]=t[2]+i[2]*Math.random(),this._resultVelocity},i.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnPoint(),this._randomVelocityOnPoint())},i.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(_),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=30,this.velocity=0,this.velocityAddVariance=0,this.up=2,t.__super.call(this),this._resultPosition=new Ee,this._resultVelocity=new Ee,this._direction=new Ee,this.centerPosition=new Ee,this._particle3D=e;for(var i=e.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.ringEmitterCenterPosition[n];this.radius=i.ringEmitterRadius,this.velocity=i.ringEmitterVelocity,this.velocityAddVariance=i.ringEmitterVelocityAddVariance,this.emissionRate=i.emissionRate}r(t,"laya.d3.core.particle.EmitterRing",e);var i=t.prototype;return i._randomPointOnRing=function(){var e=Math.random()*Math.PI*2,t=Math.cos(e),i=Math.sin(e),n=this._resultPosition.elements,r=this.centerPosition.elements;switch(this.up){case 0:n[0]=r[0]+0,n[1]=r[1]+t*this.radius,n[2]=r[2]+i*this.radius;break;case 1:n[0]=r[0]+t*this.radius,n[1]=r[1]+0,n[2]=r[2]+i*this.radius;break;case 2:n[0]=r[0]+t*this.radius,n[1]=r[1]+i*this.radius,n[2]=r[2]+0}return this._resultPosition},i._randomVelocityOnRing=function(){var e=this._resultVelocity.elements;this._resultPosition.cloneTo(this._direction),Ee.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},i.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPointOnRing(),this._randomVelocityOnRing())},i.update=function(e){this.advanceTime(e/1e3)},t}(_),function(e){function t(e){this._settings=null,this._particle3D=null,this.radius=1,this.velocity=0,this.velocityAddVariance=0,t.__super.call(this),this._reultPosition=new Ee,this._resultVelocity=new Ee,this._direction=new Ee,this.centerPosition=new Ee,this._particle3D=e;for(var i=e.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.sphereEmitterCenterPosition[n];this.radius=i.sphereEmitterRadius,this.velocity=i.sphereEmitterVelocity,this.velocityAddVariance=i.sphereEmitterVelocityAddVariance,this.emissionRate=i.emissionRate}r(t,"laya.d3.core.particle.EmitterSphere",e);var i=t.prototype;return i._randomPositionOnSphere=function(){var e=Math.random()*Math.PI*2,t=Math.random()*Math.PI*2,i=Math.cos(e)*this.radius,n=Math.sin(e)*this.radius,r=Math.cos(t)*i,a=Math.sin(t)*i,s=this._reultPosition.elements,o=this.centerPosition.elements;return s[0]=o[0]+r,s[1]=o[1]+n,s[2]=o[2]+a,this._reultPosition},i._randomVelocityOnSphere=function(){var e=this._resultVelocity.elements;this._reultPosition.cloneTo(this._direction),Ee.normalize(this._direction,this._direction);var t=this._direction.elements;return e[0]=t[0]*(this.velocity+this.velocityAddVariance*Math.random()),e[1]=t[1]*(this.velocity+this.velocityAddVariance*Math.random()),e[2]=t[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},i.emit=function(){e.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnSphere(),this._randomVelocityOnSphere())},i.update=function(e){this.advanceTime(e.elapsedTime/1e3)},t}(_),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.glitter.SplineCurvePosition",e);var i=t.prototype;return i._CalcVelocity=function(e,t,i){Ee.subtract(e,t,i),Ee.scale(i,.5,i)},i.Init=function(t,i,n,r){this._CalcVelocity(i,t,this._tempVector30),this._CalcVelocity(r,n,this._tempVector31),e.prototype.Init.call(this,i,this._tempVector30,r,this._tempVector31)},t}(U),function(e){function t(){t.__super.call(this,t._name2int,t._int2name,t._int2nameMap)}return r(t,"laya.d3.shader.ShaderDefines3D",e),t.__init__=function(){t.reg("FSHIGHPRECISION",1048576),t.reg("DIFFUSEMAP",1),t.reg("NORMALMAP",2),t.reg("SPECULARMAP",4),t.reg("EMISSIVEMAP",8),t.reg("AMBIENTMAP",16),t.reg("REFLECTMAP",262144),t.reg("PARTICLE3D",32768),t.reg("COLOR",32),t.reg("VERTEXSHADERING",4096),t.reg("PIXELSHADERING",8192),t.reg("SKINNED",1024),t.reg("DIRECTIONLIGHT",64),t.reg("POINTLIGHT",128),t.reg("SPOTLIGHT",256),t.reg("BONE",512),t.reg("ALPHATEST",2048),t.reg("UVTRANSFORM",16384),t.reg("MIXUV",65536),t.reg("FOG",131072),t.reg("VR",524288)},t.reg=function(e,i){V._reg(e,i,t._name2int,t._int2name)},t.toText=function(e,t,i){return V._toText(e,t,i)},t.toInt=function(e){return V._toInt(e,t._name2int)},t.DIFFUSEMAP=1,t.NORMALMAP=2,t.SPECULARMAP=4,t.EMISSIVEMAP=8,t.AMBIENTMAP=16,t.REFLECTMAP=262144,t.VR=524288,t.FSHIGHPRECISION=1048576,t.UVTRANSFORM=16384,t.MIXUV=65536,t.FOG=131072,t.COLOR=32,t.DIRECTIONLIGHT=64,t.POINTLIGHT=128,t.SPOTLIGHT=256,t.BONE=512,t.SKINNED=1024,t.ALPHATEST=2048,t.PARTICLE3D=32768,t.VERTEXSHADERING=4096,t.PIXELSHADERING=8192,t._name2int={},t._int2name=[],t._int2nameMap=[],t}(V)),Ge=function(e){function t(e){this._id=0,this._enable=!1,this._layerMask=0,this._componentsMap=[],this.transform=null,this.isStatic=!1,t.__super.call(this),this._components=[],this._wvpMatrix=new Te;var i=this;e?this.name=e:this.name="Sprite3D-"+t._nameNumberCounter++,this._enable=!0,this._id=t._uniqueIDCounter,t._uniqueIDCounter++,this.layer=G.currentCreationLayer,this.transform=new Ue(this),this.on("added",this,function(){i.transform._parent=i._parent.transform}),this.on("removed",this,function(){i.transform._parent=null})}r(t,"laya.d3.core.Sprite3D",e);var n=t.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDispose":!0}),n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._clearSelfAndChildrenRenderObjects=function(){this._clearSelfRenderObjects();for(var e=0;e<this._childs.length;e++)this._childs[e]._clearSelfAndChildrenRenderObjects()},n._addSelfAndChildrenRenderObjects=function(){this._addSelfRenderObjects();for(var e=0;e<this._childs.length;e++)this._childs[e]._addSelfAndChildrenRenderObjects()},n._updateComponents=function(e){for(var t=0;t<this._components.length;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.isActive&&i._update(e)}},n._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.isActive&&i._lateUpdate(e)}},n._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var i=0;t>i;++i){var n=this._childs[i];n._update(e)}},n._getSortID=function(e,t){return 1e3*t.id+e.getVertexBuffer().vertexDeclaration.id},n._update=function(e){e.owner=this;var t=e.renderClip.view(this);t&&this._updateComponents(e),t&&this._lateUpdateComponents(e),this._childs.length&&this._updateChilds(e)},n.addChildAt=function(t,i){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");var n=e.prototype.addChildAt.call(this,t,i);return t!==this&&t._addSelfAndChildrenRenderObjects(),n},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");var i=e.prototype.addChild.call(this,t);return t!==this&&t._addSelfAndChildrenRenderObjects(),i},n.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._childs.splice(e,1),this.model&&this.model.removeChild(t.model),t.parent=null,t._clearSelfAndChildrenRenderObjects()),t},n.addComponent=function(e){if(void 0!==this._componentsMap[e])throw new Error("无法创建"+e+"组件，"+e+"组件已存在！");var t=u.getInstance(e);return t._initialize(this),this._componentsMap[e]=this._components.length,this._components.push(t),this.event("componentadded",t),t},n.getComponentByType=function(e){return void 0===this._componentsMap[e]?null:this._components[this._componentsMap[e]]},n.getComponentByIndex=function(e){return this._components[e]},n.removeComponent=function(e){if(void 0!==this._componentsMap[e]){var t=this._components[this._componentsMap[e]];this._components.splice(this._componentsMap[e],1),delete this._componentsMap[e],this.event("componentremoved",t)}},n.removeAllComponent=function(){for(var e in this._componentsMap)this.removeComponent(e)},n.loadHierarchy=function(e){var t=this;if(null!==e){var i=new v;e=b.formatURL(e);var n=this,r=function(i){var r=b.basePath;b.basePath=b.getPath(b.formatURL(e));var a=u.createByJson(i,null,n,f.create(null,Se._parseHierarchyProp,null,!1),f.create(null,Se._parseHierarchyNode,null,!1));t.addChild(a),b.basePath=r,t.event("hierarchyloaded",[n,a])};i.once("complete",null,r),i.load(e,"text")}},n.dispose=function(){},a(0,n,"id",function(){return this._id}),a(0,n,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enabledchanged",this._enable)}),a(0,n,"wvpMatrix",function(){return this._wvpMatrix}),a(0,n,"active",function(){return G.isActive(this._layerMask)&&this._enable}),a(0,n,"visible",function(){return G.isVisible(this._layerMask)&&this._enable}),a(0,n,"layer",function(){return G.getLayerByMask(this._layerMask)},function(e){this._layerMask=e.mask,this.event("layerchanged",e)}),a(0,n,"componentsCount",function(){return this._components.length}),a(0,n,"scene",function(){return this.parent?this.parent.scene:null}),t._uniqueIDCounter=1,t._nameNumberCounter=0,t}(g),He=function(e){function t(){this._loaded=!1,this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,t.__super.call(this),this._loaded=!1,this._boundingBox=new me(new Ee,new Ee),this._boundingSphere=new ve(new Ee,0)}r(t,"laya.d3.resource.models.BaseMesh",e);var i=t.prototype;return i.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},i.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},i.Render=function(){throw new Error("未Override,请重载该方法！")},i.RenderSubMesh=function(e){throw new Error("未Override,请重载该方法！")},a(0,i,"loaded",function(){return this._loaded}),a(0,i,"subMeshCount",function(){return this._subMeshCount}),a(0,i,"positions",function(){throw new Error("未Override,请重载该属性！")}),t}(D),je=function(e){function t(){t.__super.call(this)}return r(t,"laya.d3.resource.models.Sky",e),t}(D),ke=(function(e){function t(e,i,n,r,a,s,o,h,l){this._alreadyResolved=!1,this._looked=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._mipMap=!1,this._repeat=!1,this._minFifter=0,this._magFifter=0,this._size=null,t.__super.call(this),void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=-1),this._w=e,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=h,this._magFifter=l,this._size=new Re(e,i),this._createWebGLRenderTarget(),this.bitmap.lock=!0}r(t,"laya.d3.resource.RenderTarget",e);var n=t.prototype;return i.imps(n,{"laya.resource.IDispose":!0}),n._createWebGLRenderTarget=function(){this.bitmap=new N(this.width,this.height,this._surfaceFormat,this._surfaceType,this._depthStencilFormat,this._mipMap,this._repeat,this._minFifter,this._magFifter),this.bitmap.activeResource(),this._alreadyResolved=!0},n.start=function(){var e=S.mainContext;e.bindFramebuffer(36160,this.bitmap.frameBuffer),t._currentRenderTarget=this,this._alreadyResolved=!1,t._currentRenderTarget=this},n.clear=function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1);var r=S.mainContext;r.clearColor(e,t,i,n);var a=16384;switch(this._depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}r.clear(a)},n.end=function(){var e=S.mainContext;e.bindFramebuffer(36160,null),t._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(e,t,i,n){var r=S.mainContext;r.bindFramebuffer(36160,this.bitmap.frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var s=new Uint8Array(this._w*this._h*4);return r.readPixels(e,t,i,n,this._surfaceFormat,this._surfaceType,s),r.bindFramebuffer(36160,null),s},n.dispose=function(){this.bitmap.dispose()},a(0,n,"size",function(){return this._size}),a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"minFifter",function(){return this._minFifter}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"mipMap",function(){return this._mipMap}),a(0,n,"magFifter",function(){return this._magFifter}),a(0,n,"source",function(){if(this._alreadyResolved)return e.prototype._$get_source.call(this);throw new Error("RenderTarget  还未准备好！")}),t._currentRenderTarget=null,t}(w),function(e){function t(){this._url=null,this._templet=null,this.player=null,t.__super.call(this),this.player=new o}r(t,"laya.d3.component.animation.KeyframeAnimations",e);var i=t.prototype;return i.play=function(e,t,i,n,r){void 0===e&&(e=0),void 0===t&&(t=1),void 0===i&&(i=Number.MAX_VALUE),void 0===n&&(n=0),void 0===r&&(r=0),this.player.play(e,t,i,n,r)},i.stop=function(e){void 0===e&&(e=!0),this.player.stop(e)},a(0,i,"url",function(){return this._url},function(e){var t=this;0!==this.player.state&&this.player.stop(!0),this._url=b.formatURL(e);var i=D.animationCache[this._url],n=this;if(i)this._templet=i,this.player.templet=i;else{i=D.animationCache[this._url]=new p,this._templet=i,this.player.templet=i;var r=function(e){var n=e;i.parse(n,t.player.cacheFrameRate)},a=new v;a.once("complete",null,r),a.load(this._url,"arraybuffer")}i.loaded?this.event("loaded",this):i.once("loaded",null,function(e){n.event("loaded",n)})}),a(0,i,"currentFrameIndex",function(){return this.player.currentKeyframeIndex}),a(0,i,"NodeCount",function(){return this._templet.getNodeCount(this.player.currentAnimationClipIndex)}),a(0,i,"currentAnimationClipIndex",function(){return this.player.currentAnimationClipIndex}),a(0,i,"paused",function(){return this.player.paused},function(e){this.player.paused=e}),a(0,i,"cacheFrameRate",function(){return this.player.cacheFrameRate}),t}(Oe)),ze=(function(e){function t(){this._attachSkeleton=null,this._data=null,this._extenData=null,this.attachBones=null,this.matrixs=null,t.__super.call(this),this.attachBones=[],this.matrixs=[]}r(t,"laya.d3.component.AttachPoint",e);var i=t.prototype;return i._load=function(t){e.prototype._load.call(this,t),this._attachSkeleton=t.getComponentByType($e)},i._update=function(e){var t=this._attachSkeleton.player,i=this._attachSkeleton._templet;if(this._attachSkeleton&&2===t.state&&i&&i.loaded){this.matrixs.length=this.attachBones.length;for(var n=0;n<this.attachBones.length;n++){var r=i.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[n]);this._data=this._attachSkeleton.curBonesDatas.subarray(16*r,16*(r+1));var a=this.matrixs[n];a||(a=this.matrixs[n]=new Te),a.copyFromArray(this._data),Te.multiply(this.owner.transform.worldMatrix,a,a)}}},t}(Oe),function(e){function t(){t.__super.call(this)}return r(t,"laya.d3.component.Script",e),t}(Oe),function(e){function t(e){this._vertexBuffer3D=null,this._indexBuffer3D=null,this._sharderNameID=0,this._shader=null,this._shaderValue=new P,t.__super.call(this,e),this.initialize(),this.loadShaderParams(),this._vertexBuffer=this._vertexBuffer3D=Ye.create(K.vertexDeclaration,4*e.maxPartices,35048),this._indexBuffer=this._indexBuffer3D=Ze.create("ushort",6*e.maxPartices,35044,!0),this.loadContent()}r(t,"laya.d3.resource.tempelet.ParticleTemplet3D",e);var n=t.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n.getBakedVertexs=function(e,t){return null},n.getBakedIndices=function(){return null},n.getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer3D:null},n.getIndexBuffer=function(){return this._indexBuffer3D},n.loadShaderParams=function(){if(this._sharderNameID=E.nameKey.get("PARTICLE"),this.settings.textureName){this.texture=new w,this._shaderValue.pushValue("DIFFUSETEXTURE",null,-1);var e=this;i.loader.load(this.settings.textureName,f.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,t.bitmap.repeat=!0,e.texture=t}))}this._shaderValue.pushValue("DURATION",this.settings.duration,-1),this._shaderValue.pushValue("GRAVITY",this.settings.gravity,-1),this._shaderValue.pushValue("ENDVELOCITY",this.settings.endVelocity,-1)},n.addParticle=function(e,t){this.addParticleArray(e.elements,t.elements)},n.loadContent=function(){for(var e=new Uint16Array(6*this.settings.maxPartices),t=0;t<this.settings.maxPartices;t++)e[6*t+0]=4*t+0,e[6*t+1]=4*t+1,e[6*t+2]=4*t+2,e[6*t+3]=4*t+0,e[6*t+4]=4*t+2,e[6*t+5]=4*t+3;this._indexBuffer3D.setData(e)},n.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex)):(e=4*this._firstNewElement*this._floatCountPerVertex,this._vertexBuffer3D.setData(this._vertices,e,e,4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer3D.setData(this._vertices,0,0,4*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._render=function(e){if(this.texture&&this.texture.loaded){if(this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._firstActiveElement!=this._firstFreeElement){S.mainContext;this._vertexBuffer3D._bind(),this._indexBuffer._bind(),this._shader=this.getShader(e);var t=this._shaderValue.length;this._shaderValue.pushArray(e.shaderValue),this._shaderValue.pushArray(this._vertexBuffer3D.vertexDeclaration.shaderValues),this._shaderValue.pushValue("MVPMATRIX",e.owner.transform.worldMatrix.elements,-1),this._shaderValue.pushValue("MATRIX1",e.viewMatrix.elements,-1),this._shaderValue.pushValue("MATRIX2",e.projectionMatrix.elements,-1);var i=e.viewport.width/e.viewport.height,n=new Me(.5/i,-.5);this._shaderValue.pushValue("VIEWPORTSCALE",n.elements,-1),this._shaderValue.pushValue("CURRENTTIME",this._currentTime,-1),this._shaderValue.data[1][0]=this.texture.source,this._shaderValue.data[1][1]=this.texture.bitmap.id,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=t;var r=0;this._firstActiveElement<this._firstFreeElement?(r=6*(this._firstFreeElement-this._firstActiveElement),S.mainContext.drawElements(4,r,5123,6*this._firstActiveElement*2),A.trianglesFaces+=r/3,A.drawCall++):(r=6*(this.settings.maxPartices-this._firstActiveElement),S.mainContext.drawElements(4,r,5123,6*this._firstActiveElement*2),A.trianglesFaces+=r/3,A.drawCall++,this._firstFreeElement>0&&(r=6*this._firstFreeElement,S.mainContext.drawElements(4,r,5123,0),A.trianglesFaces+=r/3,A.drawCall++))}return this._drawCounter++,!0}return!1},n.getShader=function(e){var t=e.shaderDefs,i=t._value;t.addInt(32768);var n=(t._value|e.shadingMode)+2e-4*this._sharderNameID;return this._shader=E.withCompile(this._sharderNameID,e.shadingMode,t.toNameDic(),n,null),t._value=i,this._shader},a(0,n,"VertexBufferCount",function(){return 1}),a(0,n,"indexOfHost",function(){return 0}),a(0,n,"triangleCount",function(){return this._indexBuffer3D.indexCount/3}),t}(T)),We=function(e){function t(){this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this.enableFog=!1,this.fogStart=NaN,this.fogRange=NaN,this.fogColor=null,this.enableLight=!0,this.currentCamera=null,t.__super.call(this),this._renderState=new W,this._lights=new Array,this._shadingMode=8192,this._renderConfigs=[],this._quenes=[],this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new Ee(.7,.7,.7),this._renderConfigs[0]=new j,this._renderConfigs[0].depthTest=!1,this._renderConfigs[1]=new j,this._renderConfigs[2]=new j,this._renderConfigs[2].cullFace=!1,this._renderConfigs[4]=new j,this._renderConfigs[4].cullFace=!1,this._renderConfigs[4].blend=!0,this._renderConfigs[4].sFactor=770,this._renderConfigs[4].dFactor=771,this._renderConfigs[6]=new j,this._renderConfigs[6].cullFace=!1,this._renderConfigs[6].blend=!0,this._renderConfigs[6].sFactor=770,this._renderConfigs[6].dFactor=1,this._renderConfigs[3]=new j,this._renderConfigs[3].blend=!0,this._renderConfigs[3].sFactor=770,this._renderConfigs[3].dFactor=771,this._renderConfigs[5]=new j,this._renderConfigs[5].blend=!0,this._renderConfigs[5].sFactor=770,this._renderConfigs[5].dFactor=1,this._renderConfigs[8]=new j,this._renderConfigs[8].cullFace=!1,this._renderConfigs[8].blend=!0,this._renderConfigs[8].depthMask=0,this._renderConfigs[8].sFactor=770,this._renderConfigs[8].dFactor=771,this._renderConfigs[10]=new j,this._renderConfigs[10].cullFace=!1,this._renderConfigs[10].blend=!0,this._renderConfigs[10].depthMask=0,this._renderConfigs[10].sFactor=770,this._renderConfigs[10].dFactor=1,this._renderConfigs[7]=new j,this._renderConfigs[7].blend=!0,this._renderConfigs[7].depthMask=0,this._renderConfigs[7].sFactor=770,this._renderConfigs[7].dFactor=771,this._renderConfigs[9]=new j,this._renderConfigs[9].blend=!0,this._renderConfigs[9].depthMask=0,this._renderConfigs[9].sFactor=770,this._renderConfigs[9].dFactor=1}r(t,"laya.d3.core.scene.BaseScene",e);var n=t.prototype;return i.imps(n,{"laya.webgl.submit.ISubmit":!0}),n._clearColor=function(e){var t=this.currentCamera.clearColor.elements;e.clearColor(t[0],t[1],t[2],t[3]),e.clear(16640)},n._prepareScene=function(e,t){G._currentCameraCullingMask=this.currentCamera.cullingMask,t.context=S.mainContext,t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.reset(),t.loopCount=A.loopCount,t.shadingMode=this._shadingMode,t.scene=this,t.camera=this.currentCamera;var i=t.worldShaderValue,n=A.loopCount;if(this.currentCamera&&i.pushValue("CAMERAPOS",this.currentCamera.transform.position.elements,n),this._lights.length>0)for(var r=0,a=0;a<this._lights.length;a++){var s=this._lights[a];if(s.active){if(r++,r>this._enableLightCount)break;s.updateToWorldState(t)}}this.enableFog&&(t.worldShaderValue.pushValue("FOGSTART",this.fogStart,n),t.worldShaderValue.pushValue("FOGRANGE",this.fogRange,n),t.worldShaderValue.pushValue("FOGCOLOR",this.fogColor.elements,n))},n._updateScene=function(e){this._updateChilds(e)},n._updateChilds=function(e){for(var t=0,i=this._childs.length;i>t;++t){var n=this._childs[t];n._update(e)}},n._preRenderScene=function(e,t){for(var i=0;i<this._quenes.length;i++)this._quenes[i]&&this._quenes[i]._preRender(t)},n._renderScene=function(e,t){var i=t.viewport;e.viewport(i.x,W.clientHeight-i.y-i.height,i.width,i.height);for(var n=0;n<this._quenes.length;n++)this._quenes[n]&&(this._quenes[n]._setState(e),this._quenes[n]._render(t))},n._set3DRenderConfig=function(e){e.disable(3042),O._blend=!1,e.blendFunc(770,771),O._sFactor=770,O._dFactor=771,e.disable(2929),O._depthTest=!1,e.enable(2884),O._cullFace=!0,e.depthMask(1),O._depthMask=1,e.frontFace(2304),O._frontFace=2304},n._set2DRenderConfig=function(e){O.setBlend(e,!0),O.setBlendFunc(e,770,771),O.setDepthTest(e,!1),O.setCullFace(e,!0),O.setDepthMask(e,1),O.setFrontFaceCCW(e,2305),e.viewport(0,0,I.width,I.height)},n._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},n._removeLight=function(e){var t=this._lights.indexOf(e);t>=0&&this._lights.splice(t,1)},n.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");var i=laya.display.Node.prototype.addChildAt.call(this,e,t);return e!==this&&e._addSelfAndChildrenRenderObjects(),i},n.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");var t=laya.display.Node.prototype.addChild.call(this,e);return e!==this&&e._addSelfAndChildrenRenderObjects(),t},n.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._childs.splice(e,1),this.model&&this.model.removeChild(t.model),t.parent=null,t._clearSelfAndChildrenRenderObjects()),t},n.getRenderQueue=function(e){return this._quenes[e]||(this._quenes[e]=new z(this._renderConfigs[e]))},n.getRenderObject=function(e){return(this._quenes[e]||(this._quenes[e]=new z(this._renderConfigs[e]))).getRenderObj()},n.addRenderQuene=function(e){this._quenes[this._customRenderQueneIndex++]=new z(e)},n.beforeUpate=function(e){},n.lateUpate=function(e){},n.beforeRender=function(e){},n.lateRender=function(e){},n.render=function(t,i,n){C._context.ctx._shader2D.glTexture=null,this._childs.length>0&&t.addRenderObject(this),this._renderType&=-2049,e.prototype.render.call(this,t,i,n)},n.renderSubmit=function(){return 1},n.getRenderType=function(){return 0},n.releaseRender=function(){},a(0,n,"scene",function(){return this}),a(0,n,"shadingMode",function(){return 4096==this._shadingMode?0:8192},function(e){if(0!==e&&1!==e)throw Error("Scene set shadingMode,must:0 or 1,value="+e);this._shadingMode=0===e?4096:8192}),t.VERTEX_SHADING=0,t.PIXEL_SHADING=1,t}(y),Xe=function(e){function t(e,n){this._projectionMatrixModifyID=0,t.__super.call(this),void 0===e&&(e=.1),void 0===n&&(n=1e3),this._tempVector3=new Ee,this._up=new Ee,this._forward=new Ee,this._right=new Ee,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._slavesCameras=[],this._renderTargetSize=Re.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=n,
this.cullingMask=2147483647,this.clearColor=new Ve(100/255,149/255,237/255,1),this._calculateProjectionMatrix(),i.stage.on("resize",this,this._onScreenSizeChanged)}r(t,"laya.d3.core.BaseCamera",e);var o=t.prototype;return o._calculateProjectionMatrix=function(){},o._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},o.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},o.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},o.addAllLayers=function(){this.cullingMask=2147483647},o.removeAllLayers=function(){this.cullingMask=0|G.getLayerByNumber(29).mask|G.getLayerByNumber(30).mask},o.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},o.destroy=function(e){void 0===e&&(e=!0),this.masterCamera=null,this.renderTarget=null,i.stage.off("resize",this,this._onScreenSizeChanged),laya.display.Node.prototype.destroy.call(this,e)},o.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},o.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},o.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},a(0,o,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),a(0,o,"renderTargetSize",function(){return null!=this._masterCamera?this._masterCamera.renderTargetSize:this._renderTargetSize},function(e){null==this._masterCamera&&(null!=this.renderTarget&&this._renderTargetSize!=e,this._renderTargetSize=e,this._calculateProjectionMatrix())}),a(0,o,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),a(0,o,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),a(0,o,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),a(0,o,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),a(0,o,"masterCamera",function(){return this._masterCamera},function(e){if(0!=this._slavesCameras.length||null!=e&&null!=e.masterCamera)throw new Error("BaseCamera: A camera can't be master and slave simultaneity.");if(null!=this.masterCamera){var t=this.masterCamera._slavesCameras;t.splice(t.indexOf(this),1)}if(this.masterCamera=e,null!=e){e._slavesCameras.push(this);for(var i=0;i<e._slavesCameras.length;i++){var n=e._slavesCameras.length;if(e._slavesCameras[i].renderingOrder>e._slavesCameras[n-1].renderingOrder){var r=e._slavesCameras[n-1];e._slavesCameras[n-1]=e._slavesCameras[i],e._slavesCameras[i]=r}}this._renderTarget=null}}),a(0,o,"renderTarget",function(){return null!=this._masterCamera?this._masterCamera.renderTarget:this._renderTarget},function(e){null==this._masterCamera&&(this._renderTarget=e,null!=e&&(this._renderTargetSize=e.size))}),a(0,o,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),a(0,o,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),a(0,o,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e}),a(0,o,"orthographicProjection",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),a(0,o,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),a(1,t,"mainCamera",function(){for(var e=t._cameraPool.length-1;e>=0;e--)if(null==t._cameraPool[e].masterCamera&&t._cameraPool[e].enable)return t._cameraPool[e];return null},laya.d3.core.Sprite3D._$SET_mainCamera),t._sortCamerasByRenderingOrder=function(){for(var e=t._cameraPool.length-1,i=0;e>i;i++)if(t._cameraPool[i].renderingOrder>t._cameraPool[e].renderingOrder){var n=t._cameraPool[i];t._cameraPool[i]=t._cameraPool[e],t._cameraPool[e]=n}},t.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",t.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",n(t,["_cameraPool",function(){return this._cameraPool=s(2,null)}]),t}(Ge),qe=(function(e){function t(e){this._templet=null,this._renderObject=null,t.__super.call(this),this._templet=new we(e)}r(t,"laya.d3.core.glitter.Glitter",e);var i=t.prototype;return i._clearSelfRenderObjects=function(){this._renderObject.renderQneue.deleteRenderObj(this._renderObject)},i._update=function(e){if(e.owner=this,this.active)if(this._renderObject){var t=0;t=8;var i=e.scene.getRenderQueue(t);this._renderObject.renderQneue!=i&&(this._renderObject.renderQneue.deleteRenderObj(this._renderObject),this._renderObject=this._addRenderObject(e,t))}else this._renderObject=this._addRenderObject(e,t);else this._clearSelfRenderObjects();this._childs.length&&this._updateChilds(e)},i._addRenderObject=function(e,t){var i=e.scene.getRenderObject(t);this._renderObject=i;var n=this.templet;return i.mainSortID=0,i.triangleCount=n.triangleCount,i.owner=e.owner,i.renderElement=n,i.material=null,i},a(0,i,"templet",function(){return this._templet}),t}(Ge),function(e){function t(){this._diffuseColor=null,this._ambientColor=null,this._specularColor=null,this._reflectColor=null,t.__super.call(this),this.on("added",this,this._onAdded),this.on("removed",this,this._onRemoved),this._diffuseColor=new Ee(.8,.8,.8),this._ambientColor=new Ee(.6,.6,.6),this._specularColor=new Ee(1,1,1),this._reflectColor=new Ee(1,1,1)}r(t,"laya.d3.core.light.LightSprite",e);var i=t.prototype;return i._onRemoved=function(){this.scene._removeLight(this)},i._onAdded=function(){this.scene._addLight(this)},i.updateToWorldState=function(e){},a(0,i,"diffuseColor",function(){return this._diffuseColor},function(e){this._diffuseColor=e}),a(0,i,"lightType",function(){return-1}),a(0,i,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e}),a(0,i,"specularColor",function(){return this._specularColor},function(e){this._specularColor=e}),a(0,i,"reflectColor",function(){return this._reflectColor},function(e){this._reflectColor=e}),t.TYPE_DIRECTIONLIGHT=1,t.TYPE_POINTLIGHT=2,t.TYPE_SPOTLIGHT=3,t}(Ge)),Qe=function(e){function t(e,i){this._renderObjects=null,this._meshFilter=null,this._meshRender=null,this._iAsyncLodingMeshMaterial=!1,this._iAsyncLodingMeshMaterials=!1,t.__super.call(this,i),this._renderObjects=[],this._meshFilter=new Ne(this),this._meshRender=new Fe(this),this._meshFilter.on("meshchanged",this,this._onMeshChanged),this._meshRender.on("materialchanged",this,this._onMaterialChanged),this._meshFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?(this._iAsyncLodingMeshMaterial=this._iAsyncLodingMeshMaterials=!1,this._meshRender.shadredMaterials=e.materials):(this._iAsyncLodingMeshMaterial=this._iAsyncLodingMeshMaterials=!0,e.once("loaded",this,this._copyMaterials)))}r(t,"laya.d3.core.MeshSprite3D",e);var i=t.prototype;return i._onMeshChanged=function(e){},i._onMaterialChanged=function(e,t){},i._copyMaterials=function(e){if(this._iAsyncLodingMeshMaterials)if(this._iAsyncLodingMeshMaterial)this._meshRender.shadredMaterials=e.materials;else{var t=e.materials;t.length>0&&(t[0]=this._meshRender.shadredMaterial,this._meshRender.shadredMaterials=t)}this._iAsyncLodingMeshMaterial=this._iAsyncLodingMeshMaterials=!1},i._clearSelfRenderObjects=function(){for(var e=0,t=this._renderObjects.length;t>e;e++){var i=this._renderObjects[e];i.renderQneue.deleteRenderObj(i)}this._renderObjects.length=0},i._update=function(e){if(e.owner=this,this._updateComponents(e),this.active){for(var t=this._meshFilter.sharedMesh.getRenderElementsCount(),i=0;t>i;i++){var n=this._renderObjects[i],r=this._meshRender.shadredMaterials;if(n){var a=r[i],s=e.scene.getRenderQueue(a.renderQueue);n.renderQneue!=s&&(n.renderQneue.deleteRenderObj(n),n=this._addRenderObject(e,i,a))}else n=this._addRenderObject(e,i,r[i])}this._lateUpdateComponents(e)}else this._clearSelfRenderObjects();A.spriteCount++,this._childs.length&&this._updateChilds(e)},i._addRenderObject=function(e,t,i){var n=e.scene.getRenderObject(i.renderQueue);this._renderObjects[t]=n;var r=this._meshFilter.sharedMesh.getRenderElement(t);return n.mainSortID=e.owner._getSortID(r,i),n.triangleCount=r.triangleCount,n.owner=e.owner,n.renderElement=r,n.material=i,n},i.dispose=function(){e.prototype.dispose.call(this),this._meshFilter.off("meshchanged",this,this._onMeshChanged),this._meshRender.off("materialchanged",this,this._onMaterialChanged)},a(0,i,"meshFilter",function(){return this._meshFilter}),a(0,i,"meshRender",function(){return this._meshRender}),t}(Ge),Ze=(function(e){function t(e){this.templet=null,this._renderObject=null,t.__super.call(this),this.templet=new ze(e)}r(t,"laya.d3.core.particle.Particle3D",e);var i=t.prototype;return i._clearSelfRenderObjects=function(){this._renderObject.renderQneue.deleteRenderObj(this._renderObject)},i.addParticle=function(e,t){Ee.add(this.transform.localPosition,e,e),this.templet.addParticle(e,t)},i._update=function(e){if(this.templet.update(e.elapsedTime),e.owner=this,this.active)if(this._renderObject){var t=0;0===this.templet.settings.blendState?t=7:1===this.templet.settings.blendState&&(t=9);var i=e.scene.getRenderQueue(t);this._renderObject.renderQneue!=i&&(this._renderObject.renderQneue.deleteRenderObj(this._renderObject),this._renderObject=this._addRenderObject(e,t))}else this._renderObject=this._addRenderObject(e,t);else this._clearSelfRenderObjects();this._childs.length&&this._updateChilds(e)},i._addRenderObject=function(e,t){var i=e.scene.getRenderObject(t);this._renderObject=i;var n=this.templet;return i.mainSortID=0,i.triangleCount=n.triangleCount,i.owner=e.owner,i.renderElement=n,i.material=null,i},t}(Ge),function(e){function t(e,i,n,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===n&&(n=35044),void 0===r&&(r=!1),t.__super.call(this),this._indexType=e,this._indexCount=i,this._bufferUsage=n,this._bufferType=34963,this._canRead=r,this._bind();var a=0;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*i,this._byteLength=a,h._gl.bufferData(this._bufferType,a,this._bufferUsage),r?("ushort"==e?this._buffer=new Uint16Array(i):"ubyte"==e&&(this._buffer=new Uint8Array(i)),this.memorySize=2*a):this.memorySize=a}r(t,"laya.d3.graphics.IndexBuffer3D",e);var i=t.prototype;return i.setData=function(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===i&&4294967295===n||(e=new Uint16Array(e.buffer,i*r,n))):"ubyte"==this._indexType&&(r=1,0===i&&4294967295===n||(e=new Uint8Array(e.buffer,i*r,n))),this._bind(),h._gl.bufferSubData(this._bufferType,t*r,e),this._canRead)if(0!==t||0!==i||4294967295!==n){var a=this._buffer.length-t;n>a&&(n=a);for(var s=0;n>s;s++)this._buffer[t+s]=e[s]}else this._buffer=e},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.dispose=function(){this._buffer=null,e.prototype.dispose.call(this),this.memorySize=0},a(0,i,"indexType",function(){return this._indexType}),a(0,i,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,i,"indexCount",function(){return this._indexCount}),a(0,i,"canRead",function(){return this._canRead}),t.INDEXTYPE_UBYTE="ubyte",t.INDEXTYPE_USHORT="ushort",t.create=function(e,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new t(e,i,n,r)},t}(h)),Ye=function(e){function t(e,i,n,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),t.__super.call(this),this._vertexDeclaration=e,this._vertexCount=i,this._bufferUsage=n,this._bufferType=34962,this._canRead=r,this._bind();var a=this._vertexDeclaration.vertexStride*i;this._byteLength=a,h._gl.bufferData(this._bufferType,a,this._bufferUsage),r&&(this._buffer=new Float32Array(a/4))}r(t,"laya.d3.graphics.VertexBuffer3D",e);var i=t.prototype;return i.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},i.setData=function(e,t,i,n){if(void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=4294967295),0===i&&4294967295===n||(e=new Float32Array(e.buffer,4*i,n)),this._bind(),h._gl.bufferSubData(this._bufferType,4*t,e),this._canRead)if(0!==t||0!==i||4294967295!==n){var r=this._buffer.length-t;n>r&&(n=r);for(var a=0;n>a;a++)this._buffer[t+a]=e[a]}else this._buffer=e},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.detoryResource=function(){for(var t=this._vertexDeclaration.getVertexElements(),i=0;i<t.length;i++)S.mainContext.disableVertexAttribArray(i);e.prototype.detoryResource.call(this)},i.dispose=function(){e.prototype.dispose.call(this),this._buffer=null,this._vertexDeclaration=null},a(0,i,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,i,"vertexCount",function(){return this._vertexCount}),a(0,i,"canRead",function(){return this._canRead}),t.create=function(e,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new t(e,i,n,r)},t}(h),Ke=function(e){function t(e){this._materials=null,this._subMeshes=null,this._useFullBone=!0,this._url=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._url=e,this._loaded?this._generateBoundingObject():this.once("loaded",this,this._generateBoundingObject)}r(t,"laya.d3.resource.models.Mesh",e);var i=t.prototype;return i._generateBoundingObject=function(){var e=this.positions;me.createfromPoints(e,this._boundingBox),ve.createfromPoints(e,this._boundingSphere)},i.add=function(e){e._indexOfHost=this._subMeshes.length,this._subMeshes.push(e),this._subMeshCount++},i.remove=function(e){var t=this._subMeshes.indexOf(e);return 0>t?!1:(this._subMeshes.splice(t,1),this._subMeshCount--,!0)},i.getSubMesh=function(e){return this._subMeshes[e]},i.getSubMeshCount=function(){return this._subMeshes.length},i.clear=function(){return this._subMeshes.length=0,this._subMeshCount=0,this},i.disableUseFullBone=function(){this._useFullBone=!1},i.getRenderElementsCount=function(){return this._subMeshes.length},i.getRenderElement=function(e){return this._subMeshes[e]},i.dispose=function(){this._resourceManager.removeResource(this),laya.resource.Resource.prototype.dispose.call(this);for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._subMeshes=null,this._subMeshCount=0},a(0,i,"positions",function(){for(var e=[],t=this._subMeshes.length,i=0;t>i;i++){var n,r=this._subMeshes[i],a=r.getVertexBuffer(),s=a.vertexDeclaration.getVertexElements(),o=0;for(o=0;o<s.length;o++){var h=s[o];if("vector3"===h.elementFormat&&"POSITION"===h.elementUsage){n=h;break}}var l=a.getData();for(o=0;o<l.length;o+=a.vertexDeclaration.vertexStride/4){var u=o+n.offset/4,c=new Ee(l[u+0],l[u+1],l[u+2]);e.push(c)}}return e}),a(0,i,"materials",function(){return this._materials.slice()}),t.load=function(e){e=b.formatURL(e);var i=D.meshCache[e];if(!i){i=D.meshCache[e]=new t(e);var n=new v;n.once("complete",null,function(t){new fe(t,i,i._materials,e),i._loaded=!0,i.event("loaded",i)}),n.load(e,"arraybuffer")}return i},t}(He),Je=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,this._bakedVertexes=null,this._bakedIndices=null,this._isVertexbaked=!1,this._indexOfHost=0,t.__super.call(this),this._indexOfHost=0}r(t,"laya.d3.resource.models.PrimitiveMesh",e);var n=t.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n.getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},n.getIndexBuffer=function(){return this._indexBuffer},n._getShader=function(e,t,i){if(!i)return null;var n=0,r=t.vertexDeclaration.shaderAttribute;r.UV&&(n|=i.shaderDef),r.COLOR&&(n|=32),e.scene.enableFog&&(n|=131072),n>0&&e.shaderDefs.addInt(n);var a=i.getShader(e);return a},n.getRenderElement=function(e){return this},n.getRenderElementsCount=function(){return 1},n.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},n._render=function(e){this._vertexBuffer._bind(),this._indexBuffer._bind();var t=e.renderObj.material;if(t){var i=this._getShader(e,this._vertexBuffer,t),n=e.shaderValue.length;e.shaderValue.pushArray(this._vertexBuffer.vertexDeclaration.shaderValues);var r=e.owner,a=r.transform.worldMatrix;if(e.shaderValue.pushValue("MATRIX1",a.elements,-1),Te.multiply(e.projectionViewMatrix,a,e.owner.wvpMatrix),e.shaderValue.pushValue("MVPMATRIX",r.wvpMatrix.elements,-1),!t.upload(e,null,i))return e.shaderValue.length=n,!1;e.shaderValue.length=n}return e.context.drawElements(4,this._numberIndices,5123,0),A.drawCall++,A.trianglesFaces+=this._numberIndices/3,!0},n.getBakedVertexs=function(e,t){if(0===e){if(this._bakedVertexes)return this._bakedVertexes;var i=4,n=this._vertexBuffer;this._bakedVertexes=n.getData().slice();for(var r=n.vertexDeclaration,a=r.shaderAttribute.POSITION[4]/i,s=r.shaderAttribute.NORMAL[4]/i,o=0;o<this._bakedVertexes.length;o+=r.vertexStride/i){var h=o+a;Se.transformVector3ArrayToVector3ArrayCoordinate(this._bakedVertexes,h,t,this._bakedVertexes,h),Se.transformVector3ArrayToVector3ArrayCoordinate(this._bakedVertexes,s,t,this._bakedVertexes,s)}return this._isVertexbaked=!0,this._bakedVertexes}return null},n.getBakedIndices=function(){return this._bakedIndices?this._bakedIndices:this._bakedIndices=this._indexBuffer.getData()},a(0,n,"VertexBufferCount",function(){return 1}),a(0,n,"indexOfHost",function(){return this._indexOfHost}),a(0,n,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,n,"positions",function(){var e,t=[],i=this._vertexBuffer.vertexDeclaration.getVertexElements(),n=0;for(n=0;n<i.length;n++){var r=i[n];if("vector3"===r.elementFormat&&"POSITION"===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(n=0;n<a.length;n+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=n+e.offset/4,o=new Ee(a[s+0],a[s+1],a[s+2]);t.push(o)}return t}),t}(He),$e=(function(e){function t(){this._alphaBlending=1,this._colorIntensity=1,this.TextureCube=null,t.__super.call(this),this.name="Skybox-"+t._nameNumber,t._nameNumber++}r(t,"laya.d3.resource.models.SkyBox",e);var i=t.prototype;return a(0,i,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1)}),a(0,i,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),t._nameNumber=1,t}(je),function(e){function t(){this._tempCurAnimationData=null,this._lastFrameIndex=-1,this._currentTransform=null,this._originalAnimationTransform=null,this._originalFov=0,this._camera=null,this._currentAnimationData=null,this.localMode=!0,this.addMode=!0,this._tempVector30=new Ee,this._tempVector31=new Ee,this._tempVector32=new Ee,t.__super.call(this)}r(t,"laya.d3.component.animation.CameraAnimations",e);var i=t.prototype;return i._effect=function(){var e=0;for(e=0;3>e;e++)this._tempVector30.elements[e]=this._currentAnimationData[e],this._tempVector31.elements[e]=this._currentAnimationData[e+3],this._tempVector32.elements[e]=this._currentAnimationData[e+6];this._currentTransform||(this._currentTransform=new Te),Te.createLookAt(this._tempVector30,this._tempVector31,this._tempVector32,this._currentTransform),this._currentTransform.invert(this._currentTransform),this.addMode&&Te.multiply(this._originalAnimationTransform,this._currentTransform,this._currentTransform),this.localMode?this.owner.transform.localMatrix=this._currentTransform:this.owner.transform.worldMatrix=this._currentTransform,this._camera.fieldOfView=this._currentAnimationData[9]},i._load=function(e){var t=this;if(!(e instanceof laya.d3.core.Camera))throw new Error("该Sprite3D并非Camera");this._camera=e,this.player.on("stopped",this,function(){t.player.returnToZeroStopped&&(t.localMode?t._originalAnimationTransform&&(e.transform.localMatrix=t._originalAnimationTransform):t._originalAnimationTransform&&(e.transform.worldMatrix=t._originalAnimationTransform),t._camera.fieldOfView=t._originalFov)})},i._update=function(e){if(this.player.update(e.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.state){var t=this.player.playbackRate*e.scene.timer.scale,i=this.player.isCache&&t>=1?this.currentFrameIndex:-1,n=this.currentAnimationClipIndex;if(-1!==i&&this._lastFrameIndex===i)return void laya.d3.component.Component3D.prototype._update.call(this,e);if(this.player.isCache&&t>=1){var r=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache,n,i);if(r)return this._currentAnimationData=r,this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,e),void this._effect()}var a=this._templet.getNodes(n),s=a.length;this.player.isCache&&t>=1?this._currentAnimationData=new Float32Array(10*s):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(10*s)),this._currentAnimationData=this._tempCurAnimationData),this.player.isCache&&t>=1?this._templet.getOriginalData(n,this._currentAnimationData,i,this.player.currentPlayTime):this._templet.getOriginalDataUnfixedRate(n,this._currentAnimationData,this.player.currentPlayTime),this.player.isCache&&t>=1&&this._templet.setAnimationDataWithCache(this._templet._animationDatasCache,n,i,this._currentAnimationData),this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,e),this._effect()}},t}(ke),function(e){function t(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,t.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(t,"laya.d3.component.animation.RigidAnimations",e);var i=t.prototype;return i._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,i=e.length,n=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;i>a;a++){var s=r.slice(n+1,r[n]+1);n+=r[n]+1;for(var o=1;o<s.length;o++){s[o];t=t._childs[s[o]]}var h=t.getChildByName(e[a].name);if(!h)break;this._animationSprites[a]=h;var l=this._animationSpritesInitLocalMatrix[a];l||(l=this._animationSpritesInitLocalMatrix[a]=new Te),h.transform.localMatrix.cloneTo(l)}},i._animtionStop=function(){if(this._lastFrameIndex=-1,this.player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},i._effectAnimation=function(e){for(var t=0;t<this._animationSprites.length;t++){for(var i=this._animationSprites[t],n=i.transform.localMatrix,r=0;16>r;r++)n.elements[r]=this._curAnimationDatas[16*t+r];i.transform.localMatrix=n}},i._load=function(e){this.player.on("stopped",this,this._animtionStop)},i._update=function(e){if(this.player.update(e.elapsedTime),2===this.player.state&&this._templet&&this._templet.loaded){var t=this.player.playbackRate*e.scene.timer.scale,i=this.player.isCache&&t>=1,n=i?this.currentFrameIndex:-1;if(-1===n||this._lastFrameIndex!==n){var r=this.currentAnimationClipIndex,a=this._templet.getNodes(r);if(i){var s=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache,r,n);if(s)return this._curAnimationDatas=s,this._lastFrameIndex=n,void this._effectAnimation(a)}var o=16*a.length;i?this._curAnimationDatas=new Float32Array(o):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(o)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(r))),i?this._templet.getOriginalData(r,this._curOriginalData,n,this.player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(r,this._curOriginalData,this.player.currentPlayTime),Se._computeRootAnimationData(a,this._curOriginalData,this._curAnimationDatas),i&&this._templet.setAnimationDataWithCache(this._templet._animationDatasCache,r,n,this._curAnimationDatas),this._lastFrameIndex=n,this._effectAnimation(a)}}},i._unload=function(e){laya.d3.component.Component3D.prototype._unload.call(this,e),this.player.off("stopped",this,this._animtionStop)},i.play=function(t,i,n,r,a){void 0===t&&(t=0),void 0===i&&(i=1),void 0===n&&(n=Number.MAX_VALUE),void 0===r&&(r=0),void 0===a&&(a=0),e.prototype.play.call(this,t,i,n,r,a),this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},t}(ke),function(e){function t(){this._tempFrameIndex=-1,this._tempIsCache=!1,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._extenData=null,this._lastFrameIndex=-1,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._subAnimationCacheDatas=null,this._subAnimationDatas=null,this._subAnimationCacheDatas=[],this._subAnimationDatas=[],t.__super.call(this)}r(t,"laya.d3.component.animation.SkinAnimations",e);var i=t.prototype;return i._load=function(e){var t=this;this._ownerMesh=e,this.player.on("stopped",this,function(){t._lastFrameIndex=-1,t.player.returnToZeroStopped&&(t._curBonesDatas=t._curAnimationDatas=null)})},i.preComputeKeyFrames=function(e){for(var i=Math.floor(this._templet.getAniDuration(e)/this.player.cacheFrameRateInterval),n=0;i>=n;n++){this._templet._animationDatasCache[0]||(this._templet._animationDatasCache[0]=[]),this._templet._animationDatasCache[1]||(this._templet._animationDatasCache[1]=[]);var r=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache[0],e,n);if(!r){var a=this._templet.getNodes(e),s=16*a.length;this._curAnimationDatas=new Float32Array(s),this._curBonesDatas=new Float32Array(s),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(e))),this._templet.getOriginalData(e,this._curOriginalData,n,this.player.cacheFrameRateInterval*n),this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),Se._computeSkinAnimationData(a,this._curOriginalData,this._extenData,this._curBonesDatas,this._curAnimationDatas),this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[0],e,n,this._curAnimationDatas),this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[1],e,n,this._curBonesDatas);for(var o=this._ownerMesh.meshFilter.sharedMesh,h=o.getSubMeshCount(),l=0;h>l;l++){var u=o.getSubMesh(l),c=this._subAnimationCacheDatas[l];c||(c=this._subAnimationCacheDatas[l]=new Array),t._copyBoneAndCache(n,u._boneIndex,this._curAnimationDatas,c)}}}},i._update=function(e){if(this.player.update(e.elapsedTime),2===this.player.state&&this._templet&&this._templet.loaded){var t=this.player.playbackRate*e.scene.timer.scale,i=this._tempIsCache=this.player.isCache&&t>=1,n=this._tempFrameIndex=i?this.currentFrameIndex:-1;if(-1===n||this._lastFrameIndex!==n){this._templet._animationDatasCache[0]||(this._templet._animationDatasCache[0]=[]),this._templet._animationDatasCache[1]||(this._templet._animationDatasCache[1]=[]);var r=this.currentAnimationClipIndex;if(i){var a=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache[0],r,n);if(a)return this._curAnimationDatas=a,this._curBonesDatas=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache[1],r,n),void(this._lastFrameIndex=n)}var s=this._templet.getNodes(r),o=16*s.length;i?(this._curAnimationDatas=new Float32Array(o),this._curBonesDatas=new Float32Array(o)):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(o)),this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(o)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(r))),i?this._templet.getOriginalData(r,this._curOriginalData,n,this.player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(r,this._curOriginalData,this.player.currentPlayTime),this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),Se._computeSkinAnimationData(s,this._curOriginalData,this._extenData,this._curBonesDatas,this._curAnimationDatas),i&&(this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[0],r,n,this._curAnimationDatas),this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[1],r,n,this._curBonesDatas)),this._lastFrameIndex=n}}},i._preRenderUpdate=function(e){if(this._curAnimationDatas){e.shaderDefs.addInt(512);var i=e.renderObj.renderElement.indexOfHost,n=this._ownerMesh.meshFilter.sharedMesh.getSubMesh(i);if(this._tempIsCache){var r=this._subAnimationCacheDatas[i];r||(r=this._subAnimationCacheDatas[i]=new Array),t._copyBoneAndCache(this._tempFrameIndex,n._boneIndex,this._curAnimationDatas,r),e.shaderValue.pushValue("MATRIXARRAY0",r[this._tempFrameIndex],-1)}else{var a=this._subAnimationDatas[i];a||(a=this._subAnimationDatas[i]=new Float32Array(16*n._boneIndex.length)),t._copyBone(n._boneIndex,this._curAnimationDatas,a),e.shaderValue.pushValue("MATRIXARRAY0",a,-1)}}},a(0,i,"curBonesDatas",function(){return this._curBonesDatas}),a(0,i,"curAnimationDatas",function(){return this._curAnimationDatas}),a(0,i,"url",e.prototype._$get_url,function(t){this._curOriginalData=this._extenData=null,this._subAnimationCacheDatas.length=0,this._subAnimationDatas.length=0,e.prototype._$set_url.call(this,t)}),t._copyBoneAndCache=function(e,t,i,n){var r=n[e];if(!r){r=n[e]=new Float32Array(16*t.length);for(var a=0,s=t.length,o=0;s>a;a++)for(var h=0;16>h;h++,o++)r[o]=i[(t[a]<<4)+h]}},t._copyBone=function(e,t,i){for(var n=0,r=e.length,a=0;r>n;n++)for(var s=0;16>s;s++,a++)i[a]=t[(e[n]<<4)+s]},t}(ke));(function(e){function t(){this._nodes=null,this._lasstInitIndex=-1,this._materials=null,this._mesh=null,this._meshDataInited=!1,this._uvDatasCount=0,this._subMeshIndexToNodeIndex=[],this._keyframeAges=[],this._ages=[],this._bufferUsages=[],this._originalShaderAttributes=[],this._uvShaderValues=[],this._uvNextShaderValues=[],this._uvAnimationBuffers=[],t.__super.call(this),this._meshDataInited=!1}r(t,"laya.d3.component.animation.UVAnimations",e);var i=t.prototype;return i._initMeshData=function(){this._materials=this._mesh.meshRender.shadredMaterials,this._meshDataInited=!0},i._initAnimationData=function(e){},i._load=function(e){if(!(e instanceof laya.d3.core.MeshSprite3D))throw new Error("该Sprite3D并非Mesh");this._mesh=e,e.on("loaded",this,function(e){}),this.on("loaded",this,function(){}),this.player.on("played",this,function(){}),this.player.on("stopped",this,function(){})},i._update=function(e){if(this.player.update(e.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.state){for(var t=this.currentAnimationClipIndex,i=this._templet.getNodesCurrentFrameIndex(t,this.player.currentPlayTime),n=0;n<this._nodes.length;n++){var r=i[n];this._keyframeAges[n]=(this.player.currentPlayTime-this._nodes[n].keyFrame[r].startTime)/this._nodes[n].keyFrame[r].duration,this._ages[n]=this.player.currentPlayTime/this._nodes[n].playTime;var a=this._nodes[n].keyframeWidth/this._uvDatasCount;this._uvShaderValues[n]||(this._uvShaderValues[n]=[]),this._uvNextShaderValues[n]||(this._uvNextShaderValues[n]=[]);for(var s=0;s<this._uvDatasCount;s++){var o=[2,5126,!1,0,r*a*4],h=[2,5126,!1,0,(r+1)*a*4];this._uvShaderValues[n][s]=o,this._uvNextShaderValues[n][s]=h;
}}laya.d3.component.Component3D.prototype._update.call(this,e)}},i._preRenderUpdate=function(e){},t})(ke),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.scene.Scene",e);var i=t.prototype;return i.renderSubmit=function(){var e=S.mainContext,t=this._renderState;this._set3DRenderConfig(e),this.currentCamera.clearColor&&this._clearColor(e),this._prepareScene(e,t),this.beforeUpate(t),this._updateScene(t),this.lateUpate(t),this.beforeRender(t),this._preRenderScene(e,t);var i=this.currentCamera;return t.viewMatrix=i.viewMatrix,t.projectionMatrix=i.projectionMatrix,t.projectionViewMatrix=i.projectionViewMatrix,t.viewport=i.viewport,this._renderScene(e,t),this.lateRender(t),this._set2DRenderConfig(e),1},t}(We),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.scene.VRScene",e);var i=t.prototype;return i.renderSubmit=function(){var e=S.mainContext,t=this._renderState;this._set3DRenderConfig(e),this.currentCamera.clearColor&&this._clearColor(e),this._prepareScene(e,t),t.shaderDefs.add(524288),this.beforeUpate(t),this._updateScene(t),this.lateUpate(t),this.beforeRender(t),this._preRenderScene(e,t);var i=this.currentCamera;return t.viewMatrix=i.leftViewMatrix,t.projectionMatrix=i.leftProjectionMatrix,t.projectionViewMatrix=i.leftProjectionViewMatrix,t.viewport=i.leftViewport,this._renderScene(e,t),t.viewMatrix=i.rightViewMatrix,t.projectionMatrix=i.rightProjectionMatrix,t.projectionViewMatrix=i.rightProjectionViewMatrix,t.viewport=i.rightViewport,this._renderScene(e,t),this.lateRender(t),this._set2DRenderConfig(e),1},t}(We),function(e){function t(e,i,n){void 0===e&&(e=0),void 0===i&&(i=.1),void 0===n&&(n=1e3),this._updateBoundingFrustum=!1,this._boundingFrustum=new pe(new Te),this._viewMatrix=new Te,this._projectionMatrix=new Te,this._projectionViewMatrix=new Te,this._viewport=new ye(0,0,0,0),this._normalizedViewport=new ye(0,0,1,1),this._aspectRatio=e,t.__super.call(this,i,n)}r(t,"laya.d3.core.Camera",e);var i=t.prototype;return i._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._projectionMatrixModifyID+=.01/this.id},i.viewportPointToRay=function(e,t){Pe.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},i.normalizedViewportPointToRay=function(e,i){var n=t._tempVector2,r=this.viewport,a=e.elements,s=n.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,Pe.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,i)},a(0,i,"aspectRatio",function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},function(e){if(0>e)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),a(0,i,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,i=t.width,n=t.height;this._normalizedViewport.x=e.x/i,this._normalizedViewport.y=e.y/n,this._normalizedViewport.width=e.width/i,this._normalizedViewport.height=e.height/n}return this._normalizedViewport},function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),a(0,i,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,i=t.width,n=t.height;this._viewport.x=e.x*i,this._viewport.y=e.y*n,this._viewport.width=e.width*i,this._viewport.height=e.height*n}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),a(0,i,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,i,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),a(0,i,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),a(0,i,"projectionViewMatrix",function(){return Te.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,i,"boundingFrustum",function(){return this._boundingFrustum}),n(t,["_tempVector2",function(){return this._tempVector2=new Me}]),t}(Xe),function(e){function t(){this._direction=null,t.__super.call(this),this._diffuseColor=new Ee(1,1,1),this._ambientColor=new Ee(.6,.6,.6),this._specularColor=new Ee(1,1,1),this._reflectColor=new Ee(1,1,1),this._direction=new Ee(0,-.5,-1)}r(t,"laya.d3.core.light.DirectionLight",e);var i=t.prototype;return i.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue,i=A.loopCount;e.shaderDefs.add(64),t.pushValue("LIGHTDIRDIFFUSE",this.diffuseColor.elements,i),t.pushValue("LIGHTDIRAMBIENT",this.ambientColor.elements,i),t.pushValue("LIGHTDIRSPECULAR",this.specularColor.elements,i),t.pushValue("LIGHTDIRECTION",this.direction.elements,i)}},a(0,i,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,i,"lightType",function(){return 1}),t}(qe),function(e){function t(){this._attenuation=null,this._range=NaN,t.__super.call(this),this._diffuseColor=new Ee(1,1,1),this._ambientColor=new Ee(.2,.2,.2),this._specularColor=new Ee(1,0,0),this._reflectColor=new Ee(1,1,1),this.transform.position=new Ee(0,0,0),this._range=6,this._attenuation=new Ee(.6,.6,.6)}r(t,"laya.d3.core.light.PointLight",e);var i=t.prototype;return i.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue,i=A.loopCount;e.shaderDefs.add(128),t.pushValue("POINTLIGHTDIFFUSE",this.diffuseColor.elements,i),t.pushValue("POINTLIGHTAMBIENT",this.ambientColor.elements,i),t.pushValue("POINTLIGHTSPECULAR",this.specularColor.elements,i),t.pushValue("POINTLIGHTPOS",this.transform.position.elements,i),t.pushValue("POINTLIGHTRANGE",this.range,i),t.pushValue("POINTLIGHTATTENUATION",this.attenuation.elements,i)}},a(0,i,"range",function(){return this._range},function(e){this._range=e}),a(0,i,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,i,"lightType",function(){return 2}),t}(qe),function(e){function t(){this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,t.__super.call(this),this._diffuseColor=new Ee(1,1,1),this._ambientColor=new Ee(.2,.2,.2),this._specularColor=new Ee(1,1,1),this._reflectColor=new Ee(1,1,1),this.transform.position=new Ee(0,1,1),this._direction=new Ee(0,-1,-1),this._attenuation=new Ee(.6,.6,.6),this._spot=96,this._range=6}r(t,"laya.d3.core.light.SpotLight",e);var i=t.prototype;return i.updateToWorldState=function(e){if(e.scene.enableLight){var t=e.worldShaderValue,i=A.loopCount;e.shaderDefs.add(256),t.pushValue("SPOTLIGHTDIFFUSE",this.diffuseColor.elements,i),t.pushValue("SPOTLIGHTAMBIENT",this.ambientColor.elements,i),t.pushValue("SPOTLIGHTSPECULAR",this.specularColor.elements,i),t.pushValue("SPOTLIGHTPOS",this.transform.position.elements,i),t.pushValue("SPOTLIGHTDIRECTION",this.direction.elements,i),t.pushValue("SPOTLIGHTRANGE",this.range,i),t.pushValue("SPOTLIGHTSPOT",this.spot,i),t.pushValue("SPOTLIGHTATTENUATION",this.attenuation.elements,i)}},a(0,i,"direction",function(){return this._direction},function(e){this._direction=e}),a(0,i,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),a(0,i,"spot",function(){return this._spot},function(e){this._spot=e}),a(0,i,"range",function(){return this._range},function(e){this._range=e}),a(0,i,"lightType",function(){return 3}),t}(qe),function(e){function t(e,i,n,r){this._heightMapWidth=NaN,this._heightMapHeight=NaN,this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,t.__super.call(this,e,r),this._cellSize=new Me,this._heightMapWidth=i,this._heightMapHeight=n,e.loaded?this._init():e.once("loaded",this,this._init)}r(t,"laya.d3.core.MeshTerrainSprite3D",e);var i=t.prototype;return i._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},i._getScaleX=function(){var e=this.transform.worldMatrix,t=e.elements,i=t[0],n=t[1],r=t[2];return Math.sqrt(i*i+n*n+r*r)},i._getScaleZ=function(){var e=this.transform.worldMatrix,t=e.elements,i=t[8],n=t[9],r=t[10];return Math.sqrt(i*i+n*n+r*r)},i._init=function(){this._heightMap=B.creatFromMesh(this.meshFilter.sharedMesh,this._heightMapWidth,this._heightMapHeight,this._cellSize);var e=this.meshFilter.sharedMesh._boundingBox,t=e.min;e.max;this._minX=t.x,this._minZ=t.z},i._update=function(t){this._disableRotation(),e.prototype._update.call(this,t)},i.getHeight=function(e,i){t._tempVector3.elements[0]=e,t._tempVector3.elements[1]=0,t._tempVector3.elements[2]=i,this._disableRotation();var n=this.transform.worldMatrix;n.invert(t._tempMatrix4x4),Ee.transformCoordinate(t._tempVector3,t._tempMatrix4x4,t._tempVector3),e=t._tempVector3.elements[0],i=t._tempVector3.elements[2];var r=(e-this._minX)/this._cellSize.x,a=(i-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),h=r-o,l=a-s,u=NaN,c=NaN,_=n.elements,d=_[4],f=_[5],m=_[6],p=Math.sqrt(d*d+f*f+m*m),v=_[13],g=this._heightMap.getHeight(s,o+1),x=this._heightMap.getHeight(s+1,o);if(isNaN(g)||isNaN(x))return NaN;if(1>=h+l){var T=this._heightMap.getHeight(s,o);return isNaN(T)?NaN:(u=g-T,c=x-T,(T+h*u+l*c)*p+v)}var C=this._heightMap.getHeight(s+1,o+1);return isNaN(C)?NaN:(u=x-C,c=g-C,(C+(1-h)*u+(1-l)*c)*p+v)},a(0,i,"minX",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minX*this._getScaleX()+t[12]}),a(0,i,"minZ",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minZ*this._getScaleZ()+t[14]}),a(0,i,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,i,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),n(t,["_tempVector3",function(){return this._tempVector3=new Ee},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Te}]),t}(Qe),function(e){function t(e,i,n,r,a){void 0===e&&(e=.1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=.1),void 0===a&&(a=1e3),this._tempMatrix=new Te,this._leftViewMatrix=new Te,this._leftProjectionMatrix=new Te,this._leftProjectionViewMatrix=new Te,this._leftViewport=new ye(0,0,0,0),this._leftNormalizedViewport=new ye(0,0,.5,1),this._leftAspectRatio=i,this._rightViewMatrix=new Te,this._rightProjectionMatrix=new Te,this._rightProjectionViewMatrix=new Te,this._rightViewport=new ye(0,0,0,0),this._rightNormalizedViewport=new ye(.5,0,.5,1),this._rightAspectRatio=n,this._pupilDistande=e,t.__super.call(this,r,a)}r(t,"laya.d3.core.VRCamera",e);var i=t.prototype;return i._calculatePupilOffset=function(){var e=this._tempVector3;return Ee.scale(this.right,this._pupilDistande/2,e),e.elements},i._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},i._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},i._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,i=this.orthographicVerticalSize*this.rightAspectRatio*.5,n=.5*this.orthographicVerticalSize;Te.createOrthogonal(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Te.createOrthogonal(-i,i,n,n,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Te.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Te.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._projectionMatrixModifyID+=.01/this.id},a(0,i,"aspectRatio",null,function(e){if(0>e)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),a(0,i,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||e.x+e.width>1||e.x+e.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new ye(0,0,e.width/2,e.height),this._rightNormalizedViewport=new ye(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,i,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var e=this.leftViewport;return e.width/e.height}return this._leftAspectRatio}),a(0,i,"rightProjectionViewMatrix",function(){return Te.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),a(0,i,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new ye(0,0,e.width/2,e.height),this._rightViewport=new ye(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),a(0,i,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._leftNormalizedViewport,t=this.renderTargetSize,i=t.width,n=t.height;this._leftViewport.x=e.x*i,this._leftViewport.y=e.y*n,this._leftViewport.width=e.width*i,this._leftViewport.height=e.height*n}return this._leftViewport}),a(0,i,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._rightViewport,t=this.renderTargetSize,i=t.width,n=t.height;this._rightNormalizedViewport.x=e.x/i,this._rightNormalizedViewport.y=e.y/n,this._rightNormalizedViewport.width=e.width/i,this._rightNormalizedViewport.height=e.height/n}return this._rightNormalizedViewport}),a(0,i,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var e=this.rightViewport;return e.width/e.height}return this._rightAspectRatio}),a(0,i,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._rightNormalizedViewport,t=this.renderTargetSize,i=t.width,n=t.height;this._rightViewport.x=e.x*i,this._rightViewport.y=e.y*n,this._rightViewport.width=e.width*i,this._rightViewport.height=e.height*n}return this._rightViewport}),a(0,i,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._leftViewport,t=this.renderTargetSize,i=t.width,n=t.height;this._leftNormalizedViewport.x=e.x/i,this._leftNormalizedViewport.y=e.y/n,this._leftNormalizedViewport.width=e.width/i,this._leftNormalizedViewport.height=e.height/n}return this._leftNormalizedViewport}),a(0,i,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,i,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,i,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var i=t.elements;return i[12]-=e[0],i[13]-=e[1],i[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,i,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var i=t.elements;return i[12]+=e[0],i[13]+=e[1],i[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,i,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,i,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,i,"leftProjectionViewMatrix",function(){return Te.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),t}(Xe),function(e){function t(e,i,n){this._radius=NaN,this._slices=0,this._stacks=0,void 0===e&&(e=10),void 0===i&&(i=8),void 0===n&&(n=8),t.__super.call(this),this._radius=e,this._stacks=i,this._slices=n,this.recreateResource(),this._loaded=!0;var r=this.positions;me.createfromPoints(r,this._boundingBox),ve.createfromPoints(r,this._boundingSphere)}r(t,"laya.d3.resource.models.Sphere",e);var i=t.prototype;return i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=he.vertexDeclaration,i=t.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,h=0,l=0;l<this._stacks+1;l++)for(var u=Math.sin(l*r),c=Math.cos(l*r),_=0;_<this._slices+1;_++){var d=u*Math.sin(_*a),f=u*Math.cos(_*a);n[o+0]=d*this._radius,n[o+1]=c*this._radius,n[o+2]=f*this._radius,n[o+3]=d,n[o+4]=c,n[o+5]=f,n[o+6]=_/this._slices,n[o+7]=l/this._stacks,o+=i,l!=this._stacks-1&&(e[h++]=s+(this._slices+1),e[h++]=s,e[h++]=s+1,e[h++]=s+this._slices,e[h++]=s,e[h++]=s+(this._slices+1),s++)}this._vertexBuffer=new Ye(t,this._numberVertices,35044,!0),this._indexBuffer=new Ze("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),laya.resource.Resource.prototype.recreateResource.call(this)},a(0,i,"radius",function(){return this._radius},function(e){this._radius=e,this.recreateResource()}),a(0,i,"slices",function(){return this._slices},function(e){this._slices=e,this.recreateResource()}),a(0,i,"stacks",function(){return this._stacks},function(e){this._stacks=e,this.recreateResource()}),t}(Je)}(window,document,Laya);